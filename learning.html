<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¡œê·¸ í•™ìŠµ ì‹œìŠ¤í…œ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 30px;
      background: rgba(0, 255, 255, 0.05);
      border-radius: 15px;
      border: 2px solid rgba(0, 255, 255, 0.3);
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
      position: relative;
    }

    .header h1 {
      font-size: 36px;
      color: #00ffff;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      margin-bottom: 10px;
      letter-spacing: 3px;
    }

    .header p {
      font-size: 16px;
      color: #00d9ff;
    }

    .back-button {
      position: absolute;
      left: 30px;
      top: 50%;
      transform: translateY(-50%);
      padding: 10px 20px;
      background: linear-gradient(135deg, #00d9ff, #00ffff);
      color: #0a0e27;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      text-decoration: none;
      display: inline-block;
    }

    .back-button:hover {
      transform: translateY(-50%) scale(1.05);
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
    }

    .learning-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .learning-card {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.08), rgba(0, 217, 255, 0.05));
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 15px;
      padding: 30px;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .learning-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        45deg,
        transparent,
        rgba(0, 255, 255, 0.1),
        transparent
      );
      transform: rotate(45deg);
      transition: all 0.5s;
    }

    .learning-card:hover::before {
      left: 100%;
    }

    .learning-card:hover {
      transform: translateY(-5px);
      border-color: rgba(0, 255, 255, 0.6);
      box-shadow: 0 10px 40px rgba(0, 255, 255, 0.3);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(0, 255, 255, 0.2);
    }

    .card-number {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #00d9ff, #00ffff);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: #0a0e27;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    }

    .card-title {
      flex: 1;
    }

    .card-title h3 {
      font-size: 22px;
      color: #00ffff;
      margin-bottom: 5px;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }

    .card-title p {
      font-size: 13px;
      color: #00d9ff;
      opacity: 0.8;
    }

    .card-body {
      margin-bottom: 20px;
    }

    .card-description {
      color: #b0b0b0;
      line-height: 1.6;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .card-features {
      list-style: none;
      padding: 0;
    }

    .card-features li {
      padding: 8px 0;
      padding-left: 25px;
      position: relative;
      color: #d0d0d0;
      font-size: 13px;
    }

    .card-features li::before {
      content: 'â–¸';
      position: absolute;
      left: 0;
      color: #00ffff;
      font-size: 16px;
    }

    .execute-button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #00d9ff, #00ffff);
      color: #0a0e27;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 20px rgba(0, 255, 255, 0.3);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .execute-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 255, 255, 0.5);
    }

    .execute-button:active {
      transform: translateY(0);
    }

    .execute-button:disabled {
      background: rgba(100, 100, 100, 0.5);
      cursor: not-allowed;
      box-shadow: none;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
      background: #666;
      animation: pulse 2s ease-in-out infinite;
    }

    .status-indicator.ready {
      background: #00ffff;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }

    .status-indicator.processing {
      background: #ffaa00;
      box-shadow: 0 0 10px rgba(255, 170, 0, 0.5);
    }

    .status-indicator.success {
      background: #00ff88;
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
    }

    .status-indicator.error {
      background: #ff6b6b;
      box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .result-panel {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #00ff88;
      display: none;
    }

    .result-panel.show {
      display: block;
    }

    .result-panel::-webkit-scrollbar {
      width: 8px;
    }

    .result-panel::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
    }

    .result-panel::-webkit-scrollbar-thumb {
      background: rgba(0, 255, 255, 0.3);
      border-radius: 4px;
    }

    .result-panel::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 255, 255, 0.5);
    }

    .info-panel {
      background: rgba(0, 217, 255, 0.1);
      border: 2px solid rgba(0, 217, 255, 0.3);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .info-panel h4 {
      color: #00ffff;
      margin-bottom: 15px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .info-panel ul {
      list-style: none;
      padding: 0;
    }

    .info-panel li {
      padding: 8px 0;
      padding-left: 25px;
      position: relative;
      color: #d0d0d0;
      line-height: 1.6;
    }

    .info-panel li::before {
      content: 'âœ“';
      position: absolute;
      left: 0;
      color: #00ff88;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .learning-grid {
        grid-template-columns: 1fr;
      }

      .back-button {
        position: static;
        transform: none;
        margin-bottom: 20px;
      }

      .header h1 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>â—ˆ LOG LEARNING SYSTEM â—ˆ</h1>
      <p>OpenSearch AI í•™ìŠµ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
    </div>

    <div class="info-panel">
      <h4>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        ì‚¬ìš© ê°€ì´ë“œ
      </h4>
      <ul>
        <li>ë¨¼ì € ë©”ì¸ í™”ë©´ì—ì„œ ë¡œê·¸ íŒŒì¼ì„ ì—…ë¡œë“œí•œ í›„ ì´ í˜ì´ì§€ë¡œ ì´ë™í•˜ì„¸ìš”</li>
        <li>í•™ìŠµ ìˆœì„œ: <strong>1 â†’ 6 â†’ (í•„ìš”ì‹œ 2, 3)</strong> ìˆœì„œë¡œ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤</li>
        <li>ê° ê¸°ëŠ¥ì€ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•˜ì§€ë§Œ, ì¸ë±ìŠ¤ê°€ ë¨¼ì € ìƒì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤</li>
        <li>í•™ìŠµì´ ì™„ë£Œëœ í›„ 'ì¢…í•© ë¶„ì„' í˜ì´ì§€ì—ì„œ ì›”ê°„ ì¶”ì„¸ ë¶„ì„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
      </ul>
    </div>

    <div class="learning-grid">
      <!-- btn_learn_1: ì¸ë±ìŠ¤ ìƒì„± -->
      <div class="learning-card">
        <div class="card-header">
          <div class="card-number">1</div>
          <div class="card-title">
            <h3>ì¸ë±ìŠ¤ ìƒì„±</h3>
            <p>OpenSearch Index Initialize</p>
          </div>
        </div>
        <div class="card-body">
          <p class="card-description">
            OpenSearchì— ìƒˆë¡œìš´ ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. 
            ëª¨ë“  í•™ìŠµ ì‘ì—…ì˜ ê¸°ë°˜ì´ ë˜ëŠ” ì €ì¥ì†Œë¥¼ ë§Œë“­ë‹ˆë‹¤.
          </p>
          <ul class="card-features">
            <li>ì¸ë±ìŠ¤ëª…: contest_pm_task</li>
            <li>ë²¡í„° ì„ë² ë”© í•„ë“œ ì„¤ì •</li>
            <li>ë©”íƒ€ë°ì´í„° ìŠ¤í‚¤ë§ˆ ì •ì˜</li>
          </ul>
        </div>
        <button class="execute-button" onclick="executeLearn1()">
          <span class="status-indicator ready"></span>
          ì¸ë±ìŠ¤ ìƒì„± ì‹¤í–‰
        </button>
        <div id="result1" class="result-panel"></div>
      </div>

      <!-- btn_learn_2: AI ë‹µë³€ í•™ìŠµ -->
      <div class="learning-card">
        <div class="card-header">
          <div class="card-number">2</div>
          <div class="card-title">
            <h3>AI ë‹µë³€ í•™ìŠµ</h3>
            <p>AI Response Learning</p>
          </div>
        </div>
        <div class="card-body">
          <p class="card-description">
            ì—…ë¡œë“œëœ ë¡œê·¸ íŒŒì¼ì„ AIì—ê²Œ ë¨¼ì € ë¶„ì„ì‹œí‚¨ í›„, 
            AIì˜ ë‹µë³€ì„ í¬í•¨í•˜ì—¬ í•™ìŠµí•©ë‹ˆë‹¤.
          </p>
          <ul class="card-features">
            <li>vLLM APIë¡œ ë¡œê·¸ ë¶„ì„ ìš”ì²­</li>
            <li>AI ë¶„ì„ ê²°ê³¼ë¥¼ ë©”íƒ€ë°ì´í„°ë¡œ ì €ì¥</li>
            <li>ì„ë² ë”©ê³¼ í•¨ê»˜ ì¸ë±ìŠ¤ì— ì‚½ì…</li>
          </ul>
        </div>
        <button class="execute-button" onclick="executeLearn2()">
          <span class="status-indicator ready"></span>
          AI ë‹µë³€ í•™ìŠµ ì‹¤í–‰
        </button>
        <div id="result2" class="result-panel"></div>
      </div>

      <!-- btn_learn_3: ì„ë² ë”© í•™ìŠµ -->
      <div class="learning-card">
        <div class="card-header">
          <div class="card-number">3</div>
          <div class="card-title">
            <h3>ì„ë² ë”© í•™ìŠµ</h3>
            <p>Text Embedding Learning</p>
          </div>
        </div>
        <div class="card-body">
          <p class="card-description">
            ì—…ë¡œë“œëœ ë¡œê·¸ íŒŒì¼ì„ ì²­í¬ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ì–´ 
            ì„ë² ë”© ë²¡í„°ë¥¼ ìƒì„±í•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.
          </p>
          <ul class="card-features">
            <li>ë¡œê·¸ í…ìŠ¤íŠ¸ë¥¼ ì²­í¬ë¡œ ë¶„í• </li>
            <li>/embed APIë¡œ ë²¡í„° ìƒì„±</li>
            <li>OpenSearchì— ë²¡í„° ì €ì¥</li>
          </ul>
        </div>
        <button class="execute-button" onclick="executeLearn3()">
          <span class="status-indicator ready"></span>
          ì„ë² ë”© í•™ìŠµ ì‹¤í–‰
        </button>
        <div id="result3" class="result-panel"></div>
      </div>

      <!-- btn_learn_4: í•™ìŠµ ë°ì´í„° í˜¸ì¶œ -->
      <div class="learning-card">
        <div class="card-header">
          <div class="card-number">4</div>
          <div class="card-title">
            <h3>í•™ìŠµ ë°ì´í„° í˜¸ì¶œ</h3>
            <p>Retrieve Learning Data</p>
          </div>
        </div>
        <div class="card-body">
          <p class="card-description">
            OpenSearchì— ì €ì¥ëœ í•™ìŠµ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³  
            ê²€ì¦í•©ë‹ˆë‹¤.
          </p>
          <ul class="card-features">
            <li>ì¸ë±ìŠ¤ì— ì €ì¥ëœ ë¬¸ì„œ ìˆ˜ í™•ì¸</li>
            <li>ìµœê·¼ í•™ìŠµ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</li>
            <li>ë‚ ì§œë³„ ë°ì´í„° ë¶„í¬ í™•ì¸</li>
          </ul>
        </div>
        <button class="execute-button" onclick="executeLearn4()">
          <span class="status-indicator ready"></span>
          ë°ì´í„° í˜¸ì¶œ ì‹¤í–‰
        </button>
        <div id="result4" class="result-panel"></div>
      </div>

      <!-- btn_learn_5: ì¸ë±ìŠ¤ ì‚­ì œ -->
      <div class="learning-card">
        <div class="card-header">
          <div class="card-number">5</div>
          <div class="card-title">
            <h3>ì¸ë±ìŠ¤ ì‚­ì œ</h3>
            <p>Delete Index</p>
          </div>
        </div>
        <div class="card-body">
          <p class="card-description">
            OpenSearch ì¸ë±ìŠ¤ë¥¼ ì™„ì „íˆ ì‚­ì œí•©ë‹ˆë‹¤. 
            <strong style="color: #ff6b6b;">ì£¼ì˜: ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤!</strong>
          </p>
          <ul class="card-features">
            <li>ì¸ë±ìŠ¤ ë° ëª¨ë“  ë°ì´í„° ì‚­ì œ</li>
            <li>ì¬í•™ìŠµ ì „ ì´ˆê¸°í™” ìš©ë„</li>
            <li>ë³µêµ¬ ë¶ˆê°€ëŠ¥ - ì‹ ì¤‘íˆ ì‚¬ìš©</li>
          </ul>
        </div>
        <button class="execute-button" onclick="executeLearn5()" style="background: linear-gradient(135deg, #ff6b6b, #ff4444);">
          <span class="status-indicator ready"></span>
          ì¸ë±ìŠ¤ ì‚­ì œ ì‹¤í–‰
        </button>
        <div id="result5" class="result-panel"></div>
      </div>

      <!-- btn_learn_6: ìì²´ ë¶„ì„ í›„ í•™ìŠµ -->
      <div class="learning-card">
        <div class="card-header">
          <div class="card-number">6</div>
          <div class="card-title">
            <h3>ìì²´ ë¶„ì„ í›„ í•™ìŠµ</h3>
            <p>Local Analysis & Learning</p>
          </div>
        </div>
        <div class="card-body">
          <p class="card-description">
            ë¡œê·¸ íŒŒì¼ì„ ë¡œì»¬ì—ì„œ ì§ì ‘ ë¶„ì„í•œ í›„ 
            ê²°ê³¼ë¥¼ OpenSearchì— ì €ì¥í•©ë‹ˆë‹¤. (ê¶Œì¥)
          </p>
          <ul class="card-features">
            <li>2-5ë¶„ ë‚´ ë¹ ë¥¸ ë¶„ì„ (AI í˜¸ì¶œ ì—†ìŒ)</li>
            <li>ìš”ì²­ ìˆ˜, ì—ëŸ¬, ì‹œê°„ëŒ€ ë“± í†µê³„ ìˆ˜ì§‘</li>
            <li>ì›”ê°„ ì¶”ì„¸ ë¶„ì„ìš© ë°ì´í„° ìƒì„±</li>
          </ul>
        </div>
        <button class="execute-button" onclick="executeLearn6()">
          <span class="status-indicator ready"></span>
          ìì²´ ë¶„ì„ í•™ìŠµ ì‹¤í–‰
        </button>
        <div id="result6" class="result-panel"></div>
      </div>
    </div>
  </div>

  <script>
    // ==================== ê³µí†µ ì„¤ì • ====================
    const OPENSEARCH_API_BASE = "http://10.10.22.81:8080";
    const DEFAULT_INDEX = "contest_pm_task";
    
    // ê³µí†µ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
    function showResult(taskNumber, message, isSuccess = true) {
      const resultPanel = document.getElementById(`result${taskNumber}`);
      const button = document.querySelector(`#result${taskNumber}`).previousElementSibling;
      const indicator = button.querySelector('.status-indicator');
      
      resultPanel.classList.add('show');
      resultPanel.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
      
      if (isSuccess) {
        indicator.className = 'status-indicator success';
      } else {
        indicator.className = 'status-indicator error';
      }
      
      setTimeout(() => {
        indicator.className = 'status-indicator ready';
        button.disabled = false;
      }, 2000);
    }
    
    // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateStatus(taskNumber, status) {
      const button = document.querySelector(`#result${taskNumber}`).previousElementSibling;
      const indicator = button.querySelector('.status-indicator');
      const resultPanel = document.getElementById(`result${taskNumber}`);
      
      if (status === 'processing') {
        indicator.className = 'status-indicator processing';
        button.disabled = true;
        resultPanel.classList.add('show');
        resultPanel.textContent = `[${new Date().toLocaleTimeString()}] ì‹¤í–‰ ì¤‘...\n`;
      } else if (status === 'ready') {
        indicator.className = 'status-indicator ready';
        button.disabled = false;
      }
    }
    
    // ì„ë² ë”© ìƒì„± í•¨ìˆ˜
    async function embed_query(text) {
      try {
        const response = await fetch(`${OPENSEARCH_API_BASE}/embed`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: text })
        });
        const data = await response.json();
        return data.embedding || null;
      } catch (error) {
        console.error('ì„ë² ë”© ìƒì„± ì‹¤íŒ¨:', error);
        return null;
      }
    }
    
    // LLM API í˜¸ì¶œ í•¨ìˆ˜
    async function call_llm_api(prompt, model, silentMode = false, customLimit = null) {
      const limit = customLimit !== null ? customLimit : 4096;
      const promptSizeKB = (prompt.length / 1024).toFixed(1);
      console.log('[call_llm_api] LLM í˜¸ì¶œ ì‹œì‘');
      console.log('[call_llm_api] - model:', model);
      console.log('[call_llm_api] - prompt size:', promptSizeKB, 'KB');
      console.log('[call_llm_api] - limit:', limit);
      console.log('[call_llm_api] - silentMode:', silentMode);
      
      try {
        // íƒ€ì„ì•„ì›ƒ ì„¤ì • (5ë¶„)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5 * 60 * 1000);
        
        const response = await fetch(`${OPENSEARCH_API_BASE}/vllm_chat`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            text: prompt, 
            model: model,
            limit: limit
          }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => 'Unknown error');
          console.error('[call_llm_api] HTTP ì—ëŸ¬:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
        }
        
        const data = await response.json();
        console.log('[call_llm_api] LLM ì‘ë‹µ ë°›ìŒ, ê¸¸ì´:', data.content?.length);
        return data.content;
      } catch (error) {
        if (error.name === 'AbortError') {
          console.error('[call_llm_api] íƒ€ì„ì•„ì›ƒ (5ë¶„ ì´ˆê³¼)');
          if (!silentMode) {
            alert('AI ë¶„ì„ íƒ€ì„ì•„ì›ƒ (5ë¶„ ì´ˆê³¼)');
          }
        } else {
          console.error('[call_llm_api] LLM í˜¸ì¶œ ì‹¤íŒ¨:', error);
          console.error('[call_llm_api] - ì—ëŸ¬ íƒ€ì…:', error.name);
          console.error('[call_llm_api] - ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
          console.error('[call_llm_api] - í”„ë¡¬í”„íŠ¸ í¬ê¸°:', promptSizeKB, 'KB');
          
          // silentModeê°€ falseì¼ ë•Œë§Œ alert í‘œì‹œ
          if (!silentMode) {
            alert('AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
          }
        }
        return null;
      }
    }
    
    // ì§„í–‰ë¥  íŒì—… ìƒì„±
    function createProgressPopup(fileName, fileSizeMB) {
      const popup = document.createElement('div');
      popup.id = 'progressPopup';
      popup.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;
      
      popup.innerHTML = `
        <div style="
          background: #0a0e27;
          border: 2px solid #00ffff;
          border-radius: 10px;
          padding: 40px;
          min-width: 600px;
          box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
        ">
          <h2 style="color: #00ffff; margin-top: 0; text-align: center;">
            â—† íŒŒì¼ ì²˜ë¦¬ ì¤‘ â—†
          </h2>
          <p style="color: #888; text-align: center; margin-bottom: 30px;">
            íŒŒì¼: ${fileName} (${fileSizeMB.toFixed(2)} MB)
          </p>
          
          <div style="margin: 20px 0;">
            <div style="
              background: #000;
              border: 1px solid #00ffff;
              border-radius: 10px;
              height: 30px;
              overflow: hidden;
              position: relative;
            ">
              <div id="progressBar" style="
                background: linear-gradient(90deg, #00ff00, #00ffff);
                height: 100%;
                width: 0%;
                transition: width 0.3s;
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
              "></div>
              <div id="progressText" style="
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: #fff;
                font-weight: bold;
                text-shadow: 0 0 5px #000;
              ">0%</div>
            </div>
          </div>
          
          <p id="progressStatus" style="
            color: #0f0;
            text-align: center;
            margin: 20px 0;
            min-height: 20px;
          ">ì¤€ë¹„ ì¤‘...</p>
          
          <div id="progressDetails" style="
            background: #000;
            border: 1px solid #00ffff;
            border-radius: 5px;
            padding: 15px;
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 20px 0;
          "></div>
          
          <div style="display: flex; justify-content: center; gap: 20px; margin-top: 30px;">
            <button id="pauseAnalysisBtn" style="
              padding: 12px 30px;
              background: linear-gradient(90deg, #ffcc00, #ff9900);
              color: #000;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 0 20px rgba(255, 153, 0, 0.5);
              display: none;
            ">â¸ ì¼ì‹œì •ì§€</button>
            <button id="cancelAnalysisBtn" style="
              padding: 12px 30px;
              background: linear-gradient(90deg, #ff3333, #cc0000);
              color: #fff;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 0 20px rgba(255, 51, 51, 0.5);
              display: none;
            ">âœ• ì·¨ì†Œ</button>
            <button id="closeProgressBtn" style="
              padding: 12px 30px;
              background: linear-gradient(90deg, #00ff00, #00cc00);
              color: #000;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
              display: none;
            ">âœ“ ë‹«ê¸°</button>
          </div>
        </div>
      `;
      
      return popup;
    }
    
    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    function updateProgressPopup(current, total, status) {
      const percentage = Math.floor((current / total) * 100);
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressStatus = document.getElementById('progressStatus');
      const progressDetails = document.getElementById('progressDetails');
      
      if (progressBar) progressBar.style.width = percentage + '%';
      if (progressText) progressText.textContent = percentage + '%';
      if (progressStatus) progressStatus.textContent = status;
      
      // ìƒì„¸ ë¡œê·¸ ì¶”ê°€
      if (progressDetails) {
        const now = new Date().toLocaleTimeString();
        progressDetails.innerHTML += `[${now}] ${status}<br>`;
        progressDetails.scrollTop = progressDetails.scrollHeight;
      }
      
      // ì™„ë£Œì‹œ ë‹«ê¸° ë²„íŠ¼ í‘œì‹œ
      if (percentage >= 100) {
        const closeBtn = document.getElementById('closeProgressBtn');
        if (closeBtn) {
          closeBtn.style.display = 'block';
          closeBtn.onclick = () => {
            const popup = document.getElementById('progressPopup');
            if (popup) popup.remove();
          };
        }
      }
    }

    // ==================== í•™ìŠµ ê¸°ëŠ¥ 1: ì¸ë±ìŠ¤ ìƒì„± ====================
    async function executeLearn1() {
      console.log('[btn_learn_1] ì¸ë±ìŠ¤ ìƒì„± ì‹œì‘');
      updateStatus(1, 'processing');
      
      const indexName = DEFAULT_INDEX;
      
      if (!confirm(`ì¸ë±ìŠ¤ "${indexName}"ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        console.log('[btn_learn_1] ì·¨ì†Œë¨');
        updateStatus(1, 'ready');
        return;
      }
      
      try {
        const response = await fetch(`${OPENSEARCH_API_BASE}/index_create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            index: indexName, 
            body: {} 
          })
        });
        
        const result = await response.json();
        console.log('[btn_learn_1] ê²°ê³¼:', result);
        
        showResult(1, `âœ“ ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ: ${indexName}\n${JSON.stringify(result, null, 2)}`, true);
        alert(result.message || 'ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ: ' + indexName);
        
      } catch (error) {
        console.error('[btn_learn_1] ì‹¤íŒ¨:', error);
        showResult(1, `âœ— ì¸ë±ìŠ¤ ìƒì„± ì‹¤íŒ¨: ${error.message}`, false);
        alert('ì¸ë±ìŠ¤ ìƒì„± ì‹¤íŒ¨: ' + error.message);
      }
    }

    // ==================== í•™ìŠµ ê¸°ëŠ¥ 2: AI ë‹µë³€ í•™ìŠµ ====================
    async function executeLearn2() {
      console.log('[btn_learn_2] AI ë¡œê·¸ ë¶„ì„ ë²„íŠ¼ í´ë¦­');
      
      // íŒŒì¼ ì—…ë¡œë“œ input ìƒì„±
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.txt,.log';
      
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        console.log('[btn_learn_2] íŒŒì¼ ì„ íƒë¨:', file.name, 'í¬ê¸°:', file.size, 'bytes');
        
        // ë¶„ì„ ëª¨ë“œ ì„ íƒ
        const fileSizeMB = file.size / (1024 * 1024);
        let useChunkAnalysis = false;
        
        const chunkSizeKB = 50; // 50KB (CORS ì˜¤ë¥˜ ë°©ì§€)
        const estimatedChunks = Math.ceil(fileSizeMB * 1024 / chunkSizeKB);
        
        if (fileSizeMB > 0.05) { // 50KB ì´ìƒ
          const choice = confirm(
            `íŒŒì¼ í¬ê¸°: ${fileSizeMB.toFixed(2)} MB\n\n` +
            `ì „ì²´ íŒŒì¼ ë¶„ì„ ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
            `[í™•ì¸] ì „ì²´ ë¶„ì„ (ì•½ ${estimatedChunks}ê°œ ì²­í¬, ì•½ ${Math.ceil(estimatedChunks * 0.1)}ë¶„ ì†Œìš”)\n` +
            `[ì·¨ì†Œ] ìƒ˜í”Œë§ ë¶„ì„ (ë¹ ë¦„, ì•½ 1ë¶„ ì†Œìš”)`
          );
          useChunkAnalysis = choice;
        }
        
        try {
          const analysisDate = new Date().toISOString().split('T')[0];
          
          if (useChunkAnalysis) {
            // ========== ì²­í¬ ê¸°ë°˜ ì „ì²´ ë¶„ì„ ==========
            console.log('[btn_learn_2] ì²­í¬ ê¸°ë°˜ ì „ì²´ ë¶„ì„ ì‹œì‘');
            
            // ì§„í–‰ë¥  íŒì—… ìƒì„±
            const progressPopup = createProgressPopup(file.name, fileSizeMB);
            document.body.appendChild(progressPopup);
            
            const CHUNK_SIZE = 50 * 1024; // 50KB (CORS ì˜¤ë¥˜ ë°©ì§€)
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            console.log('[btn_learn_2] ì´ ì²­í¬ ìˆ˜:', totalChunks);
            console.log('[btn_learn_2] ì²­í¬ í¬ê¸°:', (CHUNK_SIZE / 1024).toFixed(1), 'KB');
            
            // ì¼ì‹œì •ì§€/ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ
            const pauseBtn = document.getElementById('pauseAnalysisBtn');
            const cancelBtn = document.getElementById('cancelAnalysisBtn');
            if (pauseBtn) pauseBtn.style.display = 'block';
            if (cancelBtn) cancelBtn.style.display = 'block';
            
            let isPaused = false;
            let isCancelled = false;
            const chunkStats = [];
            
            // ì¼ì‹œì •ì§€ ë²„íŠ¼
            const pauseBtnElement = document.getElementById('pauseAnalysisBtn');
            if (pauseBtnElement) {
              pauseBtnElement.addEventListener('click', () => {
                isPaused = !isPaused;
                const btn = document.getElementById('pauseAnalysisBtn');
                if (btn) btn.textContent = isPaused ? 'â–¶ ì¬ê°œ' : 'â¸ ì¼ì‹œì •ì§€';
                console.log('[btn_learn_2] ë¶„ì„', isPaused ? 'ì¼ì‹œì •ì§€' : 'ì¬ê°œ');
              });
            }
            
            // ì·¨ì†Œ ë²„íŠ¼
            const cancelBtnElement = document.getElementById('cancelAnalysisBtn');
            if (cancelBtnElement) {
              cancelBtnElement.addEventListener('click', () => {
                if (confirm('ì •ë§ ë¶„ì„ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                  isCancelled = true;
                  console.log('[btn_learn_2] ë¶„ì„ ì·¨ì†Œë¨');
                }
              });
            }
            
            // ê° ì²­í¬ ë¶„ì„
            for (let i = 0; i < totalChunks; i++) {
              // ì¼ì‹œì •ì§€ ëŒ€ê¸°
              while (isPaused && !isCancelled) {
                await new Promise(resolve => setTimeout(resolve, 500));
              }
              
              // ì·¨ì†Œ í™•ì¸
              if (isCancelled) {
                progressPopup.remove();
                alert('ë¶„ì„ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
              }
              
              const start = i * CHUNK_SIZE;
              const end = Math.min(start + CHUNK_SIZE, file.size);
              const chunk = file.slice(start, end);
              
              console.log(`[btn_learn_2] ì²­í¬ ${i+1}/${totalChunks} ì½ê¸° ì‹œì‘ (${start}-${end})`);
              
              // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
              updateProgressPopup(i + 1, totalChunks, 'ì²­í¬ ì½ëŠ” ì¤‘...');
              
              const chunkText = await chunk.text();
              
              // ì§„í–‰ ìƒí™© ë¡œê·¸ ì¶”ê°€
              const detailsDiv = document.getElementById('progressDetails');
              if (detailsDiv) {
                const time = new Date().toLocaleTimeString();
                detailsDiv.innerHTML += `[${time}] ì²­í¬ ${i+1}/${totalChunks} ì½ê¸° ì™„ë£Œ (${(chunkText.length / 1024).toFixed(1)} KB)<br>`;
                detailsDiv.scrollTop = detailsDiv.scrollHeight;
              }
              
              // ì²­í¬ë³„ í†µê³„ ì¶”ì¶œ í”„ë¡¬í”„íŠ¸ (CORS ì˜¤ë¥˜ ë°©ì§€)
              // 50KB ì²­í¬ ì‚¬ìš© (CORS ì œí•œ)
              const maxLogSize = 40 * 1024; // 40KB (í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ í¬í•¨ 50KB ë¯¸ë§Œ)
              const safeChunkText = chunkText.length > maxLogSize ? chunkText.substring(0, maxLogSize) : chunkText;
              
              // í”„ë¡¬í”„íŠ¸ í¬ê¸° ì²´í¬
              const promptSize = (safeChunkText.length + 500) / 1024; // KB ë‹¨ìœ„
              console.log(`[btn_learn_2] ì²­í¬ ${i+1} í”„ë¡¬í”„íŠ¸ í¬ê¸°: ${promptSize.toFixed(1)} KB`);
              
              const chunkPrompt = `ë‹¤ìŒ ë¡œê·¸ ë°ì´í„°ì—ì„œ í†µê³„ë¥¼ ì¶”ì¶œí•˜ì„¸ìš”. ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”.

ë¡œê·¸ ë°ì´í„°:
${safeChunkText}

ì¶”ì¶œí•  í†µê³„ (JSON í˜•ì‹):
{
  "chunk_number": ${i+1},
  "total_requests": 0,
  "bizrequest_services": {},
  "hourly_usage": {},
  "users": {},
  "devices": {},
  "locations": {},
  "errors": []
}

ì„¤ëª…:
- total_requests: _BIZREQUESTê°€ í¬í•¨ëœ ë¼ì¸ ìˆ˜
- bizrequest_services: {ì„œë¹„ìŠ¤ëª…: íšŸìˆ˜} í˜•íƒœ
- hourly_usage: {ì‹œê°„ëŒ€: íšŸìˆ˜} í˜•íƒœ (00~23ì‹œ)
- users: {ì‚¬ìš©ìëª…: íšŸìˆ˜} í˜•íƒœ (PUM_USER_NAME)
- devices: {ê¸°ê¸°ëª¨ë¸: íšŸìˆ˜} í˜•íƒœ (DEV_MODEL)
- locations: {ì§€ì—­ì½”ë“œ: íšŸìˆ˜} í˜•íƒœ (PNM_LOCATION_CD)
- errors: [ì—ëŸ¬ë©”ì‹œì§€ë“¤] í˜•íƒœ (ERROR, Exception í¬í•¨)

JSONë§Œ ë‹µë³€í•˜ì„¸ìš”.`;
              
              updateProgressPopup(i + 1, totalChunks, `ì²­í¬ ${i+1} ë¶„ì„ ì¤‘... (${promptSize.toFixed(1)}KB)`);
              
              try {
                // ì§„í–‰ ë¡œê·¸
                if (detailsDiv) {
                  const time = new Date().toLocaleTimeString();
                  detailsDiv.innerHTML += `[${time}] ì²­í¬ ${i+1} AI ë¶„ì„ ìš”ì²­ ì¤‘... (${promptSize.toFixed(1)}KB)<br>`;
                  detailsDiv.scrollTop = detailsDiv.scrollHeight;
                }
                
                const chunkResponse = await call_llm_api(chunkPrompt, 'qwen', true); // silentMode = true (ì—ëŸ¬ ì•Œë¦¼ ë¬´ì‹œ)
                
                if (chunkResponse) {
                  // JSON íŒŒì‹±
                  let chunkStat;
                  try {
                    const jsonMatch = chunkResponse.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                      chunkStat = JSON.parse(jsonMatch[0]);
                    } else {
                      chunkStat = JSON.parse(chunkResponse);
                    }
                    chunkStats.push(chunkStat);
                    console.log(`[btn_learn_2] ì²­í¬ ${i+1} ë¶„ì„ ì™„ë£Œ:`, chunkStat);
                    
                    // ì„±ê³µ ë¡œê·¸
                    if (detailsDiv) {
                      const time = new Date().toLocaleTimeString();
                      detailsDiv.innerHTML += `[${time}] âœ… ì²­í¬ ${i+1} ë¶„ì„ ì™„ë£Œ (ì´ ${chunkStats.length}ê°œ ì™„ë£Œ)<br>`;
                      detailsDiv.scrollTop = detailsDiv.scrollHeight;
                    }
                  } catch (parseError) {
                    console.error(`[btn_learn_2] ì²­í¬ ${i+1} JSON íŒŒì‹± ì‹¤íŒ¨:`, parseError);
                    chunkStats.push({ chunk_number: i+1, error: 'JSON íŒŒì‹± ì‹¤íŒ¨', raw: chunkResponse.substring(0, 500) });
                    
                    // íŒŒì‹± ì‹¤íŒ¨ ë¡œê·¸
                    if (detailsDiv) {
                      const time = new Date().toLocaleTimeString();
                      detailsDiv.innerHTML += `[${time}] âš ï¸ ì²­í¬ ${i+1} JSON íŒŒì‹± ì‹¤íŒ¨, ì›ë³¸ ì €ì¥<br>`;
                      detailsDiv.scrollTop = detailsDiv.scrollHeight;
                    }
                  }
                } else {
                  // ì‘ë‹µì´ nullì¸ ê²½ìš° (500 ì—ëŸ¬, fetch ì‹¤íŒ¨ ë“±)
                  console.warn(`[btn_learn_2] ì²­í¬ ${i+1} ì‘ë‹µ ì—†ìŒ, ê±´ë„ˆëœ€`);
                  chunkStats.push({ chunk_number: i+1, error: 'API í˜¸ì¶œ ì‹¤íŒ¨ (ë¬´ì‹œë¨)', skipped: true });
                  
                  // ê±´ë„ˆë›°ê¸° ë¡œê·¸
                  if (detailsDiv) {
                    const time = new Date().toLocaleTimeString();
                    detailsDiv.innerHTML += `[${time}] â­ï¸ ì²­í¬ ${i+1} ê±´ë„ˆëœ€ (API ì˜¤ë¥˜, ê³„ì† ì§„í–‰)<br>`;
                    detailsDiv.scrollTop = detailsDiv.scrollHeight;
                  }
                }
              } catch (error) {
                // try-catchë¡œ ì¡íŒ ì˜ˆì™¸ë„ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
                console.warn(`[btn_learn_2] ì²­í¬ ${i+1} ì˜ˆì™¸ ë°œìƒ, ë¬´ì‹œí•˜ê³  ê³„ì†:`, error);
                chunkStats.push({ chunk_number: i+1, error: error.message, skipped: true });
                
                // ê±´ë„ˆë›°ê¸° ë¡œê·¸ (ê²½ê³  ìˆ˜ì¤€)
                if (detailsDiv) {
                  const time = new Date().toLocaleTimeString();
                  detailsDiv.innerHTML += `[${time}] â­ï¸ ì²­í¬ ${i+1} ê±´ë„ˆëœ€ (${error.message})<br>`;
                  detailsDiv.scrollTop = detailsDiv.scrollHeight;
                }
              }
              
              updateProgressPopup(i + 1, totalChunks, `ì²­í¬ ${i+1}/${totalChunks} ì™„ë£Œ`);
            }
            
            // ìµœì¢… ì¢…í•© ë¶„ì„
            console.log('[btn_learn_2] ëª¨ë“  ì²­í¬ ë¶„ì„ ì™„ë£Œ, ìµœì¢… ì¢…í•© ì‹œì‘');
            updateProgressPopup(totalChunks, totalChunks, 'ìµœì¢… ì¢…í•© ë¶„ì„ ì¤‘...');
            
            // ìµœì¢… ë¶„ì„ ì‹œì‘ ë¡œê·¸
            const detailsDiv = document.getElementById('progressDetails');
            if (detailsDiv) {
              const time = new Date().toLocaleTimeString();
              detailsDiv.innerHTML += `<br>[${time}] ğŸ“Š ëª¨ë“  ì²­í¬ ë¶„ì„ ì™„ë£Œ! (${chunkStats.length}/${totalChunks})<br>`;
              detailsDiv.innerHTML += `[${time}] ğŸ”„ ìµœì¢… ì¢…í•© ë¶„ì„ ì‹œì‘ (ì•½ 1~2ë¶„ ì†Œìš”)...<br>`;
              detailsDiv.scrollTop = detailsDiv.scrollHeight;
            }
            
            const finalPrompt = `ë‹¤ìŒì€ ${totalChunks}ê°œ ì²­í¬ì˜ í†µê³„ ë°ì´í„°ì…ë‹ˆë‹¤. ì´ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.

ì²­í¬ í†µê³„:
${JSON.stringify(chunkStats, null, 2).substring(0, 8000000)}

ìµœì¢… ë¶„ì„ JSON í˜•ì‹:
{
  "analysis_date": "${analysisDate}",
  "log_file": "${file.name}",
  "total_file_size_mb": ${fileSizeMB.toFixed(2)},
  "total_chunks_analyzed": ${totalChunks},
  "analysis_request": {
    "ë¡œê·¸ ë¶„ì„ ì¸ì‚¬ì´íŠ¸": {
      "ì‚¬ìš©ì í–‰ë™ íŒ¨í„´ ë¶„ì„": {
        "ì£¼ìš” ì‚¬ìš© ì„œë¹„ìŠ¤": "ëª¨ë“  ì²­í¬ì˜ bizrequest_servicesë¥¼ í•©ì‚°í•˜ì—¬ ìƒìœ„ 5ê°œ ì„œë¹„ìŠ¤ì™€ ìš”ì²­ ê±´ìˆ˜",
        "ì‹œê°„ëŒ€ë³„ ì‚¬ìš©ëŸ‰": "ëª¨ë“  ì²­í¬ì˜ hourly_usageë¥¼ í•©ì‚°í•˜ì—¬ ì‹œê°„ëŒ€ë³„ ë¶„í¬",
        "ì‚¬ìš©ìë³„ ì„œë¹„ìŠ¤ ì´ìš© í˜„í™©": "ëª¨ë“  ì²­í¬ì˜ usersë¥¼ í•©ì‚°í•˜ì—¬ ìƒìœ„ 3ëª…",
        "ê¸°ê¸° ì •ë³´": "ëª¨ë“  ì²­í¬ì˜ devicesë¥¼ í•©ì‚°í•˜ì—¬ ìƒìœ„ 3ê°œ ê¸°ê¸°"
      },
      "ì„œë¹„ìŠ¤ ì‚¬ìš© í˜„í™© ë¶„ì„": {
        "ì´ ìš”ì²­ ê±´ìˆ˜": "ëª¨ë“  ì²­í¬ì˜ total_requests í•©ê³„",
        "ìœ„ì¹˜ ê¸°ë°˜ ì„œë¹„ìŠ¤ ë¶„ì„": "ëª¨ë“  ì²­í¬ì˜ locationsë¥¼ í•©ì‚°í•˜ì—¬ ìƒìœ„ 3ê°œ ì§€ì—­",
        "ì¼ì¼ í†µê³„": "ì „ì²´ ìš”ì²­ ìˆ˜ì™€ ì£¼ìš” ì„œë¹„ìŠ¤ ìš”ì•½"
      },
      "ì‹œìŠ¤í…œ ì„±ëŠ¥ ë° ì˜¤ë¥˜ ë¶„ì„": {
        "ì˜¤ë¥˜ ë°œìƒ í˜„í™©": "ëª¨ë“  ì²­í¬ì˜ errorsë¥¼ ì¢…í•©í•˜ì—¬ ì˜¤ë¥˜ ì¢…ë¥˜ì™€ ë¹ˆë„"
      }
    }
  }
}

ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”.`;
            
            // ë” ê¸´ ì‘ë‹µì„ ë°›ê¸° ìœ„í•´ limit ì¦ê°€ (4096 -> 16384)
            const finalResponse = await call_llm_api(finalPrompt, 'qwen', false, 16384);
            
            if (!finalResponse) {
              progressPopup.remove();
              throw new Error('ìµœì¢… ì¢…í•© ë¶„ì„ ì‹¤íŒ¨');
            }
            
            console.log('[btn_learn_2] ìµœì¢… LLM ì‘ë‹µ:', finalResponse);
            
            // ìµœì¢… ë¶„ì„ ì™„ë£Œ ë¡œê·¸
            if (detailsDiv) {
              const time = new Date().toLocaleTimeString();
              detailsDiv.innerHTML += `[${time}] âœ… ìµœì¢… ì¢…í•© ë¶„ì„ ì™„ë£Œ!<br>`;
              detailsDiv.innerHTML += `[${time}] ğŸ“ ê²°ê³¼ íŒŒì‹± ì¤‘...<br>`;
              detailsDiv.scrollTop = detailsDiv.scrollHeight;
            }
            
            // ì ì‹œ ëŒ€ê¸° í›„ íŒì—… ë‹«ê¸°
            await new Promise(resolve => setTimeout(resolve, 1000));
            progressPopup.remove();
            
            // JSON íŒŒì‹±
            let jsonResult;
            try {
              const jsonMatch = finalResponse.match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                jsonResult = JSON.parse(jsonMatch[0]);
              } else {
                jsonResult = JSON.parse(finalResponse);
              }
            } catch (parseError) {
              console.error('[btn_learn_2] ìµœì¢… JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
              jsonResult = {
                analysis_date: analysisDate,
                log_file: file.name,
                raw_response: finalResponse,
                chunk_stats: chunkStats
              };
            }
            
            // ê²°ê³¼ íŒì—… í‘œì‹œ
            createJsonResultPopup(jsonResult, file.name);
            
          } else {
            // ========== ê¸°ì¡´ ìƒ˜í”Œë§ ë¶„ì„ ==========
            console.log('[btn_learn_2] ìƒ˜í”Œë§ ë¶„ì„ ì‹œì‘');
            
            const SAMPLE_SIZE = 100 * 1024; // 100KB
            let logSample = '';
            
            if (file.size > SAMPLE_SIZE) {
              const blob = file.slice(0, SAMPLE_SIZE);
              logSample = await blob.text();
              console.log('[btn_learn_2] ìƒ˜í”Œ í¬ê¸°:', logSample.length, 'bytes');
            } else {
              logSample = await file.text();
              console.log('[btn_learn_2] ì „ì²´ íŒŒì¼ ì½ê¸° ì™„ë£Œ:', logSample.length, 'bytes');
            }
            
            const logForAnalysis = logSample.substring(0, 50000);
            
            const prompt = `ë¡œê·¸ ë°ì´í„°ë¥¼ ìì„¸íˆ ë¶„ì„í•œ í›„ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.

ë¡œê·¸ ë°ì´í„° (ìƒ˜í”Œ):
${logForAnalysis}

ìš”ì²­í•˜ëŠ” JSON í˜•ì‹:
{
  "analysis_date": "${analysisDate}",
  "log_file": "${file.name}",
  "analysis_request": {
    "ë¡œê·¸ ë¶„ì„ ì¸ì‚¬ì´íŠ¸": {
      "ì‚¬ìš©ì í–‰ë™ íŒ¨í„´ ë¶„ì„": {
        "ì£¼ìš” ì‚¬ìš© ì„œë¹„ìŠ¤": "ë¡œê·¸ì—ì„œ '_BIZREQUEST' í•„ë“œë¥¼ ë¶„ì„í•˜ì—¬ ê°€ì¥ ë§ì´ ì‚¬ìš©ëœ ì„œë¹„ìŠ¤ ìƒìœ„ 5ê°œë¥¼ ì‹ë³„í•˜ê³ , ê° ì„œë¹„ìŠ¤ì˜ ìš”ì²­ ê±´ìˆ˜ë¥¼ í¬í•¨í•˜ì—¬ ê²°ê³¼ë¥¼ ì œì‹œí•´ì¤˜.",
        "ì‹œê°„ëŒ€ë³„ ì‚¬ìš©ëŸ‰": "ë¡œê·¸ ìƒì„± ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ ì‹œê°„ëŒ€ë³„(00ì‹œ, 01ì‹œ, ..., 23ì‹œ) ì„œë¹„ìŠ¤ ìš”ì²­ ê±´ìˆ˜ë¥¼ ë¶„ì„í•˜ê³ , ì‚¬ìš©ëŸ‰ì´ ê°€ì¥ ë§ì€ ì‹œê°„ëŒ€ì™€ ê°€ì¥ ì ì€ ì‹œê°„ëŒ€ë¥¼ ì•Œë ¤ì¤˜.",
        "ì‚¬ìš©ìë³„ ì„œë¹„ìŠ¤ ì´ìš© í˜„í™©": "'PUM_USER_NAME' í•„ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê°€ì¥ ìš”ì²­ì´ ë§ì•˜ë˜ ì‚¬ìš©ì ìƒìœ„ 3ëª…ì„ ì‹ë³„í•˜ê³ , ê° ì‚¬ìš©ìì˜ ì´ ìš”ì²­ ê±´ìˆ˜ë¥¼ ì•Œë ¤ì¤˜.",
        "ê¸°ê¸° ì •ë³´": "'DEV_MODEL'ê³¼ 'DEV_TELECOM' í•„ë“œë¥¼ ë¶„ì„í•˜ì—¬ ê°€ì¥ ë§ì´ ì‚¬ìš©ëœ ê¸°ê¸° ëª¨ë¸ ìƒìœ„ 3ê°œì™€ í†µì‹ ì‚¬ë³„ ì ìœ ìœ¨ì„ ë¶„ì„í•´ì¤˜."
      },
      "ì„œë¹„ìŠ¤ ì‚¬ìš© í˜„í™© ë¶„ì„": {
        "ìš”ì²­ ê±´ìˆ˜ ë° ì¢…ë¥˜": "ë¡œê·¸ íŒŒì¼ ì „ì²´ì˜ ì´ ìš”ì²­ ê±´ìˆ˜ë¥¼ ê³„ì‚°í•˜ê³ , ì„œë¹„ìŠ¤ ì¢…ë¥˜ë³„ ìš”ì²­ ê±´ìˆ˜ì™€ ë¹„ìœ¨ì„ ë¶„ì„í•´ì¤˜.",
        "ìœ„ì¹˜ ê¸°ë°˜ ì„œë¹„ìŠ¤ ë¶„ì„": "'PNM_LOCATION_CD' í•„ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§€ì—­ ì½”ë“œë³„ ìš”ì²­ ê±´ìˆ˜ë¥¼ ë¶„ì„í•˜ê³ , ê°€ì¥ ìš”ì²­ì´ ë§ì•˜ë˜ ìƒìœ„ 3ê°œ ì§€ì—­ì„ ì•Œë ¤ì¤˜.",
        "ì›”ë³„/ì¼ë³„ í†µê³„": "ì´ ë¡œê·¸ëŠ” '${analysisDate}'ì— í•´ë‹¹í•˜ëŠ” ì¼ì¼ í†µê³„ì„ì„ ëª…ì‹œí•˜ê³ , ì£¼ìš” í†µê³„(ì´ ìš”ì²­ ìˆ˜, ìƒìœ„ ì„œë¹„ìŠ¤)ë¥¼ ìš”ì•½í•´ì¤˜."
      },
      "ì‹œìŠ¤í…œ ì„±ëŠ¥ ë° ì˜¤ë¥˜ ë¶„ì„": {
        "ì‘ë‹µ ì‹œê°„": "ë¡œê·¸ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ë¶„ì„í•˜ì—¬ í‰ê·  ì‘ë‹µ ì‹œê°„ì„ ì¶”ì •í•˜ê³ , ì‘ë‹µ ì‹œê°„ì´ ìœ ë… ê¸¸ì—ˆë˜(ì˜ˆ: 5ì´ˆ ì´ìƒ) ìš”ì²­ì´ ìˆì—ˆëŠ”ì§€ ì‹ë³„í•´ì¤˜.",
        "ì˜¤ë¥˜ ë°œìƒ í˜„í™©": "ë¡œê·¸ ë‚´ìš©ì—ì„œ 'ERROR' ë˜ëŠ” 'Exception' í‚¤ì›Œë“œë¥¼ í¬í•¨í•œ ë¡œê·¸ë¥¼ ì°¾ì•„ë‚´ê³ , ë°œìƒí•œ ì˜¤ë¥˜ì˜ ì¢…ë¥˜ì™€ ë¹ˆë„ë¥¼ ìš”ì•½í•´ì¤˜."
      }
    }
  }
}

ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”.`;

          console.log('[btn_learn_2] LLM API í˜¸ì¶œ ì‹œì‘...');
          alert('AIê°€ ë¡œê·¸ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...\nì‹œê°„ì´ ë‹¤ì†Œ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          
          // LLM API í˜¸ì¶œ
          const llmResponse = await call_llm_api(prompt, 'qwen');
          
          if (!llmResponse) {
            throw new Error('LLM ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
          }
          
          console.log('[btn_learn_2] LLM ì‘ë‹µ:', llmResponse);
          
          // JSON íŒŒì‹± ì‹œë„
          let jsonResult;
          try {
            // JSON ë¶€ë¶„ë§Œ ì¶”ì¶œ (``` ì œê±°)
            let jsonText = llmResponse;
            const jsonMatch = llmResponse.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
              jsonText = jsonMatch[0];
            }
            jsonResult = JSON.parse(jsonText);
          } catch (parseError) {
            console.error('[btn_learn_2] JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
            // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ì‘ë‹µì„ JSONìœ¼ë¡œ ê°ì‹¸ê¸°
            jsonResult = {
              analysis_date: analysisDate,
              log_file: file.name,
              raw_response: llmResponse
            };
          }
          
          // JSON ê²°ê³¼ íŒì—… í‘œì‹œ
          createJsonResultPopup(jsonResult, file.name);
          }
          
        } catch (error) {
          console.error('[btn_learn_2] AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
          alert('AI ë¶„ì„ ì‹¤íŒ¨: ' + error.message);
        }
      });
      
      fileInput.click();
    }

    // ==================== í•™ìŠµ ê¸°ëŠ¥ 3: ì„ë² ë”© í•™ìŠµ ====================
    async function executeLearn3() {
      console.log('[btn_learn_3] ë°ì´í„° ì‚½ì… ë²„íŠ¼ í´ë¦­');
      
      // íŒŒì¼ ì—…ë¡œë“œ input ìƒì„±
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.txt,.log';
      
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const indexName = prompt('ë°ì´í„°ë¥¼ ì‚½ì…í•  ì¸ë±ìŠ¤ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', 'contest_pm_task');
        if (!indexName) {
          console.log('[btn_learn_3] ë°ì´í„° ì‚½ì… ì·¨ì†Œë¨');
          return;
        }
        
        console.log('[btn_learn_3] ë¡œê·¸ íŒŒì¼ ì½ê¸° ì‹œì‘:', file.name);
        
        try {
          // ë¡œê·¸ íŒŒì¼ ì½ê¸°
          const logText = await file.text();
          console.log('[btn_learn_3] ë¡œê·¸ íŒŒì¼ í¬ê¸°:', logText.length, 'bytes');
          
          // ì²­í¬ í¬ê¸° ì„¤ì • (1000ì ë‹¨ìœ„ë¡œ ë¶„í• )
          const CHUNK_SIZE = 1000;
          const chunks = [];
          
          for (let i = 0; i < logText.length; i += CHUNK_SIZE) {
            chunks.push(logText.substring(i, i + CHUNK_SIZE));
          }
          
          console.log('[btn_learn_3] ì´ ì²­í¬ ìˆ˜:', chunks.length);
          
          if (!confirm(`ì´ ${chunks.length}ê°œì˜ ì²­í¬ë¡œ ë¶„í• ë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            console.log('[btn_learn_3] ì‚¬ìš©ì ì·¨ì†Œ');
            return;
          }
          
          // ê° ì²­í¬ë¥¼ ì¸ë±ìŠ¤ì— ì‚½ì…
          let successCount = 0;
          let failCount = 0;
          
          for (let i = 0; i < chunks.length; i++) {
            const chunk = chunks[i];
            console.log(`[btn_learn_3] ì²­í¬ ${i+1}/${chunks.length} ì²˜ë¦¬ ì¤‘...`);
            
            // ì„ë² ë”© ìƒì„±
            const embedding = await embed_query(chunk);
            
            if (!embedding) {
              console.error(`[btn_learn_3] ì²­í¬ ${i+1} ì„ë² ë”© ì‹¤íŒ¨`);
              failCount++;
              continue;
            }
            
            // ë°ì´í„° ì‚½ì…
            const response = await fetch(`${OPENSEARCH_API_BASE}/index`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                index: indexName,
                document: {
                  text: chunk,
                  embedding: embedding
                }
              })
            });
            
            const result = await response.json();
            console.log(`[btn_learn_3] ì²­í¬ ${i+1} ì‚½ì… ê²°ê³¼:`, result);
            
            if (result.result === 'created') {
              successCount++;
            } else {
              failCount++;
            }
            
            // ì§„í–‰ë¥  í‘œì‹œ (10ê°œë§ˆë‹¤)
            if ((i + 1) % 10 === 0) {
              console.log(`[btn_learn_3] ì§„í–‰ë¥ : ${i+1}/${chunks.length}`);
            }
          }
          
          console.log('[btn_learn_3] ë°ì´í„° ì‚½ì… ì™„ë£Œ');
          console.log('[btn_learn_3] ì„±ê³µ:', successCount, 'ì‹¤íŒ¨:', failCount);
          alert(`ë°ì´í„° ì‚½ì… ì™„ë£Œ!\nì„±ê³µ: ${successCount}ê°œ\nì‹¤íŒ¨: ${failCount}ê°œ`);
          
        } catch (error) {
          console.error('[btn_learn_3] ë°ì´í„° ì‚½ì… ì¤‘ ì˜¤ë¥˜:', error);
          alert('ë°ì´í„° ì‚½ì… ì‹¤íŒ¨: ' + error.message);
        }
      });
      
      fileInput.click();
    }

    // ==================== í•™ìŠµ ê¸°ëŠ¥ 4: í•™ìŠµ ë°ì´í„° í˜¸ì¶œ ====================
    async function executeLearn4() {
      console.log('[btn_learn_4] í•™ìŠµ ë°ì´í„° í˜¸ì¶œ ì‹œì‘');
      updateStatus(4, 'processing');
      
      const query = prompt('ê²€ìƒ‰í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:', '');
      if (!query) {
        updateStatus(4, 'ready');
        return;
      }
      
      try {
        showResult(4, `í‚¤ì›Œë“œ ê²€ìƒ‰: "${query}"`, true);
        
        // í‚¤ì›Œë“œ ê²€ìƒ‰
        const response = await fetch(`${OPENSEARCH_API_BASE}/keyword_search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            text: query,
            index: DEFAULT_INDEX,
            k: 5
          })
        });
        
        const result = await response.json();
        console.log('[btn_learn_4] ê²°ê³¼:', result);
        
        if (result.result && result.result.length > 0) {
          showResult(4, `âœ“ ${result.result.length}ê°œ ë¬¸ì„œ ë°œê²¬`, true);
          showResult(4, JSON.stringify(result.result, null, 2), true);
        } else {
          showResult(4, `ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`, true);
        }
        
      } catch (error) {
        console.error('[btn_learn_4] ì‹¤íŒ¨:', error);
        showResult(4, `âœ— ì‹¤íŒ¨: ${error.message}`, false);
      }
    }

    // ==================== í•™ìŠµ ê¸°ëŠ¥ 5: ì¸ë±ìŠ¤ ì‚­ì œ ====================
    async function executeLearn5() {
      console.log('[btn_learn_5] ì¸ë±ìŠ¤ ì‚­ì œ ì‹œì‘');
      
      const indexName = prompt('ì‚­ì œí•  ì¸ë±ìŠ¤ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', DEFAULT_INDEX);
      if (!indexName) {
        return;
      }
      
      if (!confirm(`âš ï¸ ì •ë§ë¡œ ì¸ë±ìŠ¤ "${indexName}"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  í•™ìŠµ ë°ì´í„°ê°€ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
        return;
      }
      
      updateStatus(5, 'processing');
      
      try {
        const response = await fetch(`${OPENSEARCH_API_BASE}/index_delete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ index: indexName })
        });
        
        const result = await response.json();
        console.log('[btn_learn_5] ê²°ê³¼:', result);
        
        showResult(5, `âœ“ ì¸ë±ìŠ¤ ì‚­ì œ ì™„ë£Œ: ${indexName}`, true);
        showResult(5, JSON.stringify(result, null, 2), true);
        alert(`ì¸ë±ìŠ¤ "${indexName}" ì‚­ì œ ì™„ë£Œ!`);
        
      } catch (error) {
        console.error('[btn_learn_5] ì‹¤íŒ¨:', error);
        showResult(5, `âœ— ì‹¤íŒ¨: ${error.message}`, false);
        alert('ì¸ë±ìŠ¤ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
      }
    }

    // ==================== í•™ìŠµ ê¸°ëŠ¥ 6: ìì²´ ë¶„ì„ í›„ í•™ìŠµ ====================
    async function executeLearn6() {
      console.log('[btn_learn_6] ë¡œì»¬ ì „ì²˜ë¦¬ ë¶„ì„ ë²„íŠ¼ í´ë¦­');
      
      // íŒŒì¼ ì—…ë¡œë“œ input ìƒì„±
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.txt,.log';
      
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const fileSizeMB = file.size / (1024 * 1024);
        console.log('[btn_learn_6] íŒŒì¼ ì„ íƒë¨:', file.name, 'í¬ê¸°:', fileSizeMB.toFixed(2), 'MB');
        
        if (!confirm(`íŒŒì¼: ${file.name}\ní¬ê¸°: ${fileSizeMB.toFixed(2)} MB\n\në¡œì»¬ ì „ì²˜ë¦¬ ë¶„ì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(JavaScriptë¡œ ì§ì ‘ í†µê³„ ê³„ì‚° í›„ AI ìš”ì•½)`)) {
          return;
        }
        
        try {
          // ì§„í–‰ë¥  íŒì—… ìƒì„±
          const progressPopup = createProgressPopup(file.name, fileSizeMB);
          document.body.appendChild(progressPopup);
          
          updateProgressPopup(0, 100, 'íŒŒì¼ ì½ê¸° ì‹œì‘...');
          
          // === 1ë‹¨ê³„: ë¡œì»¬ í†µê³„ ê³„ì‚° ===
          console.log('[btn_learn_6] 1ë‹¨ê³„: ë¡œì»¬ í†µê³„ ê³„ì‚° ì‹œì‘');
          
          const CHUNK_SIZE = 10 * 1024 * 1024; // 10MB ì²­í¬ë¡œ ì½ê¸° (ë©”ëª¨ë¦¬ íš¨ìœ¨)
          const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
          
          // íŒŒì¼ëª…ì—ì„œ ë‚ ì§œ ì¶”ì¶œ (ì˜ˆ: SystemOut_20251030.log -> 2025ë…„ 10ì›” 30ì¼)
          let logDate = null;
          let logDateFormatted = null;
          const dateMatch = file.name.match(/(\d{8})/); // YYYYMMDD í˜•ì‹ ì°¾ê¸°
          if (dateMatch) {
            const dateStr = dateMatch[1];
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            logDate = `${year}-${month}-${day}`;
            logDateFormatted = `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼`;
            console.log('[btn_learn_6] íŒŒì¼ëª…ì—ì„œ ì¶”ì¶œí•œ ë‚ ì§œ:', logDate, logDateFormatted);
          }
          
          // í†µê³„ ë°ì´í„° ì´ˆê¸°í™”
          const stats = {
            fileName: file.name,
            logDate: logDate, // YYYY-MM-DD í˜•ì‹
            logDateFormatted: logDateFormatted, // í•œêµ­ì–´ í˜•ì‹
            fileSizeMB: fileSizeMB.toFixed(2),
            totalLines: 0,
            totalRequests: 0,
            totalErrors: 0, // ì „ì²´ ì—ëŸ¬ ì¹´ìš´íŠ¸
            bizrequestServices: {},
            hourlyUsage: {},
            users: {},
            devices: {},
            locations: {},
            errors: [], // ìƒ˜í”Œ ì—ëŸ¬ (ìµœëŒ€ 100ê°œ)
            dateRange: { start: null, end: null }
          };
          
          let buffer = ''; // ì²­í¬ ê²½ê³„ ì²˜ë¦¬ìš© ë²„í¼
          
          // ê° ì²­í¬ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì½ìœ¼ë©´ì„œ í†µê³„ ê³„ì‚°
          for (let i = 0; i < totalChunks; i++) {
            const start = i * CHUNK_SIZE;
            const end = Math.min(start + CHUNK_SIZE, file.size);
            const chunk = file.slice(start, end);
            
            updateProgressPopup(
              Math.floor((i / totalChunks) * 50), 
              100, 
              `í†µê³„ ê³„ì‚° ì¤‘... (${i+1}/${totalChunks} ì²­í¬)`
            );
            
            const chunkText = await chunk.text();
            const fullText = buffer + chunkText;
            
            // ë§ˆì§€ë§‰ ì¤„ì´ ë¶ˆì™„ì „í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë²„í¼ì— ì €ì¥
            const lastNewlineIndex = fullText.lastIndexOf('\n');
            const processText = lastNewlineIndex !== -1 ? fullText.substring(0, lastNewlineIndex) : fullText;
            buffer = lastNewlineIndex !== -1 ? fullText.substring(lastNewlineIndex + 1) : '';
            
            // ì¤„ ë‹¨ìœ„ë¡œ í†µê³„ ê³„ì‚°
            const lines = processText.split('\n');
            stats.totalLines += lines.length;
            
            for (const line of lines) {
              if (!line.trim()) continue;
              
              // BIZREQUEST ì¹´ìš´íŠ¸
              if (line.includes('_BIZREQUEST')) {
                stats.totalRequests++;
                
                // ì„œë¹„ìŠ¤ëª… ì¶”ì¶œ (ì˜ˆ: pm.service.XXX)
                const serviceMatch = line.match(/pm\.service\.(\w+)/);
                if (serviceMatch) {
                  const serviceName = serviceMatch[1];
                  stats.bizrequestServices[serviceName] = (stats.bizrequestServices[serviceName] || 0) + 1;
                }
              }
              
              // ì‹œê°„ëŒ€ ì¶”ì¶œ (ì˜ˆ: 2024-01-15 14:23:45)
              const timeMatch = line.match(/(\d{4}-\d{2}-\d{2})\s+(\d{2}):/);
              if (timeMatch) {
                const date = timeMatch[1];
                const hour = timeMatch[2];
                
                // ë‚ ì§œ ë²”ìœ„ ì—…ë°ì´íŠ¸
                if (!stats.dateRange.start || date < stats.dateRange.start) {
                  stats.dateRange.start = date;
                }
                if (!stats.dateRange.end || date > stats.dateRange.end) {
                  stats.dateRange.end = date;
                }
                
                // ì‹œê°„ëŒ€ë³„ ì‚¬ìš©ëŸ‰
                stats.hourlyUsage[hour] = (stats.hourlyUsage[hour] || 0) + 1;
              }
              
              // ì‚¬ìš©ìëª… ì¶”ì¶œ (PUM_USER_NAME)
              const userMatch = line.match(/PUM_USER_NAME[=:]\s*([^\s,\]]+)/);
              if (userMatch) {
                const userName = userMatch[1];
                stats.users[userName] = (stats.users[userName] || 0) + 1;
              }
              
              // ê¸°ê¸° ëª¨ë¸ ì¶”ì¶œ (DEV_MODEL)
              const deviceMatch = line.match(/DEV_MODEL[=:]\s*([^\s,\]]+)/);
              if (deviceMatch) {
                const deviceModel = deviceMatch[1];
                stats.devices[deviceModel] = (stats.devices[deviceModel] || 0) + 1;
              }
              
              // ì§€ì—­ ì½”ë“œ ì¶”ì¶œ (PNM_LOCATION_CD)
              const locationMatch = line.match(/PNM_LOCATION_CD[=:]\s*([^\s,\]]+)/);
              if (locationMatch) {
                const locationCode = locationMatch[1];
                stats.locations[locationCode] = (stats.locations[locationCode] || 0) + 1;
              }
              
              // ì—ëŸ¬ ì¶”ì¶œ (ERROR, Exception í¬í•¨)
              if (line.match(/ERROR|Exception|exception|FAIL|fail/i)) {
                stats.totalErrors++; // ì „ì²´ ì—ëŸ¬ ì¹´ìš´íŠ¸
                
                // ì—ëŸ¬ ìƒ˜í”Œ ì €ì¥ (ìµœëŒ€ 100ê°œ)
                if (stats.errors.length < 100) {
                  const errorMsg = line.trim().substring(0, 200);
                  stats.errors.push(errorMsg);
                }
              }
            }
            
            // ì§„í–‰ ë¡œê·¸
            const detailsDiv = document.getElementById('progressDetails');
            if (detailsDiv) {
              const time = new Date().toLocaleTimeString();
              detailsDiv.innerHTML += `[${time}] ì²­í¬ ${i+1}/${totalChunks} ì²˜ë¦¬ ì™„ë£Œ (ëˆ„ì  ë¼ì¸: ${stats.totalLines.toLocaleString()})<br>`;
              detailsDiv.scrollTop = detailsDiv.scrollHeight;
            }
          }
          
          // ë§ˆì§€ë§‰ ë²„í¼ ì²˜ë¦¬
          if (buffer.trim()) {
            stats.totalLines++;
          }
          
          console.log('[btn_learn_6] ë¡œì»¬ í†µê³„ ê³„ì‚° ì™„ë£Œ:', stats);
          updateProgressPopup(50, 100, 'ë¡œì»¬ í†µê³„ ê³„ì‚° ì™„ë£Œ! AI ìš”ì•½ ìš”ì²­ ì¤‘...');
          
          // ì§„í–‰ ë¡œê·¸
          const detailsDiv = document.getElementById('progressDetails');
          if (detailsDiv) {
            const time = new Date().toLocaleTimeString();
            detailsDiv.innerHTML += `<br>[${time}] âœ… ë¡œì»¬ í†µê³„ ê³„ì‚° ì™„ë£Œ!<br>`;
            detailsDiv.innerHTML += `[${time}] ğŸ“Š ì´ ${stats.totalLines.toLocaleString()} ë¼ì¸ ë¶„ì„<br>`;
            detailsDiv.innerHTML += `[${time}] ğŸ”„ AI ìš”ì•½ ìƒì„± ì‹œì‘...<br>`;
            detailsDiv.scrollTop = detailsDiv.scrollHeight;
          }
          
          // === 2ë‹¨ê³„: AI ìš”ì•½ ìƒì„± ===
          console.log('[btn_learn_6] 2ë‹¨ê³„: AI ìš”ì•½ ìƒì„± ì‹œì‘');
          
          // ìƒìœ„ Nê°œë§Œ ì¶”ì¶œ
          const topN = (obj, n) => {
            return Object.entries(obj)
              .sort((a, b) => b[1] - a[1])
              .slice(0, n)
              .reduce((acc, [key, val]) => ({ ...acc, [key]: val }), {});
          };
          
          // ìš”ì•½ìš© í†µê³„ ë°ì´í„°
          const summaryStats = {
            fileName: stats.fileName,
            logDate: stats.logDate,
            logDateFormatted: stats.logDateFormatted,
            fileSizeMB: stats.fileSizeMB,
            totalLines: stats.totalLines,
            totalRequests: stats.totalRequests,
            totalErrors: stats.totalErrors, // ì „ì²´ ì—ëŸ¬ ìˆ˜
            dateRange: stats.dateRange,
            topServices: topN(stats.bizrequestServices, 10),
            hourlyUsage: stats.hourlyUsage,
            topUsers: topN(stats.users, 10),
            topDevices: topN(stats.devices, 10),
            topLocations: topN(stats.locations, 10),
            errorSamples: stats.errors.slice(0, 20) // ëŒ€í‘œ ì—ëŸ¬ 20ê°œ
          };
          
          // AI ìš”ì•½ í”„ë¡¬í”„íŠ¸
          const summaryPrompt = `ë‹¹ì‹ ì€ í•œêµ­ì–´ ë¡œê·¸ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒì€ "${stats.logDateFormatted || 'ë‚ ì§œ ë¯¸ìƒ'}" ë¡œê·¸ íŒŒì¼ì˜ í†µê³„ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤. 
ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸ì‚¬ì´íŠ¸ ìˆëŠ” ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ **ë°˜ë“œì‹œ í•œêµ­ì–´**ë¡œ JSON í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.

**ì¤‘ìš”: ëª¨ë“  ì„¤ëª…ê³¼ ë¶„ì„ ë‚´ìš©ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.**

í†µê³„ ë°ì´í„°:
${JSON.stringify(summaryStats, null, 2)}

ì•„ë˜ í˜•ì‹ìœ¼ë¡œ JSON ì‘ë‹µì„ ì‘ì„±í•˜ì„¸ìš”:
{
  "log_date": "${stats.logDate || 'ë‚ ì§œ ë¯¸ìƒ'}",
  "log_date_formatted": "${stats.logDateFormatted || 'ë‚ ì§œ ë¯¸ìƒ'}",
  "file_name": "${stats.fileName}",
  "analysis_summary": {
    "overview": "ì´ ë¡œê·¸ëŠ” ${stats.logDateFormatted || 'ë‚ ì§œ ë¯¸ìƒ'}ì˜ ë°ì´í„°ì…ë‹ˆë‹¤. ì´ ë¼ì¸ ìˆ˜, ì´ ìš”ì²­ ìˆ˜ ë“±ì„ í¬í•¨í•œ ì „ì²´ ìš”ì•½ì„ í•œêµ­ì–´ë¡œ ì‘ì„±",
    "key_insights": [
      "ì£¼ìš” ì¸ì‚¬ì´íŠ¸ 1 (í•œêµ­ì–´)",
      "ì£¼ìš” ì¸ì‚¬ì´íŠ¸ 2 (í•œêµ­ì–´)",
      "ì£¼ìš” ì¸ì‚¬ì´íŠ¸ 3 (í•œêµ­ì–´)"
    ]
  },
  "service_analysis": {
    "most_used_services": "ê°€ì¥ ë§ì´ ì‚¬ìš©ëœ ì„œë¹„ìŠ¤ ìƒìœ„ 5ê°œì™€ ì‚¬ìš©ëŸ‰ì„ í•œêµ­ì–´ë¡œ ì„¤ëª…",
    "service_distribution": "ì„œë¹„ìŠ¤ ì‚¬ìš© ë¶„í¬ì— ëŒ€í•œ í•œêµ­ì–´ ì„¤ëª…"
  },
  "temporal_analysis": {
    "peak_hours": "ìµœê³  ì‚¬ìš© ì‹œê°„ëŒ€ (ì˜ˆ: 08ì‹œ, 09ì‹œ, 10ì‹œ)ë¥¼ í•œêµ­ì–´ë¡œ ì„¤ëª…",
    "usage_pattern": "ì‹œê°„ëŒ€ë³„ ì‚¬ìš© íŒ¨í„´ì„ í•œêµ­ì–´ë¡œ ìƒì„¸ ì„¤ëª…",
    "date_range": "${stats.logDateFormatted || 'ë‚ ì§œ ë¯¸ìƒ'}ì˜ ë¡œê·¸ ë°ì´í„°"
  },
  "user_analysis": {
    "active_users": "ê°€ì¥ í™œë°œí•œ ì‚¬ìš©ì ìƒìœ„ 3ëª…ê³¼ ì‚¬ìš©ëŸ‰ì„ í•œêµ­ì–´ë¡œ ì„¤ëª…",
    "user_distribution": "ì‚¬ìš©ì ë¶„í¬ íŠ¹ì§•ì„ í•œêµ­ì–´ë¡œ ì„¤ëª…"
  },
  "device_analysis": {
    "popular_devices": "ì£¼ìš” ê¸°ê¸° ëª¨ë¸ ìƒìœ„ 3ê°œë¥¼ í•œêµ­ì–´ë¡œ ì„¤ëª…",
    "device_insight": "ê¸°ê¸° ì‚¬ìš© íŒ¨í„´ì„ í•œêµ­ì–´ë¡œ ì„¤ëª…"
  },
  "location_analysis": {
    "main_locations": "ì£¼ìš” ì§€ì—­ ì½”ë“œ ìƒìœ„ 3ê°œë¥¼ í•œêµ­ì–´ë¡œ ì„¤ëª…",
    "location_insight": "ì§€ì—­ë³„ ì‚¬ìš© íŠ¹ì§•ì„ í•œêµ­ì–´ë¡œ ì„¤ëª…"
  },
  "error_analysis": {
    "total_error_count": ${stats.totalErrors},
    "error_samples_count": "ì—ëŸ¬ ìƒ˜í”Œ ìˆ˜ (ìˆ«ì)",
    "error_patterns": "ì£¼ìš” ì—ëŸ¬ íŒ¨í„´ ë° ìœ í˜•ì„ í•œêµ­ì–´ë¡œ ì„¤ëª…",
    "recommendations": "ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­ì„ í•œêµ­ì–´ë¡œ ì„¤ëª…"
  },
  "recommendations": [
    "ê°œì„  ì œì•ˆ 1 (í•œêµ­ì–´)",
    "ê°œì„  ì œì•ˆ 2 (í•œêµ­ì–´)",
    "ê°œì„  ì œì•ˆ 3 (í•œêµ­ì–´)"
  ],
  "searchable_info": {
    "date": "${stats.logDate}",
    "date_kr": "${stats.logDateFormatted}",
    "purpose": "ì´ ì •ë³´ëŠ” '${stats.logDateFormatted}ì—ëŠ” ì–´ë–¤ ì—ëŸ¬ê°€ ìˆì—ˆì–´?' ê°™ì€ ë‚ ì§œë³„ ê²€ìƒ‰ì„ ìœ„í•œ ë©”íƒ€ë°ì´í„°ì…ë‹ˆë‹¤."
  }
}

**í•„ìˆ˜ ìš”êµ¬ì‚¬í•­:**
1. ëª¨ë“  ì„¤ëª…ê³¼ ë¶„ì„ì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±
2. ë‚ ì§œ ì •ë³´(log_date, log_date_formatted)ë¥¼ ëª…í™•íˆ í¬í•¨
3. ë¡œê·¸ ë‚´ìš© ìì²´(ì—ëŸ¬ ë©”ì‹œì§€ ë“±)ëŠ” ì›ë¬¸ ìœ ì§€
4. ë¶„ì„ê³¼ ì¸ì‚¬ì´íŠ¸ëŠ” í•œêµ­ì–´ë¡œ ìƒì„¸í•˜ê²Œ ì‘ì„±
5. ì´ ë°ì´í„°ëŠ” OpenSearchì— ì €ì¥ë˜ì–´ ë‚ ì§œë³„ ê²€ìƒ‰ì— ì‚¬ìš©ë©ë‹ˆë‹¤

ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”.`;
          
          updateProgressPopup(60, 100, 'AI ìš”ì•½ ìƒì„± ì¤‘...');
          
          // ë” ê¸´ ì‘ë‹µì„ ë°›ê¸° ìœ„í•´ limit ì¦ê°€ (4096 -> 16384)
          const aiResponse = await call_llm_api(summaryPrompt, 'qwen', false, 16384);
          
          if (!aiResponse) {
            throw new Error('AI ìš”ì•½ ìƒì„± ì‹¤íŒ¨');
          }
          
          console.log('[btn_learn_6] AI ìš”ì•½ ì™„ë£Œ');
          updateProgressPopup(80, 100, 'AI ìš”ì•½ ì™„ë£Œ! OpenSearch ì €ì¥ ì¤‘...');
          
          if (detailsDiv) {
            const time = new Date().toLocaleTimeString();
            detailsDiv.innerHTML += `[${time}] âœ… AI ìš”ì•½ ìƒì„± ì™„ë£Œ!<br>`;
            detailsDiv.innerHTML += `[${time}] ğŸ’¾ OpenSearch ì €ì¥ ì‹œì‘...<br>`;
            detailsDiv.scrollTop = detailsDiv.scrollHeight;
          }
          
          // JSON íŒŒì‹±
          let analysisResult;
          try {
            const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
              analysisResult = JSON.parse(jsonMatch[0]);
            } else {
              analysisResult = JSON.parse(aiResponse);
            }
          } catch (parseError) {
            console.error('[btn_learn_6] JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
            analysisResult = { raw_response: aiResponse };
          }
          
          // === 3ë‹¨ê³„: OpenSearchì— ì €ì¥ ===
          console.log('[btn_learn_6] 3ë‹¨ê³„: OpenSearch ì €ì¥ ì‹œì‘');
          
          // ë‚ ì§œ ì •ë³´ í™•ì¸
          const logDate = stats.logDate;
          const logDateFormatted = stats.logDateFormatted;
          
          if (!logDate) {
            console.warn('[btn_learn_6] ë‚ ì§œ ì •ë³´ ì—†ìŒ, ì°¨íŠ¸ì— í‘œì‹œë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ');
          } else {
            console.log('[btn_learn_6] ì €ì¥í•  ë‚ ì§œ:', logDate, logDateFormatted);
          }
          
          const finalDocument = {
            local_statistics: summaryStats,
            ai_analysis: analysisResult,
            processing_info: {
              method: 'Local preprocessing + AI summary',
              total_chunks_processed: totalChunks,
              processing_time: 'ì•½ 2~5ë¶„',
              file_size_mb: fileSizeMB.toFixed(2)
            },
            timestamp: new Date().toISOString(),
            // ë‚ ì§œ ì •ë³´ ì¶”ê°€ (ì°¨íŠ¸ í‘œì‹œìš©)
            log_date: logDate,
            log_date_formatted: logDateFormatted,
            searchable_info: {
              date: logDate,
              date_kr: logDateFormatted,
              purpose: `ì´ ì •ë³´ëŠ” '${logDateFormatted || 'íŠ¹ì • ë‚ ì§œ'}ì—ëŠ” ì–´ë–¤ ì—ëŸ¬ê°€ ìˆì—ˆì–´?' ê°™ì€ ë‚ ì§œë³„ ê²€ìƒ‰ì„ ìœ„í•œ ë©”íƒ€ë°ì´í„°ì…ë‹ˆë‹¤.`
            }
          };
          
          try {
            const response = await fetch(`${OPENSEARCH_API_BASE}/index`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                index: DEFAULT_INDEX,
                document: finalDocument
              })
            });
            
            const result = await response.json();
            console.log('[btn_learn_6] OpenSearch ì €ì¥ ê²°ê³¼:', result);
            
            updateProgressPopup(100, 100, 'âœ“ ë¶„ì„ ë° ì €ì¥ ì™„ë£Œ!');
            
            if (detailsDiv) {
              const time = new Date().toLocaleTimeString();
              detailsDiv.innerHTML += `[${time}] âœ… OpenSearch ì €ì¥ ì™„ë£Œ!<br>`;
              detailsDiv.innerHTML += `[${time}] ğŸ“ Index: ${DEFAULT_INDEX}<br>`;
              detailsDiv.scrollTop = detailsDiv.scrollHeight;
            }
          } catch (saveError) {
            console.error('[btn_learn_6] OpenSearch ì €ì¥ ì‹¤íŒ¨:', saveError);
            updateProgressPopup(100, 100, 'âš  ë¶„ì„ ì™„ë£Œ (ì €ì¥ ì‹¤íŒ¨)');
            
            if (detailsDiv) {
              const time = new Date().toLocaleTimeString();
              detailsDiv.innerHTML += `[${time}] âš ï¸ OpenSearch ì €ì¥ ì‹¤íŒ¨: ${saveError.message}<br>`;
              detailsDiv.scrollTop = detailsDiv.scrollHeight;
            }
          }
          
          // === 4ë‹¨ê³„: ê²°ê³¼ í‘œì‹œ ===
          setTimeout(() => {
            progressPopup.remove();
            
            // ê²°ê³¼ íŒì—… ìƒì„±
            const combinedResult = {
              local_statistics: summaryStats,
              ai_analysis: analysisResult,
              processing_info: {
                method: 'Local preprocessing + AI summary',
                total_chunks_processed: totalChunks,
                processing_time: 'ì•½ 2~5ë¶„',
                file_size_mb: fileSizeMB.toFixed(2)
              }
            };
            
            createJsonResultPopup(combinedResult, file.name);
            
            console.log('[btn_learn_6] ì „ì²´ ë¶„ì„ ì™„ë£Œ!');
            
          }, 1000);
          
        } catch (error) {
          console.error('[btn_learn_6] ë¶„ì„ ì‹¤íŒ¨:', error);
          alert('ë¶„ì„ ì‹¤íŒ¨: ' + error.message);
          
          const popup = document.getElementById('progressPopup');
          if (popup) popup.remove();
        }
      });
      
      fileInput.click();
    }


  </script>
</body>
</html>
