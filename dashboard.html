<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í”„ë¡œë¯¸ì¹´ ë¡œê·¸ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
      color: #e0e0e0;
      padding: 20px;
      min-height: 100vh;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 30px;
      background: rgba(0, 255, 255, 0.05);
      border-radius: 15px;
      border: 2px solid rgba(0, 255, 255, 0.3);
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
    }

    .header h1 {
      font-size: 36px;
      color: #00ffff;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      margin-bottom: 10px;
    }

    .header p {
      font-size: 16px;
      color: #00d9ff;
    }

    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      background: rgba(0, 255, 255, 0.05);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid rgba(0, 255, 255, 0.2);
    }

    .controls label {
      color: #00ffff;
      font-weight: bold;
      margin-right: 10px;
    }

    .controls input, .controls select {
      padding: 10px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid #00ffff;
      color: #00ffff;
      border-radius: 5px;
      font-size: 14px;
    }

    .controls button {
      padding: 10px 25px;
      background: linear-gradient(135deg, #00d9ff, #00ffff);
      color: #0a0e27;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
    }

    .controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(0, 255, 255, 0.05);
      padding: 25px;
      border-radius: 10px;
      border: 2px solid rgba(0, 255, 255, 0.3);
      text-align: center;
      transition: all 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 30px rgba(0, 255, 255, 0.3);
    }

    .stat-card .label {
      font-size: 14px;
      color: #00d9ff;
      margin-bottom: 10px;
    }

    .stat-card .value {
      font-size: 32px;
      color: #00ffff;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }

    .chart-container {
      background: rgba(0, 255, 255, 0.05);
      padding: 25px;
      border-radius: 10px;
      border: 2px solid rgba(0, 255, 255, 0.3);
      margin-bottom: 30px;
      position: relative;
    }

    .chart-container h3 {
      color: #00ffff;
      margin-bottom: 20px;
      font-size: 20px;
      text-align: center;
    }

    .chart-wrapper {
      position: relative;
      height: 400px;
    }

    .loading {
      text-align: center;
      padding: 50px;
      color: #00d9ff;
      font-size: 18px;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .error {
      background: rgba(255, 0, 0, 0.1);
      border: 2px solid rgba(255, 0, 0, 0.5);
      padding: 20px;
      border-radius: 10px;
      color: #ff6b6b;
      text-align: center;
      margin: 20px 0;
    }

    .date-range-info {
      text-align: center;
      padding: 15px;
      background: rgba(0, 255, 255, 0.1);
      border-radius: 8px;
      margin-bottom: 20px;
      color: #00ffff;
      font-size: 16px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 30px;
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
      
      .controls {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“Š í”„ë¡œë¯¸ì¹´ ë¡œê·¸ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
    <p>ì›”ê°„ ë¡œê·¸ ë°ì´í„° ì¶”ì´ ë° í†µê³„ ì‹œê°í™”</p>
  </div>

  <div class="controls">
    <div>
      <label>OpenSearch ì¸ë±ìŠ¤:</label>
      <input type="text" id="indexName" value="contest_pm_task" placeholder="ì¸ë±ìŠ¤ ì´ë¦„">
    </div>
    <div>
      <label>ì‹œì‘ ë‚ ì§œ:</label>
      <input type="date" id="startDate">
    </div>
    <div>
      <label>ì¢…ë£Œ ë‚ ì§œ:</label>
      <input type="date" id="endDate">
    </div>
    <button onclick="loadDashboardData()">ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button onclick="refreshDashboard()">ğŸ”ƒ ìƒˆë¡œê³ ì¹¨</button>
  </div>

  <div id="dateRangeInfo" class="date-range-info" style="display: none;"></div>

  <div id="loadingIndicator" class="loading" style="display: none;">ë°ì´í„° ë¡œë”© ì¤‘</div>
  <div id="errorMessage" class="error" style="display: none;"></div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="label">ì´ ë¶„ì„ ì¼ìˆ˜</div>
      <div class="value" id="totalDays">-</div>
    </div>
    <div class="stat-card">
      <div class="label">ì´ ìš”ì²­ ìˆ˜</div>
      <div class="value" id="totalRequests">-</div>
    </div>
    <div class="stat-card">
      <div class="label">ì´ ì—ëŸ¬ ìˆ˜</div>
      <div class="value" id="totalErrors">-</div>
    </div>
    <div class="stat-card">
      <div class="label">ì¼í‰ê·  ìš”ì²­</div>
      <div class="value" id="avgRequests">-</div>
    </div>
  </div>

  <div class="chart-container">
    <h3>ğŸ“ˆ ì¼ë³„ ìš”ì²­ ìˆ˜ ì¶”ì´</h3>
    <div class="chart-wrapper">
      <canvas id="dailyRequestsChart"></canvas>
    </div>
  </div>

  <div class="chart-container">
    <h3>âš ï¸ ì¼ë³„ ì—ëŸ¬ ë°œìƒ ì¶”ì´</h3>
    <div class="chart-wrapper">
      <canvas id="dailyErrorsChart"></canvas>
    </div>
  </div>

  <div class="grid-2">
    <div class="chart-container">
      <h3>â° ì‹œê°„ëŒ€ë³„ í‰ê·  ì‚¬ìš©ëŸ‰</h3>
      <div class="chart-wrapper">
        <canvas id="hourlyUsageChart"></canvas>
      </div>
    </div>

    <div class="chart-container">
      <h3>ğŸ“± ì¸ê¸° ê¸°ê¸° TOP 10</h3>
      <div class="chart-wrapper">
        <canvas id="topDevicesChart"></canvas>
      </div>
    </div>
  </div>

  <div class="grid-2">
    <div class="chart-container">
      <h3>ğŸ‘¥ í™œë°œí•œ ì‚¬ìš©ì TOP 10</h3>
      <div class="chart-wrapper">
        <canvas id="topUsersChart"></canvas>
      </div>
    </div>

    <div class="chart-container">
      <h3>ğŸŒ ì§€ì—­ë³„ ì‚¬ìš© ë¶„í¬</h3>
      <div class="chart-wrapper">
        <canvas id="locationsChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const OPENSEARCH_API_BASE = "http://10.10.22.81:8080";
    let charts = {};

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ì¢…ë£Œì¼ë¡œ, 30ì¼ ì „ì„ ì‹œì‘ì¼ë¡œ ì„¤ì •
    window.addEventListener('DOMContentLoaded', () => {
      const today = new Date();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);

      document.getElementById('startDate').value = formatDate(thirtyDaysAgo);
      document.getElementById('endDate').value = formatDate(today);
    });

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function showLoading(show) {
      document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      if (message) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      } else {
        errorDiv.style.display = 'none';
      }
    }

    async function loadDashboardData() {
      showLoading(true);
      showError(null);

      const indexName = document.getElementById('indexName').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      if (!startDate || !endDate) {
        showError('ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        showLoading(false);
        return;
      }

      try {
        console.log('[Dashboard] ë°ì´í„° ë¡œë”© ì‹œì‘:', { indexName, startDate, endDate });

        // ë‚ ì§œ ë²”ìœ„ ë‚´ì˜ ëª¨ë“  ë‚ ì§œì— ëŒ€í•´ ê²€ìƒ‰
        const allDocuments = [];
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        const dateRangeInfo = document.getElementById('dateRangeInfo');
        dateRangeInfo.textContent = `ğŸ“… ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (${startDate} ~ ${endDate})`;
        dateRangeInfo.style.display = 'block';

        // ë‚ ì§œ ë²”ìœ„ ë‚´ì˜ ê° ë‚ ì§œë³„ë¡œ ê²€ìƒ‰
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const dateStr = formatDate(d);
          console.log('[Dashboard] ë‚ ì§œë³„ ê²€ìƒ‰:', dateStr);

          try {
            // keyword_searchë¡œ ë‚ ì§œ ê²€ìƒ‰
            const response = await fetch(`${OPENSEARCH_API_BASE}/keyword_search`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                text: dateStr,
                index: indexName,
                k: 10
              })
            });

            if (response.ok) {
              const data = await response.json();
              if (data.result && data.result.length > 0) {
                // ê²°ê³¼ê°€ ë¬¸ìì—´ ë°°ì—´ì¸ì§€ ê°ì²´ ë°°ì—´ì¸ì§€ í™•ì¸
                const docs = data.result.map(item => {
                  if (typeof item === 'string') {
                    try {
                      return JSON.parse(item);
                    } catch {
                      return null;
                    }
                  }
                  return item;
                }).filter(doc => doc !== null);

                // í•´ë‹¹ ë‚ ì§œì˜ ë¬¸ì„œë§Œ í•„í„°ë§
                const dateDocs = docs.filter(doc => {
                  const logDate = doc.local_statistics?.logDate || doc.log_date || '';
                  return logDate === dateStr;
                });

                if (dateDocs.length > 0) {
                  allDocuments.push(dateDocs[0]); // ë‚ ì§œë‹¹ í•˜ë‚˜ì˜ ë¬¸ì„œë§Œ
                  console.log('[Dashboard] ë°œê²¬:', dateStr, dateDocs[0]);
                }
              }
            }
          } catch (err) {
            console.warn('[Dashboard] ë‚ ì§œ ê²€ìƒ‰ ì‹¤íŒ¨:', dateStr, err);
          }

          // UI ì—…ë°ì´íŠ¸
          dateRangeInfo.textContent = `ğŸ“… ë°ì´í„° ìˆ˜ì§‘ ì¤‘... ${allDocuments.length}ì¼ì¹˜ ë°œê²¬`;
        }

        console.log('[Dashboard] ì´ ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ:', allDocuments.length, 'ì¼');

        if (allDocuments.length === 0) {
          showError(`${startDate}ë¶€í„° ${endDate}ê¹Œì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € btn_learn_6ìœ¼ë¡œ ë¡œê·¸ë¥¼ í•™ìŠµì‹œì¼œì£¼ì„¸ìš”.\n\nğŸ’¡ íŒ: íŒŒì¼ëª…ì„ "YYYYMMDD.log" í˜•ì‹ìœ¼ë¡œ ì—…ë¡œë“œí•˜ì„¸ìš” (ì˜ˆ: 20251030.log)`);
          showLoading(false);
          return;
        }

        // ë°ì´í„° ì²˜ë¦¬ ë° ì‹œê°í™”
        processAndVisualize(allDocuments, startDate, endDate);
        showLoading(false);

      } catch (error) {
        console.error('[Dashboard] ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
        showError(`ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${error.message}\n\nOpenSearch ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.`);
        showLoading(false);
      }
    }

    function processAndVisualize(documents, startDate, endDate) {
      console.log('[Dashboard] ë°ì´í„° ì²˜ë¦¬ ì‹œì‘:', documents.length, 'ê°œ ë¬¸ì„œ');

      // ë‚ ì§œë³„ë¡œ ì •ë ¬
      documents.sort((a, b) => {
        const dateA = a.local_statistics?.logDate || a.log_date || '';
        const dateB = b.local_statistics?.logDate || b.log_date || '';
        return dateA.localeCompare(dateB);
      });

      // í†µê³„ ê³„ì‚°
      const dailyData = [];
      let totalRequests = 0;
      let totalErrors = 0;
      const hourlyUsage = {};
      const devices = {};
      const users = {};
      const locations = {};

      documents.forEach(doc => {
        const stats = doc.local_statistics || doc.ai_analysis || doc;
        const logDate = stats.logDate || doc.log_date || 'ë‚ ì§œ ë¯¸ìƒ';
        const logDateFormatted = stats.logDateFormatted || doc.log_date_formatted || logDate;

        // ì¼ë³„ ë°ì´í„°
        const requests = parseInt(stats.totalRequests || 0);
        const errors = (stats.errorSamples || stats.errors || []).length;

        dailyData.push({
          date: logDate,
          dateFormatted: logDateFormatted,
          requests: requests,
          errors: errors
        });

        totalRequests += requests;
        totalErrors += errors;

        // ì‹œê°„ëŒ€ë³„ ì‚¬ìš©ëŸ‰ ì§‘ê³„
        const hourly = stats.hourlyUsage || {};
        Object.entries(hourly).forEach(([hour, count]) => {
          hourlyUsage[hour] = (hourlyUsage[hour] || 0) + count;
        });

        // ê¸°ê¸° ì§‘ê³„
        const topDevices = stats.topDevices || {};
        Object.entries(topDevices).forEach(([device, count]) => {
          devices[device] = (devices[device] || 0) + count;
        });

        // ì‚¬ìš©ì ì§‘ê³„
        const topUsers = stats.topUsers || {};
        Object.entries(topUsers).forEach(([user, count]) => {
          users[user] = (users[user] || 0) + count;
        });

        // ì§€ì—­ ì§‘ê³„
        const topLocations = stats.topLocations || {};
        Object.entries(topLocations).forEach(([loc, count]) => {
          locations[loc] = (locations[loc] || 0) + count;
        });
      });

      // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
      document.getElementById('totalDays').textContent = documents.length.toLocaleString();
      document.getElementById('totalRequests').textContent = totalRequests.toLocaleString();
      document.getElementById('totalErrors').textContent = totalErrors.toLocaleString();
      document.getElementById('avgRequests').textContent = Math.round(totalRequests / documents.length).toLocaleString();

      // ë‚ ì§œ ë²”ìœ„ ì •ë³´ í‘œì‹œ
      const dateRangeInfo = document.getElementById('dateRangeInfo');
      dateRangeInfo.textContent = `ğŸ“… ë¶„ì„ ê¸°ê°„: ${startDate} ~ ${endDate} (${documents.length}ì¼)`;
      dateRangeInfo.style.display = 'block';

      // ì°¨íŠ¸ ìƒì„±
      createDailyRequestsChart(dailyData);
      createDailyErrorsChart(dailyData);
      createHourlyUsageChart(hourlyUsage);
      createTopDevicesChart(devices);
      createTopUsersChart(users);
      createLocationsChart(locations);

      console.log('[Dashboard] ì‹œê°í™” ì™„ë£Œ');
    }

    function createDailyRequestsChart(dailyData) {
      const ctx = document.getElementById('dailyRequestsChart');
      if (charts.dailyRequests) charts.dailyRequests.destroy();

      charts.dailyRequests = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dailyData.map(d => d.dateFormatted),
          datasets: [{
            label: 'ì¼ë³„ ìš”ì²­ ìˆ˜',
            data: dailyData.map(d => d.requests),
            borderColor: '#00ffff',
            backgroundColor: 'rgba(0, 255, 255, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#00ffff' } }
          },
          scales: {
            x: { ticks: { color: '#00d9ff' }, grid: { color: 'rgba(0, 255, 255, 0.1)' } },
            y: { ticks: { color: '#00d9ff' }, grid: { color: 'rgba(0, 255, 255, 0.1)' } }
          }
        }
      });
    }

    function createDailyErrorsChart(dailyData) {
      const ctx = document.getElementById('dailyErrorsChart');
      if (charts.dailyErrors) charts.dailyErrors.destroy();

      charts.dailyErrors = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dailyData.map(d => d.dateFormatted),
          datasets: [{
            label: 'ì¼ë³„ ì—ëŸ¬ ìˆ˜',
            data: dailyData.map(d => d.errors),
            backgroundColor: 'rgba(255, 99, 132, 0.6)',
            borderColor: '#ff6b6b',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#00ffff' } }
          },
          scales: {
            x: { ticks: { color: '#00d9ff' }, grid: { color: 'rgba(0, 255, 255, 0.1)' } },
            y: { ticks: { color: '#00d9ff' }, grid: { color: 'rgba(0, 255, 255, 0.1)' } }
          }
        }
      });
    }

    function createHourlyUsageChart(hourlyUsage) {
      const ctx = document.getElementById('hourlyUsageChart');
      if (charts.hourlyUsage) charts.hourlyUsage.destroy();

      const hours = Array.from({ length: 24 }, (_, i) => String(i).padStart(2, '0'));
      const data = hours.map(h => hourlyUsage[h] || 0);

      charts.hourlyUsage = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: hours.map(h => `${h}ì‹œ`),
          datasets: [{
            label: 'ì‹œê°„ëŒ€ë³„ ì‚¬ìš©ëŸ‰',
            data: data,
            borderColor: '#00ffff',
            backgroundColor: 'rgba(0, 255, 255, 0.2)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#00ffff' } }
          },
          scales: {
            r: { 
              ticks: { color: '#00d9ff' }, 
              grid: { color: 'rgba(0, 255, 255, 0.1)' },
              pointLabels: { color: '#00d9ff' }
            }
          }
        }
      });
    }

    function createTopDevicesChart(devices) {
      const ctx = document.getElementById('topDevicesChart');
      if (charts.topDevices) charts.topDevices.destroy();

      const sorted = Object.entries(devices).sort((a, b) => b[1] - a[1]).slice(0, 10);

      charts.topDevices = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: sorted.map(d => d[0]),
          datasets: [{
            data: sorted.map(d => d[1]),
            backgroundColor: [
              '#00ffff', '#00d9ff', '#00b3cc', '#008c99', '#006666',
              '#ffaa00', '#ff8800', '#ff6600', '#ff4400', '#ff2200'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#00ffff' }, position: 'right' }
          }
        }
      });
    }

    function createTopUsersChart(users) {
      const ctx = document.getElementById('topUsersChart');
      if (charts.topUsers) charts.topUsers.destroy();

      const sorted = Object.entries(users).sort((a, b) => b[1] - a[1]).slice(0, 10);

      charts.topUsers = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sorted.map(u => u[0]),
          datasets: [{
            label: 'ì‚¬ìš©ëŸ‰',
            data: sorted.map(u => u[1]),
            backgroundColor: 'rgba(0, 255, 255, 0.6)',
            borderColor: '#00ffff',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { labels: { color: '#00ffff' } }
          },
          scales: {
            x: { ticks: { color: '#00d9ff' }, grid: { color: 'rgba(0, 255, 255, 0.1)' } },
            y: { ticks: { color: '#00d9ff' }, grid: { color: 'rgba(0, 255, 255, 0.1)' } }
          }
        }
      });
    }

    function createLocationsChart(locations) {
      const ctx = document.getElementById('locationsChart');
      if (charts.locations) charts.locations.destroy();

      const sorted = Object.entries(locations).sort((a, b) => b[1] - a[1]).slice(0, 10);

      charts.locations = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: sorted.map(l => `ì§€ì—­ ${l[0]}`),
          datasets: [{
            data: sorted.map(l => l[1]),
            backgroundColor: [
              '#00ffff', '#00d9ff', '#00b3cc', '#008c99', '#006666',
              '#ffaa00', '#ff8800', '#ff6600', '#ff4400', '#ff2200'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#00ffff' }, position: 'right' }
          }
        }
      });
    }

    function refreshDashboard() {
      loadDashboardData();
    }
  </script>
</body>
</html>
