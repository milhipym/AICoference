<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>ÌîÑÎ°úÎØ∏Ïπ¥ Î°úÍ∑∏ Î™®ÎãàÌÑ∞ÎßÅ</title>
<link rel="stylesheet" href="css/common.css" />
<link rel="stylesheet" href="css/contents.css" />
<link rel="stylesheet" href="css/modal.css" />
<link rel="stylesheet" href="css/card.css" />
<link rel="stylesheet" href="css/layout-erroranalyze.css" />
<link rel="stylesheet" href="css/layout-searchlist.css" />
<link rel="stylesheet" href="css/layout-detailanalyze.css" />
</head>
<body>
  <div class="cockpit">
    <!-- Ìó§Îçî -->
    <div class="cockpit-header">
      <h1>‚óà LOG MONITORING SYSTEM ‚óà</h1>
      <p class="subtitle">REAL-TIME ANALYSIS DASHBOARD</p>
      <div style="text-align: center; margin-top: 15px;">
        <a href="dashboard.html" style="display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #00d9ff, #00ffff); color: #0a0e27; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 16px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.4); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 30px rgba(0, 255, 255, 0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 0 20px rgba(0, 255, 255, 0.4)'">
          üìä ÏõîÍ∞Ñ Î∂ÑÏÑù ÎåÄÏãúÎ≥¥Îìú
        </a>
      </div>
    </div>

    <!-- Î©îÏù∏ Î™®ÎãàÌÑ∞ (ÎåÄÌòï Ï∞®Ìä∏ ÌôîÎ©¥) -->
    <div class="main-monitor">
      <div class="monitor-header">
        <span class="monitor-title">‚óÜ TEMPORAL LOG DISTRIBUTION</span>
        <div class="monitor-indicators">
          <span class="indicator active"></span>
          <span class="indicator"></span>
          <span class="indicator"></span>
        </div>
      </div>
      <div class="monitor-body">
        <div id="chart"></div>
        <progress id="prog" max="100" value="0"></progress>
        <div id="status">
          <span class="status-text">SYSTEM READY - AWAITING LOG FILE</span>
        </div>
      </div>
    </div>

    <!-- ÌïòÎã® ÏΩòÏÜî Ìå®ÎÑê Í∑∏Î¶¨Îìú -->
    <div class="console-grid">
      <!-- ÌååÏùº Î°úÎìú Ìå®ÎÑê -->
      <div class="console-panel">
        <div class="panel-header">‚ñ£ FILE LOADER</div>
        <div class="panel-body">
          <div class="upload-zone" id="uploadZone">
            <input id="file" type="file" accept=".log,.txt" />
            <label for="file" class="upload-btn">SELECT FILE</label>
            <span id="file-name">NO FILE LOADED</span>
          </div>
          <div class="file-history">
            <div class="history-header">
              RECENT FILES
              <button class="history-popup-btn" onclick="openHistoryPopup()" title="Ï†ÑÏ≤¥ ÌûàÏä§ÌÜ†Î¶¨ Î≥¥Í∏∞">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="9" y1="9" x2="15" y2="9"></line>
                  <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
              </button>
            </div>
            <div id="historyList" class="history-list">
              <div class="history-empty">NO HISTORY</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Í≤ÄÏÉâ Ï†úÏñ¥ Ìå®ÎÑê -->
      <div class="console-panel">
        <div class="panel-header">‚ñ£ SEARCH CONTROL</div>
        <div class="panel-body">
          <div class="control-group">
            <label>Ï∂îÏ≤ú ÌÇ§ÏõåÎìú</label>
            <div class="keyword-chips">
              <button class="chip chip-info" onclick="setSearchWord('INFO')">INFO</button>
              <button class="chip chip-error" onclick="setSearchWord('Exception')">Exception</button>
              <button class="chip chip-fatal" onclick="setSearchWord('FATAL')">FATAL</button>
            </div>
          </div>
          <div class="control-group">
            <label>PATTERN</label>
            <input type="text" id="searchWord" placeholder="INFO, Exception, WARN..." value="INFO">
          </div>
          <button class="btn primary" id="btnSearch" onclick="doSearch()">EXECUTE SEARCH</button>
        </div>
      </div>

      <!-- Î∂ÑÏÑù ÏòµÏÖò Ìå®ÎÑê -->
      <div class="console-panel">
        <div class="panel-header">‚ñ£ ANALYSIS OPTIONS</div>
        <div class="panel-body">
          <button class="btn btn-cyber-neon" id="btnDetail" onclick="openDetailPopup()">Ï¢ÖÌï© Î∂ÑÏÑù</button>
          <button class="btn btn-cyber-neon" id="btnErrorAnal" onclick="openErrorPopup()">Ïò§Î•ò Î∂ÑÏÑù</button>
          <button class="btn btn-cyber-neon" id="btnSplit" onclick="doSplit()">FILE SPLIT</button>
        </div>
      </div>

      <!-- Î°úÍ∑∏ Î∑∞Ïñ¥ Ìå®ÎÑê -->
      <div class="console-panel log-viewer-half">
        <div class="panel-header">‚ñ£ LOG VIEWER</div>
        <div class="panel-body">
          <div id="preview"></div>
        </div>
      </div>


    </div>
  </div>

  <!-- Ï¢ÖÌï©Î∂ÑÏÑù ÌåùÏóÖ -->
  <div id="detailPopup" class="detail-popup">
    <div class="detail-popup-content">
      <div class="detail-popup-header">
        <h2>‚óÜ LOG STATISTICS ANALYSIS ‚óÜ</h2>
        
        <!-- Ïà®Í≤®ÏßÑ ÌïôÏäµ Î≤ÑÌäºÎì§ -->
        <div class="hidden-learning-buttons">
          <button id="btn_learn_1" class="hidden-btn" title="Ïù∏Îç±Ïä§ ÏÉùÏÑ±">1</button>
          <button id="btn_learn_2" class="hidden-btn" title="ÏûÑÎ≤†Îî© ÏÉùÏÑ±">2</button>
          <button id="btn_learn_3" class="hidden-btn" title="Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ">3</button>
          <button id="btn_learn_4" class="hidden-btn" title="ÏòàÏïΩ Í∏∞Îä•">4</button>
          <button id="btn_learn_5" class="hidden-btn" title="ÏòàÏïΩ Í∏∞Îä•">5</button>
          <button id="btn_learn_6" class="hidden-btn" title="Î°úÏª¨ Ï†ÑÏ≤òÎ¶¨ Î∂ÑÏÑù">6</button>
        </div>
        
        <button class="detail-close-btn" onclick="closeDetailPopup()">‚úï CLOSE</button>
      </div>
      
      <!-- Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖò -->
      <div id="analysisLoading" class="analysis-loading">
        <!-- ÏûêÎπÑÏä§ Ïä§ÌÉÄÏùº Îç∞Ïù¥ÌÑ∞ Ïä§Ìä∏Î¶º Î∞∞Í≤Ω -->
        <div class="jarvis-data-streams">
          <div class="data-stream stream-1"></div>
          <div class="data-stream stream-2"></div>
          <div class="data-stream stream-3"></div>
          <div class="data-stream stream-4"></div>
        </div>
        
        <!-- ÏõÄÏßÅÏù¥Îäî ÎùºÏù∏Îì§ -->
        <div class="jarvis-lines">
          <div class="scan-line line-1"></div>
          <div class="scan-line line-2"></div>
          <div class="scan-line line-3"></div>
        </div>
        
        <!-- Ï∂îÍ∞Ä ÌöåÏ†Ñ ÎßÅÎì§ -->
        <div class="jarvis-rings">
          <div class="ring ring-1"></div>
          <div class="ring ring-2"></div>
          <div class="ring ring-3"></div>
        </div>
        
        <div class="loading-spinner"></div>
        <div class="loading-text">ANALYZING LOG DATA...</div>
        <div class="loading-progress" id="loadingProgress">0%</div>
      </div>
      
      <div id="detailContent" style="display:none;">
        <div class="detail-section">
          <h3>? Overall Statistics</h3>
          <div class="detail-stats-grid">
            <div class="stat-card">
              <h4>Total Requests</h4>
              <div class="stat-value" id="totalRequests">0</div>
            </div>
            <div class="stat-card">
              <h4>Exception Count</h4>
              <div class="stat-value" id="errorCount" style="color: #ff6666;">0</div>
            </div>
            <div class="stat-card">
              <h4>Analysis Duration</h4>
              <div class="stat-value" id="analysisDuration" style="font-size: 18px;">-</div>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>? TOP 5 UX_ Requests</h3>
          <div id="topRequests"></div>
        </div>

        <div class="detail-section">
          <h3>‚ö†Ô∏è Exceptions</h3>
          <div id="errorLogs" class="error-list"></div>
          <div id="errorPagination" class="error-pagination" style="display:none;">
            <button class="btn-page" onclick="prevErrorPage()">‚óÄ PREV</button>
            <span class="page-info" id="errorPageInfo">1 / 1</span>
            <button class="btn-page" onclick="nextErrorPage()">NEXT ‚ñ∂</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/marked.min.js"></script>
  <script src="js/jszip.min.js"></script>
  <script src="js/logWorkerSource.js"></script>
  <script src="js/plotly-3.1.0.min.js"></script>
  <script src="js/modal.js"></script>
  <script src="js/util/fileUtil.js"></script>
  <script src="js/util/stringUtil.js"></script>
  <script src="js/model/errorAnalyzeViewModel.js"></script>
  <script src="js/model/searchListViewModel.js"></script>
  <script src="js/model/detailInfoViewModel.js"></script>
  <script src="js/main.js"></script>
  <script src="js/view/erroranalyze.js"></script>
  <script src="js/view/searchList.js"></script>
  <script src="js/view/detailInfo.js"></script>
  
  <script>
    const uploadZone = document.getElementById('uploadZone');
    const fileInputEl = document.getElementById('file');

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const f = files[0];
        window.logfile = f;
        document.getElementById('file-name').textContent = f.name;
        
        if (typeof chartDragClear === 'function') {
          chartDragClear();
        }
        window.timeRangeSize = 24;
        
        // ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï∂îÍ∞Ä
        if (typeof addToHistory === 'function') {
          addToHistory(f);
        }
      }
    });

    fileInputEl.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (f) {
        document.getElementById('file-name').textContent = f.name;
        
        // ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï∂îÍ∞Ä
        if (typeof addToHistory === 'function') {
          addToHistory(f);
        }
      }
    });

    // Ï∂îÏ≤ú ÌÇ§ÏõåÎìú ÌÅ¥Î¶≠ Ïãú Í≤ÄÏÉâÏñ¥ ÏûêÎèô ÏûÖÎ†•
    function setSearchWord(keyword) {
      document.getElementById('searchWord').value = keyword;
      document.getElementById('searchWord').focus();
    }

    // IndexedDB ÏÑ§Ï†ï
    const DB_NAME = 'LogAnalyzerDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'logfiles';
    const FILE_HISTORY_KEY = 'logfile_history';
    const MAX_HISTORY = 15;
    let db = null;

    // IndexedDB Ï¥àÍ∏∞Ìôî
    async function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          }
        };
      });
    }

    // IndexedDBÏóê ÌååÏùº Ï†ÄÏû•
    async function saveFileToIndexedDB(file) {
      if (!db) await initDB();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const id = `${file.name}_${file.size}`;
        
        const request = store.put({ id, file, timestamp: Date.now() });
        request.onsuccess = () => resolve(id);
        request.onerror = () => reject(request.error);
      });
    }

    // IndexedDBÏóêÏÑú ÌååÏùº Î∂àÎü¨Ïò§Í∏∞
    async function loadFileFromIndexedDB(id) {
      if (!db) await initDB();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(id);
        
        request.onsuccess = () => {
          if (request.result) {
            resolve(request.result.file);
          } else {
            resolve(null);
          }
        };
        request.onerror = () => reject(request.error);
      });
    }

    // IndexedDBÏóêÏÑú ÌååÏùº ÏÇ≠Ï†ú
    async function deleteFileFromIndexedDB(id) {
      if (!db) await initDB();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(id);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // ÌûàÏä§ÌÜ†Î¶¨ Î∂àÎü¨Ïò§Í∏∞
    function loadHistory() {
      try {
        const history = localStorage.getItem(FILE_HISTORY_KEY);
        return history ? JSON.parse(history) : [];
      } catch (e) {
        return [];
      }
    }

    // ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû•
    function saveHistory(history) {
      try {
        localStorage.setItem(FILE_HISTORY_KEY, JSON.stringify(history));
      } catch (e) {
        console.error('Failed to save history:', e);
      }
    }

    // ÌûàÏä§ÌÜ†Î¶¨Ïóê ÌååÏùº Ï∂îÍ∞Ä
    async function addToHistory(file) {
      let history = loadHistory();
      
      // Ï§ëÎ≥µ Ï†úÍ±∞ (Í∞ôÏùÄ ÌååÏùºÎ™ÖÍ≥º ÌÅ¨Í∏∞)
      history = history.filter(item => 
        !(item.name === file.name && item.size === file.size)
      );
      
      // ÏÉà ÌååÏùºÏùÑ Îß® ÏïûÏóê Ï∂îÍ∞Ä
      history.unshift({
        name: file.name,
        size: file.size,
        timestamp: Date.now()
      });
      
      // ÏµúÎåÄ Í∞úÏàò Ï†úÌïú
      history = history.slice(0, MAX_HISTORY);
      
      saveHistory(history);
      
      // IndexedDBÏóê ÌååÏùº Ï†ÄÏû•
      try {
        await saveFileToIndexedDB(file);
      } catch (e) {
        console.error('Failed to save file to IndexedDB:', e);
      }
      
      updateHistoryUI();
    }

    // ÌûàÏä§ÌÜ†Î¶¨ÏóêÏÑú ÏÇ≠Ï†ú
    function removeFromHistory(index) {
      let history = loadHistory();
      history.splice(index, 1);
      saveHistory(history);
      updateHistoryUI();
    }

    // ÌååÏùº ÌÅ¨Í∏∞ Ìè¨Îß∑
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
    }

    // ÌûàÏä§ÌÜ†Î¶¨ ÌååÏùº ÌÅ¥Î¶≠ Ïãú Î°úÎìú
    async function loadFromHistory(index) {
      const history = loadHistory();
      const item = history[index];
      
      if (!item) return;
      
      // IndexedDBÏóêÏÑú ÌååÏùº Î∂àÎü¨Ïò§Í∏∞
      const fileId = `${item.name}_${item.size}`;
      const file = await loadFileFromIndexedDB(fileId);
      
      if (file) {
        // ÌååÏùº ÏûêÎèô Î°úÎìú
        window.logfile = file;
        mainModel.logfile = file;
        document.getElementById('file-name').textContent = file.name;
        
        if (typeof chartDragClear === 'function') {
          chartDragClear();
        }
        window.timeRangeSize = 24;
        
        // Í≤ÄÏÉâ Î≤ÑÌäº ÍπúÎπ°ÏûÑ Ï∂îÍ∞Ä
        const searchBtn = document.getElementById('btnSearch');
        if (searchBtn) {
          searchBtn.classList.add('btn-blink');
        }
      } else {
        // ÌååÏùºÏù¥ IndexedDBÏóê ÏóÜÏùå
        alert(`ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.\n"${item.name}" ÌååÏùºÏùÑ Îã§Ïãú ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.`);
        await deleteFileFromIndexedDB(fileId);
        removeFromHistory(index);
      }
    }

    // ÌûàÏä§ÌÜ†Î¶¨ UI ÏóÖÎç∞Ïù¥Ìä∏ (ÏµúÏã† 1Í∞úÎßå ÌëúÏãú)
    function updateHistoryUI() {
      const history = loadHistory();
      const historyList = document.getElementById('historyList');
      
      if (history.length === 0) {
        historyList.innerHTML = '<div class="history-empty">NO HISTORY</div>';
        return;
      }
      
      // ÏµúÏã† 1Í∞úÎßå ÌëúÏãú
      const latestItem = history[0];
      historyList.innerHTML = `
        <div class="history-item">
          <span class="history-item-name" title="${latestItem.name}" onclick="loadFromHistory(0)">${latestItem.name}</span>
          <span class="history-item-size">${formatFileSize(latestItem.size)}</span>
          <button class="history-item-delete" onclick="removeFromHistory(0)">√ó</button>
        </div>
      `;
    }

    // Ï†ÑÏó≠ Î™®Îã¨ Ïù∏Ïä§ÌÑ¥Ïä§
    let historyModal = null;

    // ÌûàÏä§ÌÜ†Î¶¨ ÌåùÏóÖ Ïó¥Í∏∞
    function openHistoryPopup() {
      const history = loadHistory();
      
      if (history.length === 0) {
        alert('Ï†ÄÏû•Îêú ÌååÏùº ÌûàÏä§ÌÜ†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
      }
      
      const popupContent = `
        <div class="history-popup-header">
          <h3>ÌååÏùº ÌûàÏä§ÌÜ†Î¶¨ (${history.length}Í∞ú)</h3>
          <button class="popup-close-btn" onclick="closeHistoryPopup()">√ó</button>
        </div>
        <div class="history-popup-list">
          ${history.map((item, index) => `
            <div class="history-popup-item">
              <div class="popup-item-info" onclick="loadFromHistoryPopup(${index})">
                <span class="popup-item-name" title="${item.name}">${item.name}</span>
                <span class="popup-item-size">${formatFileSize(item.size)}</span>
              </div>
              <button class="popup-item-delete" onclick="removeFromHistoryPopup(${index})">ÏÇ≠Ï†ú</button>
            </div>
          `).join('')}
        </div>
      `;
      
      // Modal Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
      historyModal = new Modal({
        size: 'md',
        title: '',
        closeOnEsc: true,
        closeOnOverlay: true
      });
      
      historyModal.setContent(popupContent);
      historyModal.open();
    }

    // ÌåùÏóÖ Îã´Í∏∞
    function closeHistoryPopup() {
      if (historyModal) {
        historyModal.close();
        historyModal = null;
      }
    }

    // ÌåùÏóÖÏóêÏÑú ÌååÏùº Î°úÎìú
    async function loadFromHistoryPopup(index) {
      const history = loadHistory();
      const item = history[index];
      
      if (!item) return;
      
      // IndexedDBÏóêÏÑú ÌååÏùº Î∂àÎü¨Ïò§Í∏∞
      const fileId = `${item.name}_${item.size}`;
      const file = await loadFileFromIndexedDB(fileId);
      
      if (file) {
        // ÌååÏùº ÏûêÎèô Î°úÎìú
        window.logfile = file;
        mainModel.logfile = file
        document.getElementById('file-name').textContent = file.name;
        
        if (typeof chartDragClear === 'function') {
          chartDragClear();
        }
        window.timeRangeSize = 24;
        
        // Í≤ÄÏÉâ Î≤ÑÌäº ÍπúÎπ°ÏûÑ Ï∂îÍ∞Ä
        const searchBtn = document.getElementById('btnSearch');
        if (searchBtn) {
          searchBtn.classList.add('btn-blink');
        }
        
        // ÌåùÏóÖ Îã´Í∏∞
        closeHistoryPopup();
      } else {
        // ÌååÏùºÏù¥ IndexedDBÏóê ÏóÜÏùå
        alert(`ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.\n"${item.name}" ÌååÏùºÏùÑ Îã§Ïãú ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.`);
        await removeFromHistoryPopup(index);
      }
    }

    // ÌåùÏóÖÏóêÏÑú ÌååÏùº ÏÇ≠Ï†ú
    async function removeFromHistoryPopup(index) {
      const history = loadHistory();
      const item = history[index];
      
      if (item) {
        const fileId = `${item.name}_${item.size}`;
        await deleteFileFromIndexedDB(fileId);
      }
      
      removeFromHistory(index);
      
      // ÌåùÏóÖ ÎÇ¥Ïö© Í∞±Ïã†
      const newHistory = loadHistory();
      if (newHistory.length === 0) {
        closeHistoryPopup();
        return;
      }
      
      // ÌåùÏóÖ Îã§Ïãú Ïó¥Í∏∞ (Í∞±Ïã†)
      closeHistoryPopup();
      setTimeout(() => openHistoryPopup(), 100);
    }

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú IndexedDB Ï¥àÍ∏∞Ìôî
    (async function() {
      await initDB();
      updateHistoryUI();
    })();

    // Ï¥àÍ∏∞ ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú
    updateHistoryUI();

    // Î°úÍ∑∏ Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    let logAnalysisData = {
      totalRequests: 0,
      uxRequests: {},
      errors: [],
      totalErrorCount: 0,
      timeStart: null,
      timeEnd: null
    };

    // ÏóêÎü¨ ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò
    let currentErrorPage = 1;
    const ERRORS_PER_PAGE = 20;

    // Ï¢ÖÌï©Î∂ÑÏÑù ÌåùÏóÖ Ïó¥Í∏∞
    async function openDetailPopup() {
      if (!mainModel.logfile) {
        alert("Î°úÍ∑∏ ÌååÏùºÏùÑ ÏóÖÎ°úÎìú ÌõÑ 'EXECUTE SEARCH' Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî !!");
        return;
      }

      // Í≤ÄÏÉâ ÏôÑÎ£å Ïó¨Î∂Ä ÌôïÏù∏
      if (!mainModel.searchObj || !mainModel.searchObj.searchLineStartByteArray) {
        alert("Î°úÍ∑∏ ÌååÏùºÏùÑ ÏóÖÎ°úÎìú ÌõÑ 'EXECUTE SEARCH' Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî !!");
        return;
      }

      const popup = document.getElementById('detailPopup');
      popup.classList.add('active');
      
      // Î°úÎî© ÌëúÏãú, Í≤∞Í≥º Ïà®ÍπÄ
      document.getElementById('analysisLoading').style.display = 'flex';
      document.getElementById('detailContent').style.display = 'none';
      document.getElementById('loadingProgress').textContent = '0%';
      
      // Î°úÍ∑∏ Î∂ÑÏÑù ÏãúÏûë
      await analyzeLogFile();
      
      // Î°úÎî© Ïà®ÍπÄ, Í≤∞Í≥º ÌëúÏãú
      document.getElementById('analysisLoading').style.display = 'none';
      document.getElementById('detailContent').style.display = 'block';
      
      // Í≤∞Í≥º ÌëúÏãú
      currentErrorPage = 1;
      displayAnalysisResults();
    }

    // Ï¢ÖÌï©Î∂ÑÏÑù ÌåùÏóÖ Îã´Í∏∞
    function closeDetailPopup() {
      const popup = document.getElementById('detailPopup');
      popup.classList.remove('active');
    }

    // Î°úÍ∑∏ ÌååÏùº Î∂ÑÏÑù (Ï≤≠ÌÅ¨ Î∞©Ïãù - ÎåÄÏö©Îüâ ÌååÏùº ÏßÄÏõê)
    async function analyzeLogFile() {
      const file = mainModel.logfile;
      if (!file) return;

      // Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
      logAnalysisData = {
        totalRequests: 0,
        uxRequests: {},
        errors: [],
        totalErrorCount: 0,
        timeStart: null,
        timeEnd: null
      };

      const CHUNK_SIZE = 10 * 1024 * 1024; // 10MBÏî© ÏùΩÍ∏∞
      let offset = 0;
      let lineNumber = 0;
      let leftover = '';

      // ÏßÑÌñâÏÉÅÌô© ÌëúÏãú
      const loadingProgress = document.getElementById('loadingProgress');
      
      while (offset < file.size) {
        const chunkEnd = Math.min(offset + CHUNK_SIZE, file.size);
        const chunk = file.slice(offset, chunkEnd);
        const text = await chunk.text();
        const combined = leftover + text;
        
        const lines = combined.split('\n');
        
        // ÎßàÏßÄÎßâ ÎùºÏù∏ÏùÄ Îã§Ïùå Ï≤≠ÌÅ¨Î°ú Ïù¥Ïõî (Î∂àÏôÑÏ†ÑÌï† Ïàò ÏûàÏùå)
        if (chunkEnd < file.size) {
          leftover = lines.pop() || '';
        } else {
          leftover = '';
        }

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          lineNumber++;

          // _BIZREQUEST Ï∂îÏ∂ú
          if (line.includes('_BIZREQUEST')) {
            logAnalysisData.totalRequests++;
            
            // UX_ ÏöîÏ≤≠ Ï∂îÏ∂ú
            const uxMatch = line.match(/_BIZREQUEST[:\s]+([A-Z_0-9]+)/);
            if (uxMatch && uxMatch[1].startsWith('UX_')) {
              const reqName = uxMatch[1];
              logAnalysisData.uxRequests[reqName] = (logAnalysisData.uxRequests[reqName] || 0) + 1;
            }
          }

          // Exception Ï∂îÏ∂ú (Exception, Error:) - Î©ÄÌã∞ÎùºÏù∏ ÏßÄÏõê
          if (line.includes('Exception') || line.includes('Error:')) {
            logAnalysisData.totalErrorCount++;
            
            // ÏÉÅÏÑ∏ ÎÇ¥Ïö©ÏùÄ ÏµúÎåÄ 1000Í∞úÎßå Ï†ÄÏû• (ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖòÏö©)
            if (logAnalysisData.errors.length < 1000) {
              // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï∂îÏ∂ú
              const timeMatch = line.match(/(\d{2}:\d{2}:\d{2})/);
              const timestamp = timeMatch ? timeMatch[1] : '';
              
              // Exception ÌÉÄÏûÖ
              let errorType = 'Exception';
              
              // Exception Î≥∏Î¨∏ + Ïä§ÌÉù Ìä∏Î†àÏù¥Ïä§ ÏàòÏßë
              let fullErrorContent = line.trim();
              let additionalLines = 0;
              for (let j = i + 1; j < Math.min(i + 50, lines.length); j++) {
                const nextLine = lines[j].trim();
                // Ïä§ÌÉù Ìä∏Î†àÏù¥Ïä§ ÎùºÏù∏Ïù∏ÏßÄ ÌôïÏù∏
                if (nextLine.startsWith('at ') || 
                    nextLine.startsWith('Caused by:') || 
                    nextLine.startsWith('Suppressed:') || 
                    nextLine.startsWith('...')) {
                  fullErrorContent += '\n' + nextLine;
                  additionalLines++;
                } else if (!nextLine || 
                          /^\d{2}:\d{2}:\d{2}/.test(nextLine) || 
                          /^(?:[A-Z]+\s+)?\[?\d{4}[-\/]\d{2}[-\/]\d{2}[\sT]\d{2}:\d{2}:\d{2}/.test(nextLine)) {
                  break;
                } else {
                  break;
                }
              }
              
              logAnalysisData.errors.push({
                line: lineNumber,
                timestamp: timestamp,
                errorType: errorType,
                content: fullErrorContent,
                lines: additionalLines + 1
              });
              
              i += additionalLines;
              lineNumber += additionalLines;
            }
          }

          // ÏãúÍ∞Ñ Î≤îÏúÑ Ï∂îÏ∂ú
          const timeMatch = line.match(/(\d{2}:\d{2}:\d{2})/);
          if (timeMatch) {
            if (!logAnalysisData.timeStart) {
              logAnalysisData.timeStart = timeMatch[1];
            }
            logAnalysisData.timeEnd = timeMatch[1];
          }
        }

        offset = chunkEnd;
        
        const percent = Math.min(Math.floor((offset / file.size) * 100), 100);
        if (loadingProgress) {
          loadingProgress.textContent = `${percent}%`;
        }
      }
    }

    // Î∂ÑÏÑù Í≤∞Í≥º ÌëúÏãú
    function displayAnalysisResults() {
      document.getElementById('totalRequests').textContent = logAnalysisData.totalRequests.toLocaleString();
      document.getElementById('errorCount').textContent = logAnalysisData.totalErrorCount.toLocaleString();
      
      if (logAnalysisData.timeStart && logAnalysisData.timeEnd) {
        document.getElementById('analysisDuration').textContent = 
          `${logAnalysisData.timeStart} ~ ${logAnalysisData.timeEnd}`;
      }

      // TOP 5 UX_ ÏöîÏ≤≠
      const topRequests = Object.entries(logAnalysisData.uxRequests)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      const topRequestsHTML = topRequests.map((item, index) => `
        <div class="stat-card">
          <h4>${index + 1}. ${item[0]}</h4>
          <div class="stat-value" style="font-size: 20px;">${item[1].toLocaleString()} Ìöå</div>
        </div>
      `).join('');
      
      document.getElementById('topRequests').innerHTML = `
        <div class="detail-stats-grid">${topRequestsHTML || '<p style="color: #888;">UX_ ÏöîÏ≤≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>'}</div>
      `;

      displayErrorPage();
    }

    // ÏóêÎü¨ ÌéòÏù¥ÏßÄ ÌëúÏãú
    function displayErrorPage() {
      const totalPages = Math.ceil(logAnalysisData.errors.length / ERRORS_PER_PAGE);
      const startIdx = (currentErrorPage - 1) * ERRORS_PER_PAGE;
      const endIdx = Math.min(startIdx + ERRORS_PER_PAGE, logAnalysisData.errors.length);
      
      const errorHTML = logAnalysisData.errors.slice(startIdx, endIdx).map(err => {
        const errorColor = '#ff9900';
        return `
          <div class="error-item">
            <div class="error-header">
              <span class="error-type" style="color: ${errorColor};">‚óÜ ${err.errorType}</span>
              <span class="error-line">Line ${err.line}</span>
              ${err.timestamp ? `<span class="error-time">‚è± ${err.timestamp}</span>` : ''}
            </div>
            <div class="error-content">${err.content}</div>
          </div>
        `;
      }).join('');
      
      const errorWarning = logAnalysisData.totalErrorCount > logAnalysisData.errors.length
        ? `<p style="color: #ff6b9d; margin-top: 10px;">‚ö†Ô∏è Ï¥ù ${logAnalysisData.totalErrorCount.toLocaleString()}Í∞ú Exception Ï§ë ${logAnalysisData.errors.length.toLocaleString()}Í∞úÍπåÏßÄ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.</p>` 
        : '';
      
      document.getElementById('errorLogs').innerHTML = (errorHTML || 
        '<p style="color: #888;">ExceptionÏù¥ Î∞úÍ≤¨ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.</p>') + errorWarning;
      
      const pagination = document.getElementById('errorPagination');
      if (logAnalysisData.errors.length > ERRORS_PER_PAGE) {
        pagination.style.display = 'flex';
        document.getElementById('errorPageInfo').textContent = `${currentErrorPage} / ${totalPages}`;
        
        const prevBtn = pagination.querySelector('button:first-child');
        const nextBtn = pagination.querySelector('button:last-child');
        
        prevBtn.disabled = currentErrorPage === 1;
        nextBtn.disabled = currentErrorPage === totalPages;
      } else {
        pagination.style.display = 'none';
      }
    }

    // Ïù¥Ï†Ñ ÌéòÏù¥ÏßÄ
    function prevErrorPage() {
      if (currentErrorPage > 1) {
        currentErrorPage--;
        displayErrorPage();
      }
    }

    // Îã§Ïùå ÌéòÏù¥ÏßÄ
    function nextErrorPage() {
      const totalPages = Math.ceil(logAnalysisData.errors.length / ERRORS_PER_PAGE);
      if (currentErrorPage < totalPages) {
        currentErrorPage++;
        displayErrorPage();
      }
    }

    // Î°úÍ∑∏ Î∂ÑÏÑù ÏôÑÎ£å Ïãú Ï¢ÖÌï©Î∂ÑÏÑù Î≤ÑÌäº ÌëúÏãú
    window.addEventListener('message', function(e) {
      if (e.data && e.data.cmd === 'complete') {
        const detailBtn = document.getElementById('btnDetail');
        if (detailBtn) {
          detailBtn.style.display = 'block';
        }
      }
    });

    // ==================== ÌïôÏäµ Í∏∞Îä• API ====================
    // ÌèêÏáÑÎßù ÏßÅÏ†ë ÌÜµÏã†
    const OPENSEARCH_API_BASE = "http://10.10.22.81:8080";
    const DEFAULT_INDEX = "contest_pm_task";

    // ÏßÑÌñâÎ•† ÌåùÏóÖ ÏÉùÏÑ±
    function createProgressPopup(fileName, fileSizeMB) {
      const popup = document.createElement('div');
      popup.id = 'progressPopup';
      popup.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;
      
      popup.innerHTML = `
        <div style="
          background: #0a0e27;
          border: 2px solid #00ffff;
          border-radius: 10px;
          padding: 40px;
          min-width: 600px;
          box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
        ">
          <h2 style="color: #00ffff; margin-top: 0; text-align: center;">
            ‚óÜ Ï†ÑÏ≤¥ ÌååÏùº Î∂ÑÏÑù Ï§ë ‚óÜ
          </h2>
          <p style="color: #888; text-align: center; margin-bottom: 30px;">
            ÌååÏùº: ${fileName} (${fileSizeMB.toFixed(2)} MB)
          </p>
          
          <div style="margin: 20px 0;">
            <div style="
              background: #000;
              border: 1px solid #00ffff;
              border-radius: 10px;
              height: 30px;
              overflow: hidden;
              position: relative;
            ">
              <div id="progressBar" style="
                background: linear-gradient(90deg, #00ff00, #00ffff);
                height: 100%;
                width: 0%;
                transition: width 0.3s;
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
              "></div>
              <div id="progressText" style="
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: #fff;
                font-weight: bold;
                text-shadow: 0 0 5px #000;
              ">0%</div>
            </div>
          </div>
          
          <p id="progressStatus" style="
            color: #0f0;
            text-align: center;
            margin: 20px 0;
            min-height: 20px;
          ">Ï§ÄÎπÑ Ï§ë...</p>
          
          <div id="progressDetails" style="
            background: #000;
            border: 1px solid #00ffff;
            border-radius: 5px;
            padding: 15px;
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 20px 0;
          "></div>
          
          <div style="display: flex; justify-content: center; gap: 20px; margin-top: 30px;">
            <button id="pauseAnalysisBtn" style="
              padding: 12px 30px;
              background: linear-gradient(90deg, #ffaa00, #ff8800);
              color: #000;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 0 20px rgba(255, 170, 0, 0.5);
            ">‚è∏ ÏùºÏãúÏ†ïÏßÄ</button>
            <button id="cancelAnalysisBtn" style="
              padding: 12px 30px;
              background: linear-gradient(90deg, #ff6b6b, #ff0000);
              color: #fff;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            ">‚úï Ï∑®ÏÜå</button>
          </div>
        </div>
      `;
      
      return popup;
    }

    // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
    function updateProgressPopup(current, total, status) {
      const percentage = Math.floor((current / total) * 100);
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressStatus = document.getElementById('progressStatus');
      const progressDetails = document.getElementById('progressDetails');
      
      if (progressBar) progressBar.style.width = percentage + '%';
      if (progressText) progressText.textContent = percentage + '%';
      if (progressStatus) progressStatus.textContent = status;
      
      // ÏÉÅÏÑ∏ Î°úÍ∑∏ Ï∂îÍ∞Ä
      if (progressDetails) {
        const now = new Date().toLocaleTimeString();
        const logLine = document.createElement('div');
        logLine.textContent = `[${now}] ${status}`;
        progressDetails.appendChild(logLine);
        progressDetails.scrollTop = progressDetails.scrollHeight;
      }
    }

    // ÏûÑÎ≤†Îî© ÏÉùÏÑ± Ìï®Ïàò
    async function embed_query(text) {
      console.log('[embed_query] ÏûÑÎ≤†Îî© ÏÉùÏÑ± ÏãúÏûë:', text.substring(0, 50) + '...');
      
      // ÏÉÅÏÑ∏ ÎîîÎ≤ÑÍπÖ Ï†ïÎ≥¥
      console.log('[DEBUG-EMBED] ===== Execution Context =====');
      console.log('[DEBUG-EMBED] window.location.href:', window.location.href);
      console.log('[DEBUG-EMBED] window.location.origin:', window.location.origin);
      console.log('[DEBUG-EMBED] OPENSEARCH_API_BASE:', OPENSEARCH_API_BASE);
      console.log('[DEBUG-EMBED] Target URL:', `${OPENSEARCH_API_BASE}/embed`);
      console.log('[DEBUG-EMBED] =============================');
      
      try {
        const response = await fetch(`${OPENSEARCH_API_BASE}/embed`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: text })
        });
        
        console.log('[DEBUG-EMBED] Response status:', response.status);
        console.log('[DEBUG-EMBED] Response ok:', response.ok);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('[embed_query] ÏûÑÎ≤†Îî© ÏÉùÏÑ± ÏôÑÎ£å, Î≤°ÌÑ∞ Í∏∏Ïù¥:', data.embedding?.length);
        return data.embedding;
      } catch (error) {
        console.error('[embed_query] ÏûÑÎ≤†Îî© ÏÉùÏÑ± Ïã§Ìå®:', error);
        console.error('[DEBUG-EMBED] Error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        alert('ÏûÑÎ≤†Îî© ÏÉùÏÑ± Ïã§Ìå®: ' + error.message);
        return null;
      }
    }

    // LLM API Ìò∏Ï∂ú Ìï®Ïàò
    async function call_llm_api(prompt, model, silentMode = false, customLimit = null) {
      const limit = customLimit !== null ? customLimit : 4096;
      console.log('[call_llm_api] LLM Ìò∏Ï∂ú ÏãúÏûë, model:', model, 'silentMode:', silentMode, 'limit:', limit);
      
      // ÏÉÅÏÑ∏ ÎîîÎ≤ÑÍπÖ Ï†ïÎ≥¥
      console.log('[DEBUG] ===== Execution Context =====');
      console.log('[DEBUG] window.location.href:', window.location.href);
      console.log('[DEBUG] window.location.origin:', window.location.origin);
      console.log('[DEBUG] window.location.protocol:', window.location.protocol);
      console.log('[DEBUG] document.location.origin:', document.location.origin);
      console.log('[DEBUG] OPENSEARCH_API_BASE:', OPENSEARCH_API_BASE);
      console.log('[DEBUG] Target URL:', `${OPENSEARCH_API_BASE}/vllm_chat`);
      console.log('[DEBUG] Request body:', JSON.stringify({ text: prompt.substring(0, 100) + '...', model: model, limit: limit }));
      console.log('[DEBUG] =============================');
      
      try {
        const response = await fetch(`${OPENSEARCH_API_BASE}/vllm_chat`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            text: prompt, 
            model: model,
            limit: limit
          })
        });
        
        console.log('[DEBUG] Response received');
        console.log('[DEBUG] Response status:', response.status);
        console.log('[DEBUG] Response statusText:', response.statusText);
        console.log('[DEBUG] Response headers:', [...response.headers.entries()]);
        console.log('[DEBUG] Response ok:', response.ok);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('[call_llm_api] LLM ÏùëÎãµ Î∞õÏùå, Í∏∏Ïù¥:', data.content?.length);
        return data.content;
      } catch (error) {
        console.error('[call_llm_api] LLM Ìò∏Ï∂ú Ïã§Ìå®:', error);
        console.error('[DEBUG] Error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        
        // silentModeÍ∞Ä falseÏùº ÎïåÎßå alert ÌëúÏãú
        if (!silentMode) {
          alert('LLM Ìò∏Ï∂ú Ïã§Ìå®: ' + error.message);
        }
        return null;
      }
    }

    // JSON Í≤∞Í≥º ÌåùÏóÖ ÏÉùÏÑ±
    function createJsonResultPopup(jsonResult, fileName) {
      const popup = document.createElement('div');
      popup.id = 'jsonResultPopup';
      popup.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;
      
      popup.innerHTML = `
        <div style="
          background: #0a0e27;
          border: 2px solid #00ffff;
          border-radius: 10px;
          padding: 30px;
          max-width: 90%;
          max-height: 90%;
          overflow: auto;
          box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
        ">
          <h2 style="color: #00ffff; margin-top: 0; text-align: center;">
            ‚óÜ AI Î°úÍ∑∏ Î∂ÑÏÑù Í≤∞Í≥º ‚óÜ
          </h2>
          <p style="color: #888; text-align: center; margin-bottom: 20px;">
            ÌååÏùº: ${fileName}
          </p>
          <pre style="
            background: #000;
            color: #0f0;
            padding: 20px;
            border-radius: 5px;
            overflow: auto;
            max-height: 50vh;
            font-size: 12px;
            border: 1px solid #00ffff;
          ">${JSON.stringify(jsonResult, null, 2)}</pre>
          <div style="display: flex; justify-content: center; gap: 20px; margin-top: 30px;">
            <button id="learnJsonBtn" style="
              padding: 12px 30px;
              background: linear-gradient(90deg, #00ff00, #00cc00);
              color: #000;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
            ">ÌïôÏäµ ÌïòÍ∏∞</button>
            <button id="closeJsonBtn" style="
              padding: 12px 30px;
              background: linear-gradient(90deg, #ff6b6b, #ff0000);
              color: #fff;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            ">Îã´Í∏∞</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(popup);
      
      // Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
      document.getElementById('closeJsonBtn').addEventListener('click', () => {
        popup.remove();
      });
      
      // ÌïôÏäµ ÌïòÍ∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
      document.getElementById('learnJsonBtn').addEventListener('click', async () => {
        console.log('[learnJsonBtn] JSON ÌïôÏäµ ÏãúÏûë');
        
        const learnBtn = document.getElementById('learnJsonBtn');
        learnBtn.disabled = true;
        learnBtn.textContent = 'ÌïôÏäµ Ï§ë...';
        
        try {
          // JSONÏùÑ Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôòÌïòÏó¨ ÏûÑÎ≤†Îî©
          const jsonText = JSON.stringify(jsonResult, null, 2);
          const embedding = await embed_query(jsonText);
          
          if (!embedding) {
            throw new Error('ÏûÑÎ≤†Îî© ÏÉùÏÑ± Ïã§Ìå®');
          }
          
          // Ïù∏Îç±Ïä§Ïóê ÏÇΩÏûÖ
          const response = await fetch(`${OPENSEARCH_API_BASE}/index`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              index: DEFAULT_INDEX,
              document: {
                text: jsonText,
                embedding: embedding,
                file_name: fileName,
                analysis_date: jsonResult.analysis_date || new Date().toISOString().split('T')[0]
              }
            })
          });
          
          const result = await response.json();
          console.log('[learnJsonBtn] ÌïôÏäµ Í≤∞Í≥º:', result);
          
          if (result.result === 'created') {
            alert('ÌïôÏäµÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!\\nDocument ID: ' + result.id);
            popup.remove();
          } else {
            throw new Error('ÌïôÏäµ Ïã§Ìå®');
          }
          
        } catch (error) {
          console.error('[learnJsonBtn] ÌïôÏäµ Ï§ë Ïò§Î•ò:', error);
          alert('ÌïôÏäµ Ïã§Ìå®: ' + error.message);
          learnBtn.disabled = false;
          learnBtn.textContent = 'ÌïôÏäµ ÌïòÍ∏∞';
        }
      });
    }

    // 1. Ïù∏Îç±Ïä§ ÏÉùÏÑ± (contest_pm_task)
    document.addEventListener('DOMContentLoaded', function() {
      const btn1 = document.getElementById('btn_learn_1');
      if (btn1) {
        btn1.addEventListener('click', async function() {
          console.log('[btn_learn_1] Ïù∏Îç±Ïä§ ÏÉùÏÑ± Î≤ÑÌäº ÌÅ¥Î¶≠');
          
          const indexName = DEFAULT_INDEX;
          
          if (!confirm(`Ïù∏Îç±Ïä§ "${indexName}"Î•º ÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
            console.log('[btn_learn_1] Ïù∏Îç±Ïä§ ÏÉùÏÑ± Ï∑®ÏÜåÎê®');
            return;
          }
          
          console.log('[btn_learn_1] Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÏöîÏ≤≠:', indexName);
          
          try {
            const response = await fetch(`${OPENSEARCH_API_BASE}/index_create`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                index: indexName, 
                body: {} 
              })
            });
            
            const result = await response.json();
            console.log('[btn_learn_1] Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÏùëÎãµ:', result);
            
            alert(result.message || 'Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÏôÑÎ£å: ' + indexName);
          } catch (error) {
            console.error('[btn_learn_1] Ïù∏Îç±Ïä§ ÏÉùÏÑ± Ïã§Ìå®:', error);
            alert('Ïù∏Îç±Ïä§ ÏÉùÏÑ± Ïã§Ìå®: ' + error.message);
          }
        });
      }
      
      // 2. AI Î°úÍ∑∏ Î∂ÑÏÑù ÌõÑ ÌïôÏäµ
      const btn2 = document.getElementById('btn_learn_2');
      if (btn2) {
        btn2.addEventListener('click', async function() {
          console.log('[btn_learn_2] AI Î°úÍ∑∏ Î∂ÑÏÑù Î≤ÑÌäº ÌÅ¥Î¶≠');
          
          // ÌååÏùº ÏóÖÎ°úÎìú input ÏÉùÏÑ±
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = '.txt,.log';
          
          fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            console.log('[btn_learn_2] ÌååÏùº ÏÑ†ÌÉùÎê®:', file.name, 'ÌÅ¨Í∏∞:', file.size, 'bytes');
            
            // Î∂ÑÏÑù Î™®Îìú ÏÑ†ÌÉù
            const fileSizeMB = file.size / (1024 * 1024);
            let useChunkAnalysis = false;
            
            if (fileSizeMB > 9) {
              const choice = confirm(
                `ÌååÏùº ÌÅ¨Í∏∞: ${fileSizeMB.toFixed(2)} MB\n\n` +
                `Ï†ÑÏ≤¥ ÌååÏùº Î∂ÑÏÑù Î™®ÎìúÎ•º ÏÇ¨Ïö©ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n` +
                `[ÌôïÏù∏] Ï†ÑÏ≤¥ Î∂ÑÏÑù (${Math.ceil(fileSizeMB / 9)}Í∞ú Ï≤≠ÌÅ¨, ÏïΩ ${Math.ceil(fileSizeMB / 9 * 0.3)}Î∂Ñ ÏÜåÏöî)\n` +
                `[Ï∑®ÏÜå] ÏÉòÌîåÎßÅ Î∂ÑÏÑù (Îπ†Î¶Ñ, ÏïΩ 1Î∂Ñ ÏÜåÏöî)`
              );
              useChunkAnalysis = choice;
            }
            
            try {
              const analysisDate = new Date().toISOString().split('T')[0];
              
              if (useChunkAnalysis) {
                // ========== Ï≤≠ÌÅ¨ Í∏∞Î∞ò Ï†ÑÏ≤¥ Î∂ÑÏÑù ==========
                console.log('[btn_learn_2] Ï≤≠ÌÅ¨ Í∏∞Î∞ò Ï†ÑÏ≤¥ Î∂ÑÏÑù ÏãúÏûë');
                
                // ÏßÑÌñâÎ•† ÌåùÏóÖ ÏÉùÏÑ±
                const progressPopup = createProgressPopup(file.name, fileSizeMB);
                document.body.appendChild(progressPopup);
                
                const CHUNK_SIZE = 9 * 1024 * 1024; // 9MB (API Ï†úÌïú 10MB ÎØ∏Îßå)
                const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
                console.log('[btn_learn_2] Ï¥ù Ï≤≠ÌÅ¨ Ïàò:', totalChunks);
                
                let isPaused = false;
                let isCancelled = false;
                const chunkStats = [];
                
                // ÏùºÏãúÏ†ïÏßÄ Î≤ÑÌäº
                document.getElementById('pauseAnalysisBtn').addEventListener('click', () => {
                  isPaused = !isPaused;
                  const btn = document.getElementById('pauseAnalysisBtn');
                  btn.textContent = isPaused ? '‚ñ∂ Ïû¨Í∞ú' : '‚è∏ ÏùºÏãúÏ†ïÏßÄ';
                  console.log('[btn_learn_2] Î∂ÑÏÑù', isPaused ? 'ÏùºÏãúÏ†ïÏßÄ' : 'Ïû¨Í∞ú');
                });
                
                // Ï∑®ÏÜå Î≤ÑÌäº
                document.getElementById('cancelAnalysisBtn').addEventListener('click', () => {
                  if (confirm('Ï†ïÎßê Î∂ÑÏÑùÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    isCancelled = true;
                    console.log('[btn_learn_2] Î∂ÑÏÑù Ï∑®ÏÜåÎê®');
                  }
                });
                
                // Í∞Å Ï≤≠ÌÅ¨ Î∂ÑÏÑù
                for (let i = 0; i < totalChunks; i++) {
                  // ÏùºÏãúÏ†ïÏßÄ ÎåÄÍ∏∞
                  while (isPaused && !isCancelled) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                  }
                  
                  // Ï∑®ÏÜå ÌôïÏù∏
                  if (isCancelled) {
                    progressPopup.remove();
                    alert('Î∂ÑÏÑùÏù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.');
                    return;
                  }
                  
                  const start = i * CHUNK_SIZE;
                  const end = Math.min(start + CHUNK_SIZE, file.size);
                  const chunk = file.slice(start, end);
                  
                  console.log(`[btn_learn_2] Ï≤≠ÌÅ¨ ${i+1}/${totalChunks} ÏùΩÍ∏∞ ÏãúÏûë (${start}-${end})`);
                  
                  // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
                  updateProgressPopup(i + 1, totalChunks, 'Ï≤≠ÌÅ¨ ÏùΩÎäî Ï§ë...');
                  
                  const chunkText = await chunk.text();
                  
                  // ÏßÑÌñâ ÏÉÅÌô© Î°úÍ∑∏ Ï∂îÍ∞Ä
                  const detailsDiv = document.getElementById('progressDetails');
                  if (detailsDiv) {
                    const time = new Date().toLocaleTimeString();
                    detailsDiv.innerHTML += `[${time}] Ï≤≠ÌÅ¨ ${i+1}/${totalChunks} ÏùΩÍ∏∞ ÏôÑÎ£å (${(chunkText.length / 1024).toFixed(1)} KB)<br>`;
                    detailsDiv.scrollTop = detailsDiv.scrollHeight;
                  }
                  
                  // Ï≤≠ÌÅ¨Î≥Ñ ÌÜµÍ≥Ñ Ï∂îÏ∂ú ÌîÑÎ°¨ÌîÑÌä∏ (API Ï†úÌïúÏùÑ Í≥†Î†§Ìïú ÌÅ¨Í∏∞)
                  // ÌîÑÎ°¨ÌîÑÌä∏ ÏûêÏ≤¥ + Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞Í∞Ä 9MB Ïù¥ÌïòÏó¨Ïïº Ìï®
                  const maxLogSize = 8 * 1024 * 1024; // 8MB (ÌîÑÎ°¨ÌîÑÌä∏ ÌÖçÏä§Ìä∏ Ïó¨Ïú† Í≥µÍ∞Ñ ÌôïÎ≥¥)
                  const safeChunkText = chunkText.length > maxLogSize ? chunkText.substring(0, maxLogSize) : chunkText;
                  
                  const chunkPrompt = `Îã§Ïùå Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÌÜµÍ≥ÑÎ•º Ï∂îÏ∂úÌïòÏÑ∏Ïöî. Î∞òÎìúÏãú JSON ÌòïÏãùÏúºÎ°úÎßå ÎãµÎ≥ÄÌïòÏÑ∏Ïöî.

Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞:
${safeChunkText}

Ï∂îÏ∂úÌï† ÌÜµÍ≥Ñ (JSON ÌòïÏãù):
{
  "chunk_number": ${i+1},
  "total_requests": 0,
  "bizrequest_services": {},
  "hourly_usage": {},
  "users": {},
  "devices": {},
  "locations": {},
  "errors": []
}

ÏÑ§Î™Ö:
- total_requests: _BIZREQUESTÍ∞Ä Ìè¨Ìï®Îêú ÎùºÏù∏ Ïàò
- bizrequest_services: {ÏÑúÎπÑÏä§Î™Ö: ÌöüÏàò} ÌòïÌÉú
- hourly_usage: {ÏãúÍ∞ÑÎåÄ: ÌöüÏàò} ÌòïÌÉú (00~23Ïãú)
- users: {ÏÇ¨Ïö©ÏûêÎ™Ö: ÌöüÏàò} ÌòïÌÉú (PUM_USER_NAME)
- devices: {Í∏∞Í∏∞Î™®Îç∏: ÌöüÏàò} ÌòïÌÉú (DEV_MODEL)
- locations: {ÏßÄÏó≠ÏΩîÎìú: ÌöüÏàò} ÌòïÌÉú (PNM_LOCATION_CD)
- errors: [ÏóêÎü¨Î©îÏãúÏßÄÎì§] ÌòïÌÉú (ERROR, Exception Ìè¨Ìï®)

JSONÎßå ÎãµÎ≥ÄÌïòÏÑ∏Ïöî.`;
                  
                  updateProgressPopup(i + 1, totalChunks, `Ï≤≠ÌÅ¨ ${i+1} Î∂ÑÏÑù Ï§ë...`);
                  
                  try {
                    // ÏßÑÌñâ Î°úÍ∑∏
                    if (detailsDiv) {
                      const time = new Date().toLocaleTimeString();
                      detailsDiv.innerHTML += `[${time}] Ï≤≠ÌÅ¨ ${i+1} AI Î∂ÑÏÑù ÏöîÏ≤≠ Ï§ë...<br>`;
                      detailsDiv.scrollTop = detailsDiv.scrollHeight;
                    }
                    
                    const chunkResponse = await call_llm_api(chunkPrompt, 'qwen', true); // silentMode = true (ÏóêÎü¨ ÏïåÎ¶º Î¨¥Ïãú)
                    
                    if (chunkResponse) {
                      // JSON ÌååÏã±
                      let chunkStat;
                      try {
                        const jsonMatch = chunkResponse.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                          chunkStat = JSON.parse(jsonMatch[0]);
                        } else {
                          chunkStat = JSON.parse(chunkResponse);
                        }
                        chunkStats.push(chunkStat);
                        console.log(`[btn_learn_2] Ï≤≠ÌÅ¨ ${i+1} Î∂ÑÏÑù ÏôÑÎ£å:`, chunkStat);
                        
                        // ÏÑ±Í≥µ Î°úÍ∑∏
                        if (detailsDiv) {
                          const time = new Date().toLocaleTimeString();
                          detailsDiv.innerHTML += `[${time}] ‚úÖ Ï≤≠ÌÅ¨ ${i+1} Î∂ÑÏÑù ÏôÑÎ£å (Ï¥ù ${chunkStats.length}Í∞ú ÏôÑÎ£å)<br>`;
                          detailsDiv.scrollTop = detailsDiv.scrollHeight;
                        }
                      } catch (parseError) {
                        console.error(`[btn_learn_2] Ï≤≠ÌÅ¨ ${i+1} JSON ÌååÏã± Ïã§Ìå®:`, parseError);
                        chunkStats.push({ chunk_number: i+1, error: 'JSON ÌååÏã± Ïã§Ìå®', raw: chunkResponse.substring(0, 500) });
                        
                        // ÌååÏã± Ïã§Ìå® Î°úÍ∑∏
                        if (detailsDiv) {
                          const time = new Date().toLocaleTimeString();
                          detailsDiv.innerHTML += `[${time}] ‚ö†Ô∏è Ï≤≠ÌÅ¨ ${i+1} JSON ÌååÏã± Ïã§Ìå®, ÏõêÎ≥∏ Ï†ÄÏû•<br>`;
                          detailsDiv.scrollTop = detailsDiv.scrollHeight;
                        }
                      }
                    } else {
                      // ÏùëÎãµÏù¥ nullÏù∏ Í≤ΩÏö∞ (500 ÏóêÎü¨, fetch Ïã§Ìå® Îì±)
                      console.warn(`[btn_learn_2] Ï≤≠ÌÅ¨ ${i+1} ÏùëÎãµ ÏóÜÏùå, Í±¥ÎÑàÎúÄ`);
                      chunkStats.push({ chunk_number: i+1, error: 'API Ìò∏Ï∂ú Ïã§Ìå® (Î¨¥ÏãúÎê®)', skipped: true });
                      
                      // Í±¥ÎÑàÎõ∞Í∏∞ Î°úÍ∑∏
                      if (detailsDiv) {
                        const time = new Date().toLocaleTimeString();
                        detailsDiv.innerHTML += `[${time}] ‚è≠Ô∏è Ï≤≠ÌÅ¨ ${i+1} Í±¥ÎÑàÎúÄ (API Ïò§Î•ò, Í≥ÑÏÜç ÏßÑÌñâ)<br>`;
                        detailsDiv.scrollTop = detailsDiv.scrollHeight;
                      }
                    }
                  } catch (error) {
                    // try-catchÎ°ú Ïû°Ìûå ÏòàÏô∏ÎèÑ Î¨¥ÏãúÌïòÍ≥† Í≥ÑÏÜç ÏßÑÌñâ
                    console.warn(`[btn_learn_2] Ï≤≠ÌÅ¨ ${i+1} ÏòàÏô∏ Î∞úÏÉù, Î¨¥ÏãúÌïòÍ≥† Í≥ÑÏÜç:`, error);
                    chunkStats.push({ chunk_number: i+1, error: error.message, skipped: true });
                    
                    // Í±¥ÎÑàÎõ∞Í∏∞ Î°úÍ∑∏ (Í≤ΩÍ≥† ÏàòÏ§Ä)
                    if (detailsDiv) {
                      const time = new Date().toLocaleTimeString();
                      detailsDiv.innerHTML += `[${time}] ‚è≠Ô∏è Ï≤≠ÌÅ¨ ${i+1} Í±¥ÎÑàÎúÄ (${error.message})<br>`;
                      detailsDiv.scrollTop = detailsDiv.scrollHeight;
                    }
                  }
                  
                  updateProgressPopup(i + 1, totalChunks, `Ï≤≠ÌÅ¨ ${i+1}/${totalChunks} ÏôÑÎ£å`);
                }
                
                // ÏµúÏ¢Ö Ï¢ÖÌï© Î∂ÑÏÑù
                console.log('[btn_learn_2] Î™®Îì† Ï≤≠ÌÅ¨ Î∂ÑÏÑù ÏôÑÎ£å, ÏµúÏ¢Ö Ï¢ÖÌï© ÏãúÏûë');
                updateProgressPopup(totalChunks, totalChunks, 'ÏµúÏ¢Ö Ï¢ÖÌï© Î∂ÑÏÑù Ï§ë...');
                
                // ÏµúÏ¢Ö Î∂ÑÏÑù ÏãúÏûë Î°úÍ∑∏
                const detailsDiv = document.getElementById('progressDetails');
                if (detailsDiv) {
                  const time = new Date().toLocaleTimeString();
                  detailsDiv.innerHTML += `<br>[${time}] üìä Î™®Îì† Ï≤≠ÌÅ¨ Î∂ÑÏÑù ÏôÑÎ£å! (${chunkStats.length}/${totalChunks})<br>`;
                  detailsDiv.innerHTML += `[${time}] üîÑ ÏµúÏ¢Ö Ï¢ÖÌï© Î∂ÑÏÑù ÏãúÏûë (ÏïΩ 1~2Î∂Ñ ÏÜåÏöî)...<br>`;
                  detailsDiv.scrollTop = detailsDiv.scrollHeight;
                }
                
                const finalPrompt = `Îã§ÏùåÏùÄ ${totalChunks}Í∞ú Ï≤≠ÌÅ¨Ïùò ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ÏûÖÎãàÎã§. Ïù¥Î•º Ï¢ÖÌï©ÌïòÏó¨ ÏµúÏ¢Ö Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏Î•º JSON ÌòïÏãùÏúºÎ°ú ÏûëÏÑ±ÌïòÏÑ∏Ïöî.

Ï≤≠ÌÅ¨ ÌÜµÍ≥Ñ:
${JSON.stringify(chunkStats, null, 2).substring(0, 8000000)}

ÏµúÏ¢Ö Î∂ÑÏÑù JSON ÌòïÏãù:
{
  "analysis_date": "${analysisDate}",
  "log_file": "${file.name}",
  "total_file_size_mb": ${fileSizeMB.toFixed(2)},
  "total_chunks_analyzed": ${totalChunks},
  "analysis_request": {
    "Î°úÍ∑∏ Î∂ÑÏÑù Ïù∏ÏÇ¨Ïù¥Ìä∏": {
      "ÏÇ¨Ïö©Ïûê ÌñâÎèô Ìå®ÌÑ¥ Î∂ÑÏÑù": {
        "Ï£ºÏöî ÏÇ¨Ïö© ÏÑúÎπÑÏä§": "Î™®Îì† Ï≤≠ÌÅ¨Ïùò bizrequest_servicesÎ•º Ìï©ÏÇ∞ÌïòÏó¨ ÏÉÅÏúÑ 5Í∞ú ÏÑúÎπÑÏä§ÏôÄ ÏöîÏ≤≠ Í±¥Ïàò",
        "ÏãúÍ∞ÑÎåÄÎ≥Ñ ÏÇ¨Ïö©Îüâ": "Î™®Îì† Ï≤≠ÌÅ¨Ïùò hourly_usageÎ•º Ìï©ÏÇ∞ÌïòÏó¨ ÏãúÍ∞ÑÎåÄÎ≥Ñ Î∂ÑÌè¨",
        "ÏÇ¨Ïö©ÏûêÎ≥Ñ ÏÑúÎπÑÏä§ Ïù¥Ïö© ÌòÑÌô©": "Î™®Îì† Ï≤≠ÌÅ¨Ïùò usersÎ•º Ìï©ÏÇ∞ÌïòÏó¨ ÏÉÅÏúÑ 3Î™Ö",
        "Í∏∞Í∏∞ Ï†ïÎ≥¥": "Î™®Îì† Ï≤≠ÌÅ¨Ïùò devicesÎ•º Ìï©ÏÇ∞ÌïòÏó¨ ÏÉÅÏúÑ 3Í∞ú Í∏∞Í∏∞"
      },
      "ÏÑúÎπÑÏä§ ÏÇ¨Ïö© ÌòÑÌô© Î∂ÑÏÑù": {
        "Ï¥ù ÏöîÏ≤≠ Í±¥Ïàò": "Î™®Îì† Ï≤≠ÌÅ¨Ïùò total_requests Ìï©Í≥Ñ",
        "ÏúÑÏπò Í∏∞Î∞ò ÏÑúÎπÑÏä§ Î∂ÑÏÑù": "Î™®Îì† Ï≤≠ÌÅ¨Ïùò locationsÎ•º Ìï©ÏÇ∞ÌïòÏó¨ ÏÉÅÏúÑ 3Í∞ú ÏßÄÏó≠",
        "ÏùºÏùº ÌÜµÍ≥Ñ": "Ï†ÑÏ≤¥ ÏöîÏ≤≠ ÏàòÏôÄ Ï£ºÏöî ÏÑúÎπÑÏä§ ÏöîÏïΩ"
      },
      "ÏãúÏä§ÌÖú ÏÑ±Îä• Î∞è Ïò§Î•ò Î∂ÑÏÑù": {
        "Ïò§Î•ò Î∞úÏÉù ÌòÑÌô©": "Î™®Îì† Ï≤≠ÌÅ¨Ïùò errorsÎ•º Ï¢ÖÌï©ÌïòÏó¨ Ïò§Î•ò Ï¢ÖÎ•òÏôÄ ÎπàÎèÑ"
      }
    }
  }
}

Î∞òÎìúÏãú JSON ÌòïÏãùÏúºÎ°úÎßå ÎãµÎ≥ÄÌïòÏÑ∏Ïöî.`;
                
                // Îçî Í∏¥ ÏùëÎãµÏùÑ Î∞õÍ∏∞ ÏúÑÌï¥ limit Ï¶ùÍ∞Ä (4096 -> 16384)
                const finalResponse = await call_llm_api(finalPrompt, 'qwen', false, 16384);
                
                if (!finalResponse) {
                  progressPopup.remove();
                  throw new Error('ÏµúÏ¢Ö Ï¢ÖÌï© Î∂ÑÏÑù Ïã§Ìå®');
                }
                
                console.log('[btn_learn_2] ÏµúÏ¢Ö LLM ÏùëÎãµ:', finalResponse);
                
                // ÏµúÏ¢Ö Î∂ÑÏÑù ÏôÑÎ£å Î°úÍ∑∏
                if (detailsDiv) {
                  const time = new Date().toLocaleTimeString();
                  detailsDiv.innerHTML += `[${time}] ‚úÖ ÏµúÏ¢Ö Ï¢ÖÌï© Î∂ÑÏÑù ÏôÑÎ£å!<br>`;
                  detailsDiv.innerHTML += `[${time}] üìù Í≤∞Í≥º ÌååÏã± Ï§ë...<br>`;
                  detailsDiv.scrollTop = detailsDiv.scrollHeight;
                }
                
                // Ïû†Ïãú ÎåÄÍ∏∞ ÌõÑ ÌåùÏóÖ Îã´Í∏∞
                await new Promise(resolve => setTimeout(resolve, 1000));
                progressPopup.remove();
                
                // JSON ÌååÏã±
                let jsonResult;
                try {
                  const jsonMatch = finalResponse.match(/\{[\s\S]*\}/);
                  if (jsonMatch) {
                    jsonResult = JSON.parse(jsonMatch[0]);
                  } else {
                    jsonResult = JSON.parse(finalResponse);
                  }
                } catch (parseError) {
                  console.error('[btn_learn_2] ÏµúÏ¢Ö JSON ÌååÏã± Ïã§Ìå®:', parseError);
                  jsonResult = {
                    analysis_date: analysisDate,
                    log_file: file.name,
                    raw_response: finalResponse,
                    chunk_stats: chunkStats
                  };
                }
                
                // Í≤∞Í≥º ÌåùÏóÖ ÌëúÏãú
                createJsonResultPopup(jsonResult, file.name);
                
              } else {
                // ========== Í∏∞Ï°¥ ÏÉòÌîåÎßÅ Î∂ÑÏÑù ==========
                console.log('[btn_learn_2] ÏÉòÌîåÎßÅ Î∂ÑÏÑù ÏãúÏûë');
                
                const SAMPLE_SIZE = 100 * 1024; // 100KB
                let logSample = '';
                
                if (file.size > SAMPLE_SIZE) {
                  const blob = file.slice(0, SAMPLE_SIZE);
                  logSample = await blob.text();
                  console.log('[btn_learn_2] ÏÉòÌîå ÌÅ¨Í∏∞:', logSample.length, 'bytes');
                } else {
                  logSample = await file.text();
                  console.log('[btn_learn_2] Ï†ÑÏ≤¥ ÌååÏùº ÏùΩÍ∏∞ ÏôÑÎ£å:', logSample.length, 'bytes');
                }
                
                const logForAnalysis = logSample.substring(0, 50000);
                
                const prompt = `Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞Î•º ÏûêÏÑ∏Ìûà Î∂ÑÏÑùÌïú ÌõÑ Îã§Ïùå JSON ÌòïÏãùÏúºÎ°ú ÎãµÎ≥ÄÌï¥Ï£ºÏÑ∏Ïöî.

Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ (ÏÉòÌîå):
${logForAnalysis}

ÏöîÏ≤≠ÌïòÎäî JSON ÌòïÏãù:
{
  "analysis_date": "${analysisDate}",
  "log_file": "${file.name}",
  "analysis_request": {
    "Î°úÍ∑∏ Î∂ÑÏÑù Ïù∏ÏÇ¨Ïù¥Ìä∏": {
      "ÏÇ¨Ïö©Ïûê ÌñâÎèô Ìå®ÌÑ¥ Î∂ÑÏÑù": {
        "Ï£ºÏöî ÏÇ¨Ïö© ÏÑúÎπÑÏä§": "Î°úÍ∑∏ÏóêÏÑú '_BIZREQUEST' ÌïÑÎìúÎ•º Î∂ÑÏÑùÌïòÏó¨ Í∞ÄÏû• ÎßéÏù¥ ÏÇ¨Ïö©Îêú ÏÑúÎπÑÏä§ ÏÉÅÏúÑ 5Í∞úÎ•º ÏãùÎ≥ÑÌïòÍ≥†, Í∞Å ÏÑúÎπÑÏä§Ïùò ÏöîÏ≤≠ Í±¥ÏàòÎ•º Ìè¨Ìï®ÌïòÏó¨ Í≤∞Í≥ºÎ•º Ï†úÏãúÌï¥Ï§ò.",
        "ÏãúÍ∞ÑÎåÄÎ≥Ñ ÏÇ¨Ïö©Îüâ": "Î°úÍ∑∏ ÏÉùÏÑ± ÏãúÍ∞ÑÏùÑ Í∏∞Ï§ÄÏúºÎ°ú ÏãúÍ∞ÑÎåÄÎ≥Ñ(00Ïãú, 01Ïãú, ..., 23Ïãú) ÏÑúÎπÑÏä§ ÏöîÏ≤≠ Í±¥ÏàòÎ•º Î∂ÑÏÑùÌïòÍ≥†, ÏÇ¨Ïö©ÎüâÏù¥ Í∞ÄÏû• ÎßéÏùÄ ÏãúÍ∞ÑÎåÄÏôÄ Í∞ÄÏû• Ï†ÅÏùÄ ÏãúÍ∞ÑÎåÄÎ•º ÏïåÎ†§Ï§ò.",
        "ÏÇ¨Ïö©ÏûêÎ≥Ñ ÏÑúÎπÑÏä§ Ïù¥Ïö© ÌòÑÌô©": "'PUM_USER_NAME' ÌïÑÎìúÎ•º Í∏∞Ï§ÄÏúºÎ°ú Í∞ÄÏû• ÏöîÏ≤≠Ïù¥ ÎßéÏïòÎçò ÏÇ¨Ïö©Ïûê ÏÉÅÏúÑ 3Î™ÖÏùÑ ÏãùÎ≥ÑÌïòÍ≥†, Í∞Å ÏÇ¨Ïö©ÏûêÏùò Ï¥ù ÏöîÏ≤≠ Í±¥ÏàòÎ•º ÏïåÎ†§Ï§ò.",
        "Í∏∞Í∏∞ Ï†ïÎ≥¥": "'DEV_MODEL'Í≥º 'DEV_TELECOM' ÌïÑÎìúÎ•º Î∂ÑÏÑùÌïòÏó¨ Í∞ÄÏû• ÎßéÏù¥ ÏÇ¨Ïö©Îêú Í∏∞Í∏∞ Î™®Îç∏ ÏÉÅÏúÑ 3Í∞úÏôÄ ÌÜµÏã†ÏÇ¨Î≥Ñ Ï†êÏú†Ïú®ÏùÑ Î∂ÑÏÑùÌï¥Ï§ò."
      },
      "ÏÑúÎπÑÏä§ ÏÇ¨Ïö© ÌòÑÌô© Î∂ÑÏÑù": {
        "ÏöîÏ≤≠ Í±¥Ïàò Î∞è Ï¢ÖÎ•ò": "Î°úÍ∑∏ ÌååÏùº Ï†ÑÏ≤¥Ïùò Ï¥ù ÏöîÏ≤≠ Í±¥ÏàòÎ•º Í≥ÑÏÇ∞ÌïòÍ≥†, ÏÑúÎπÑÏä§ Ï¢ÖÎ•òÎ≥Ñ ÏöîÏ≤≠ Í±¥ÏàòÏôÄ ÎπÑÏú®ÏùÑ Î∂ÑÏÑùÌï¥Ï§ò.",
        "ÏúÑÏπò Í∏∞Î∞ò ÏÑúÎπÑÏä§ Î∂ÑÏÑù": "'PNM_LOCATION_CD' ÌïÑÎìúÎ•º Í∏∞Ï§ÄÏúºÎ°ú ÏßÄÏó≠ ÏΩîÎìúÎ≥Ñ ÏöîÏ≤≠ Í±¥ÏàòÎ•º Î∂ÑÏÑùÌïòÍ≥†, Í∞ÄÏû• ÏöîÏ≤≠Ïù¥ ÎßéÏïòÎçò ÏÉÅÏúÑ 3Í∞ú ÏßÄÏó≠ÏùÑ ÏïåÎ†§Ï§ò.",
        "ÏõîÎ≥Ñ/ÏùºÎ≥Ñ ÌÜµÍ≥Ñ": "Ïù¥ Î°úÍ∑∏Îäî '${analysisDate}'Ïóê Ìï¥ÎãπÌïòÎäî ÏùºÏùº ÌÜµÍ≥ÑÏûÑÏùÑ Î™ÖÏãúÌïòÍ≥†, Ï£ºÏöî ÌÜµÍ≥Ñ(Ï¥ù ÏöîÏ≤≠ Ïàò, ÏÉÅÏúÑ ÏÑúÎπÑÏä§)Î•º ÏöîÏïΩÌï¥Ï§ò."
      },
      "ÏãúÏä§ÌÖú ÏÑ±Îä• Î∞è Ïò§Î•ò Î∂ÑÏÑù": {
        "ÏùëÎãµ ÏãúÍ∞Ñ": "Î°úÍ∑∏Ïùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎ•º Î∂ÑÏÑùÌïòÏó¨ ÌèâÍ∑† ÏùëÎãµ ÏãúÍ∞ÑÏùÑ Ï∂îÏ†ïÌïòÍ≥†, ÏùëÎãµ ÏãúÍ∞ÑÏù¥ Ïú†ÎèÖ Í∏∏ÏóàÎçò(Ïòà: 5Ï¥à Ïù¥ÏÉÅ) ÏöîÏ≤≠Ïù¥ ÏûàÏóàÎäîÏßÄ ÏãùÎ≥ÑÌï¥Ï§ò.",
        "Ïò§Î•ò Î∞úÏÉù ÌòÑÌô©": "Î°úÍ∑∏ ÎÇ¥Ïö©ÏóêÏÑú 'ERROR' ÎòêÎäî 'Exception' ÌÇ§ÏõåÎìúÎ•º Ìè¨Ìï®Ìïú Î°úÍ∑∏Î•º Ï∞æÏïÑÎÇ¥Í≥†, Î∞úÏÉùÌïú Ïò§Î•òÏùò Ï¢ÖÎ•òÏôÄ ÎπàÎèÑÎ•º ÏöîÏïΩÌï¥Ï§ò."
      }
    }
  }
}

Î∞òÎìúÏãú JSON ÌòïÏãùÏúºÎ°úÎßå ÎãµÎ≥ÄÌï¥Ï£ºÏÑ∏Ïöî.`;

              console.log('[btn_learn_2] LLM API Ìò∏Ï∂ú ÏãúÏûë...');
              alert('AIÍ∞Ä Î°úÍ∑∏Î•º Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§...\nÏãúÍ∞ÑÏù¥ Îã§ÏÜå Í±∏Î¶¥ Ïàò ÏûàÏäµÎãàÎã§.');
              
              // LLM API Ìò∏Ï∂ú
              const llmResponse = await call_llm_api(prompt, 'qwen');
              
              if (!llmResponse) {
                throw new Error('LLM ÏùëÎãµÏùÑ Î∞õÏßÄ Î™ªÌñàÏäµÎãàÎã§.');
              }
              
              console.log('[btn_learn_2] LLM ÏùëÎãµ:', llmResponse);
              
              // JSON ÌååÏã± ÏãúÎèÑ
              let jsonResult;
              try {
                // JSON Î∂ÄÎ∂ÑÎßå Ï∂îÏ∂ú (``` Ï†úÍ±∞)
                let jsonText = llmResponse;
                const jsonMatch = llmResponse.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  jsonText = jsonMatch[0];
                }
                jsonResult = JSON.parse(jsonText);
              } catch (parseError) {
                console.error('[btn_learn_2] JSON ÌååÏã± Ïã§Ìå®:', parseError);
                // ÌååÏã± Ïã§Ìå® Ïãú ÏõêÎ≥∏ ÏùëÎãµÏùÑ JSONÏúºÎ°ú Í∞êÏã∏Í∏∞
                jsonResult = {
                  analysis_date: analysisDate,
                  log_file: file.name,
                  raw_response: llmResponse
                };
              }
              
              // JSON Í≤∞Í≥º ÌåùÏóÖ ÌëúÏãú
              createJsonResultPopup(jsonResult, file.name);
              }
              
            } catch (error) {
              console.error('[btn_learn_2] AI Î∂ÑÏÑù Ï§ë Ïò§Î•ò:', error);
              alert('AI Î∂ÑÏÑù Ïã§Ìå®: ' + error.message);
            }
          });
          
          fileInput.click();
        });
      }
      
      // 3. Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ
      const btn3 = document.getElementById('btn_learn_3');
      if (btn3) {
        btn3.addEventListener('click', async function() {
          console.log('[btn_learn_3] Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ Î≤ÑÌäº ÌÅ¥Î¶≠');
          
          if (!mainModel.logfile) {
            alert('Î®ºÏ†Ä Î°úÍ∑∏ ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî!');
            console.log('[btn_learn_3] Î°úÍ∑∏ ÌååÏùº ÏóÜÏùå');
            return;
          }
          
          const indexName = prompt('Îç∞Ïù¥ÌÑ∞Î•º ÏÇΩÏûÖÌï† Ïù∏Îç±Ïä§ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', 'contest_pm_task');
          if (!indexName) {
            console.log('[btn_learn_3] Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ Ï∑®ÏÜåÎê®');
            return;
          }
          
          console.log('[btn_learn_3] Î°úÍ∑∏ ÌååÏùº ÏùΩÍ∏∞ ÏãúÏûë:', mainModel.logfile.name);
          
          try {
            // Î°úÍ∑∏ ÌååÏùº ÏùΩÍ∏∞
            const logText = await mainModel.logfile.text();
            console.log('[btn_learn_3] Î°úÍ∑∏ ÌååÏùº ÌÅ¨Í∏∞:', logText.length, 'bytes');
            
            // Ï≤≠ÌÅ¨ ÌÅ¨Í∏∞ ÏÑ§Ï†ï (1000Ïûê Îã®ÏúÑÎ°ú Î∂ÑÌï†)
            const CHUNK_SIZE = 1000;
            const chunks = [];
            
            for (let i = 0; i < logText.length; i += CHUNK_SIZE) {
              chunks.push(logText.substring(i, i + CHUNK_SIZE));
            }
            
            console.log('[btn_learn_3] Ï¥ù Ï≤≠ÌÅ¨ Ïàò:', chunks.length);
            
            if (!confirm(`Ï¥ù ${chunks.length}Í∞úÏùò Ï≤≠ÌÅ¨Î°ú Î∂ÑÌï†Îê©ÎãàÎã§.\nÍ≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
              console.log('[btn_learn_3] ÏÇ¨Ïö©Ïûê Ï∑®ÏÜå');
              return;
            }
            
            // Í∞Å Ï≤≠ÌÅ¨Î•º Ïù∏Îç±Ïä§Ïóê ÏÇΩÏûÖ
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < chunks.length; i++) {
              const chunk = chunks[i];
              console.log(`[btn_learn_3] Ï≤≠ÌÅ¨ ${i+1}/${chunks.length} Ï≤òÎ¶¨ Ï§ë...`);
              
              // ÏûÑÎ≤†Îî© ÏÉùÏÑ±
              const embedding = await embed_query(chunk);
              
              if (!embedding) {
                console.error(`[btn_learn_3] Ï≤≠ÌÅ¨ ${i+1} ÏûÑÎ≤†Îî© Ïã§Ìå®`);
                failCount++;
                continue;
              }
              
              // Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ
              const response = await fetch(`${OPENSEARCH_API_BASE}/index`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  index: indexName,
                  document: {
                    text: chunk,
                    embedding: embedding
                  }
                })
              });
              
              const result = await response.json();
              console.log(`[btn_learn_3] Ï≤≠ÌÅ¨ ${i+1} ÏÇΩÏûÖ Í≤∞Í≥º:`, result);
              
              if (result.result === 'created') {
                successCount++;
              } else {
                failCount++;
              }
              
              // ÏßÑÌñâÎ•† ÌëúÏãú (10Í∞úÎßàÎã§)
              if ((i + 1) % 10 === 0) {
                console.log(`[btn_learn_3] ÏßÑÌñâÎ•†: ${i+1}/${chunks.length}`);
              }
            }
            
            console.log('[btn_learn_3] Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ ÏôÑÎ£å');
            console.log('[btn_learn_3] ÏÑ±Í≥µ:', successCount, 'Ïã§Ìå®:', failCount);
            alert(`Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ ÏôÑÎ£å!\nÏÑ±Í≥µ: ${successCount}Í∞ú\nÏã§Ìå®: ${failCount}Í∞ú`);
            
          } catch (error) {
            console.error('[btn_learn_3] Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ Ï§ë Ïò§Î•ò:', error);
            alert('Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ Ïã§Ìå®: ' + error.message);
          }
        });
      }
      
      // 4. ÌïôÏäµ Îç∞Ïù¥ÌÑ∞ Í≤ÄÏÉâ (KNN + ÌÇ§ÏõåÎìú)
      const btn4 = document.getElementById('btn_learn_4');
      if (btn4) {
        btn4.addEventListener('click', async function() {
          console.log('[btn_learn_4] ÌïôÏäµ Îç∞Ïù¥ÌÑ∞ Í≤ÄÏÉâ Î≤ÑÌäº ÌÅ¥Î¶≠');
          
          // Í≤ÄÏÉâ ÌÉÄÏûÖ ÏÑ†ÌÉù ÌåùÏóÖ
          const searchPopup = document.createElement('div');
          searchPopup.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
          `;
          
          searchPopup.innerHTML = `
            <div style="
              background: #0a0e27;
              border: 2px solid #00ffff;
              border-radius: 10px;
              padding: 30px;
              min-width: 500px;
              box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
            ">
              <h2 style="color: #00ffff; margin-top: 0; text-align: center;">
                ‚óÜ ÌïôÏäµ Îç∞Ïù¥ÌÑ∞ Í≤ÄÏÉâ ‚óÜ
              </h2>
              
              <div style="margin: 20px 0;">
                <label style="color: #0f0; display: block; margin-bottom: 10px;">Í≤ÄÏÉâ ÌÉÄÏûÖ:</label>
                <select id="searchType" style="
                  width: 100%;
                  padding: 10px;
                  background: #000;
                  color: #0f0;
                  border: 1px solid #00ffff;
                  border-radius: 5px;
                  font-size: 14px;
                ">
                  <option value="knn">KNN Ïú†ÏÇ¨ÎèÑ Í≤ÄÏÉâ</option>
                  <option value="keyword">ÌÇ§ÏõåÎìú Í≤ÄÏÉâ</option>
                </select>
              </div>
              
              <div style="margin: 20px 0;">
                <label style="color: #0f0; display: block; margin-bottom: 10px;">Í≤ÄÏÉâÏñ¥:</label>
                <input type="text" id="searchQuery" placeholder="Í≤ÄÏÉâÌï† ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="
                  width: 100%;
                  padding: 10px;
                  background: #000;
                  color: #0f0;
                  border: 1px solid #00ffff;
                  border-radius: 5px;
                  font-size: 14px;
                  box-sizing: border-box;
                ">
              </div>
              
              <div style="margin: 20px 0;">
                <label style="color: #0f0; display: block; margin-bottom: 10px;">Í≤∞Í≥º Í∞úÏàò (k):</label>
                <input type="number" id="searchK" value="3" min="1" max="10" style="
                  width: 100%;
                  padding: 10px;
                  background: #000;
                  color: #0f0;
                  border: 1px solid #00ffff;
                  border-radius: 5px;
                  font-size: 14px;
                  box-sizing: border-box;
                ">
              </div>
              
              <div id="searchResults" style="
                margin: 20px 0;
                padding: 15px;
                background: #000;
                color: #0f0;
                border: 1px solid #00ffff;
                border-radius: 5px;
                max-height: 300px;
                overflow: auto;
                display: none;
              "></div>
              
              <div style="display: flex; justify-content: center; gap: 20px; margin-top: 30px;">
                <button id="executeSearchBtn" style="
                  padding: 12px 30px;
                  background: linear-gradient(90deg, #00ff00, #00cc00);
                  color: #000;
                  border: none;
                  border-radius: 8px;
                  font-size: 16px;
                  font-weight: bold;
                  cursor: pointer;
                  box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
                ">Í≤ÄÏÉâ Ïã§Ìñâ</button>
                <button id="askLlmBtn" style="
                  padding: 12px 30px;
                  background: linear-gradient(90deg, #ffaa00, #ff8800);
                  color: #000;
                  border: none;
                  border-radius: 8px;
                  font-size: 16px;
                  font-weight: bold;
                  cursor: pointer;
                  box-shadow: 0 0 20px rgba(255, 170, 0, 0.5);
                  display: none;
                ">LLMÏóêÍ≤å ÏßàÎ¨∏</button>
                <button id="closeSearchBtn" style="
                  padding: 12px 30px;
                  background: linear-gradient(90deg, #ff6b6b, #ff0000);
                  color: #fff;
                  border: none;
                  border-radius: 8px;
                  font-size: 16px;
                  font-weight: bold;
                  cursor: pointer;
                  box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
                ">Îã´Í∏∞</button>
              </div>
            </div>
          `;
          
          document.body.appendChild(searchPopup);
          
          let searchResultsData = [];
          
          // Í≤ÄÏÉâ Ïã§Ìñâ Î≤ÑÌäº
          document.getElementById('executeSearchBtn').addEventListener('click', async () => {
            const searchType = document.getElementById('searchType').value;
            const query = document.getElementById('searchQuery').value.trim();
            const k = parseInt(document.getElementById('searchK').value);
            
            if (!query) {
              alert('Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
              return;
            }
            
            console.log('[btn_learn_4] Í≤ÄÏÉâ Ïã§Ìñâ:', searchType, query, k);
            
            try {
              const apiUrl = searchType === 'knn' 
                ? `${OPENSEARCH_API_BASE}/knn_search`
                : `${OPENSEARCH_API_BASE}/keyword_search`;
              
              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: query,
                  index: DEFAULT_INDEX,
                  k: k
                })
              });
              
              const data = await response.json();
              searchResultsData = data.result || [];
              
              console.log('[btn_learn_4] Í≤ÄÏÉâ Í≤∞Í≥º:', searchResultsData);
              
              // Í≤∞Í≥º ÌëúÏãú
              const resultsDiv = document.getElementById('searchResults');
              resultsDiv.style.display = 'block';
              
              if (searchResultsData.length === 0) {
                resultsDiv.innerHTML = '<p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                document.getElementById('askLlmBtn').style.display = 'none';
              } else {
                resultsDiv.innerHTML = searchResultsData.map((item, idx) => `
                  <div style="margin-bottom: 15px; padding: 10px; background: #001a1a; border-left: 3px solid #00ffff;">
                    <strong style="color: #00ffff;">Í≤∞Í≥º ${idx + 1}:</strong>
                    <pre style="white-space: pre-wrap; margin-top: 10px;">${item}</pre>
                  </div>
                `).join('');
                document.getElementById('askLlmBtn').style.display = 'inline-block';
              }
              
            } catch (error) {
              console.error('[btn_learn_4] Í≤ÄÏÉâ Ïã§Ìå®:', error);
              alert('Í≤ÄÏÉâ Ïã§Ìå®: ' + error.message);
            }
          });
          
          // LLMÏóêÍ≤å ÏßàÎ¨∏ Î≤ÑÌäº
          document.getElementById('askLlmBtn').addEventListener('click', async () => {
            const query = document.getElementById('searchQuery').value.trim();
            
            if (searchResultsData.length === 0) {
              alert('Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§!');
              return;
            }
            
            console.log('[btn_learn_4] LLMÏóêÍ≤å ÏßàÎ¨∏ ÏãúÏûë');
            
            // API Ï†úÌïúÏùÑ Í≥†Î†§Ìïú ÏïàÏ†ÑÌïú ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± (ÏµúÎåÄ 8MB)
            const maxContextSize = 8 * 1024 * 1024; // 8MB
            let combinedResults = searchResultsData.join('\n\n');
            
            if (combinedResults.length > maxContextSize) {
              console.log('[btn_learn_4] Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÎÑàÎ¨¥ ÌÅº, ÏûòÎùºÎÉÑ:', combinedResults.length, '->', maxContextSize);
              combinedResults = combinedResults.substring(0, maxContextSize) + '\n\n... (Í≤∞Í≥ºÍ∞Ä ÎÑàÎ¨¥ Í∏∏Ïñ¥ ÏùºÎ∂ÄÎßå ÌëúÏãúÎê®)';
            }
            
            const prompt = combinedResults 
              + '\n\nÏúÑ ÎÇ¥Ïö©ÏùÑ Ï∞∏Í≥†ÌïòÏó¨ ÏïÑÎûò ÏßàÎ¨∏Ïóê ÎãµÎ≥ÄÌïòÏÑ∏Ïöî.\n\nÏßàÎ¨∏: ' + query;
            
            try {
              const llmResponse = await call_llm_api(prompt, 'qwen');
              
              if (llmResponse) {
                alert('LLM ÎãµÎ≥Ä:\n\n' + llmResponse);
                console.log('[btn_learn_4] LLM ÎãµÎ≥Ä:', llmResponse);
              }
              
            } catch (error) {
              console.error('[btn_learn_4] LLM ÏßàÎ¨∏ Ïã§Ìå®:', error);
              alert('LLM ÏßàÎ¨∏ Ïã§Ìå®: ' + error.message);
            }
          });
          
          // Îã´Í∏∞ Î≤ÑÌäº
          document.getElementById('closeSearchBtn').addEventListener('click', () => {
            searchPopup.remove();
          });
        });
      }
      
      // 5. Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú
      const btn5 = document.getElementById('btn_learn_5');
      if (btn5) {
        btn5.addEventListener('click', async function() {
          console.log('[btn_learn_5] Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠');
          
          const indexName = prompt('ÏÇ≠Ï†úÌï† Ïù∏Îç±Ïä§ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', DEFAULT_INDEX);
          if (!indexName) {
            console.log('[btn_learn_5] Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú Ï∑®ÏÜåÎê®');
            return;
          }
          
          if (!confirm(`Ï†ïÎßêÎ°ú Ïù∏Îç±Ïä§ "${indexName}"Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!`)) {
            console.log('[btn_learn_5] ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÇ≠Ï†ú Ï∑®ÏÜå');
            return;
          }
          
          console.log('[btn_learn_5] Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú ÏöîÏ≤≠:', indexName);
          
          try {
            const response = await fetch(`${OPENSEARCH_API_BASE}/index_delete`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ index: indexName })
            });
            
            const result = await response.json();
            console.log('[btn_learn_5] Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú Í≤∞Í≥º:', result);
            
            if (result.result && result.result.acknowledged) {
              alert(`Ïù∏Îç±Ïä§ "${indexName}" ÏÇ≠Ï†ú ÏôÑÎ£å!`);
            } else {
              alert('Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú ÏôÑÎ£å');
            }
            
          } catch (error) {
            console.error('[btn_learn_5] Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú Ïã§Ìå®:', error);
            alert('Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú Ïã§Ìå®: ' + error.message);
          }
        });
      }
      
      // 6. Î°úÏª¨ Ï†ÑÏ≤òÎ¶¨ ÌõÑ AI ÏöîÏïΩ (Îπ†Î•∏ Î∂ÑÏÑù)
      const btn6 = document.getElementById('btn_learn_6');
      if (btn6) {
        btn6.addEventListener('click', async function() {
          console.log('[btn_learn_6] Î°úÏª¨ Ï†ÑÏ≤òÎ¶¨ Î∂ÑÏÑù Î≤ÑÌäº ÌÅ¥Î¶≠');
          
          // ÌååÏùº ÏóÖÎ°úÎìú input ÏÉùÏÑ±
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = '.txt,.log';
          
          fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const fileSizeMB = file.size / (1024 * 1024);
            console.log('[btn_learn_6] ÌååÏùº ÏÑ†ÌÉùÎê®:', file.name, 'ÌÅ¨Í∏∞:', fileSizeMB.toFixed(2), 'MB');
            
            if (!confirm(`ÌååÏùº: ${file.name}\nÌÅ¨Í∏∞: ${fileSizeMB.toFixed(2)} MB\n\nÎ°úÏª¨ Ï†ÑÏ≤òÎ¶¨ Î∂ÑÏÑùÏùÑ ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(JavaScriptÎ°ú ÏßÅÏ†ë ÌÜµÍ≥Ñ Í≥ÑÏÇ∞ ÌõÑ AI ÏöîÏïΩ)`)) {
              return;
            }
            
            try {
              // ÏßÑÌñâÎ•† ÌåùÏóÖ ÏÉùÏÑ±
              const progressPopup = createProgressPopup(file.name, fileSizeMB);
              document.body.appendChild(progressPopup);
              
              updateProgressPopup(0, 100, 'ÌååÏùº ÏùΩÍ∏∞ ÏãúÏûë...');
              
              // === 1Îã®Í≥Ñ: Î°úÏª¨ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞ ===
              console.log('[btn_learn_6] 1Îã®Í≥Ñ: Î°úÏª¨ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞ ÏãúÏûë');
              
              const CHUNK_SIZE = 10 * 1024 * 1024; // 10MB Ï≤≠ÌÅ¨Î°ú ÏùΩÍ∏∞ (Î©îÎ™®Î¶¨ Ìö®Ïú®)
              const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
              
              // ÌååÏùºÎ™ÖÏóêÏÑú ÎÇ†Ïßú Ï∂îÏ∂ú (Ïòà: SystemOut_20251030.log -> 2025ÎÖÑ 10Ïõî 30Ïùº)
              let logDate = null;
              let logDateFormatted = null;
              const dateMatch = file.name.match(/(\d{8})/); // YYYYMMDD ÌòïÏãù Ï∞æÍ∏∞
              if (dateMatch) {
                const dateStr = dateMatch[1];
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                logDate = `${year}-${month}-${day}`;
                logDateFormatted = `${year}ÎÖÑ ${parseInt(month)}Ïõî ${parseInt(day)}Ïùº`;
                console.log('[btn_learn_6] ÌååÏùºÎ™ÖÏóêÏÑú Ï∂îÏ∂úÌïú ÎÇ†Ïßú:', logDate, logDateFormatted);
              }
              
              // ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
              const stats = {
                fileName: file.name,
                logDate: logDate, // YYYY-MM-DD ÌòïÏãù
                logDateFormatted: logDateFormatted, // ÌïúÍµ≠Ïñ¥ ÌòïÏãù
                fileSizeMB: fileSizeMB.toFixed(2),
                totalLines: 0,
                totalRequests: 0,
                totalErrors: 0, // Ï†ÑÏ≤¥ ÏóêÎü¨ Ïπ¥Ïö¥Ìä∏
                bizrequestServices: {},
                hourlyUsage: {},
                users: {},
                devices: {},
                locations: {},
                errors: [], // ÏÉòÌîå ÏóêÎü¨ (ÏµúÎåÄ 100Í∞ú)
                dateRange: { start: null, end: null }
              };
              
              let buffer = ''; // Ï≤≠ÌÅ¨ Í≤ΩÍ≥Ñ Ï≤òÎ¶¨Ïö© Î≤ÑÌçº
              
              // Í∞Å Ï≤≠ÌÅ¨Î•º ÏàúÏ∞®Ï†ÅÏúºÎ°ú ÏùΩÏúºÎ©¥ÏÑú ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
              for (let i = 0; i < totalChunks; i++) {
                const start = i * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, file.size);
                const chunk = file.slice(start, end);
                
                updateProgressPopup(
                  Math.floor((i / totalChunks) * 50), 
                  100, 
                  `ÌÜµÍ≥Ñ Í≥ÑÏÇ∞ Ï§ë... (${i+1}/${totalChunks} Ï≤≠ÌÅ¨)`
                );
                
                const chunkText = await chunk.text();
                const fullText = buffer + chunkText;
                
                // ÎßàÏßÄÎßâ Ï§ÑÏù¥ Î∂àÏôÑÏ†ÑÌï† Ïàò ÏûàÏúºÎØÄÎ°ú Î≤ÑÌçºÏóê Ï†ÄÏû•
                const lastNewlineIndex = fullText.lastIndexOf('\n');
                const processText = lastNewlineIndex !== -1 ? fullText.substring(0, lastNewlineIndex) : fullText;
                buffer = lastNewlineIndex !== -1 ? fullText.substring(lastNewlineIndex + 1) : '';
                
                // Ï§Ñ Îã®ÏúÑÎ°ú ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
                const lines = processText.split('\n');
                stats.totalLines += lines.length;
                
                for (const line of lines) {
                  if (!line.trim()) continue;
                  
                  // BIZREQUEST Ïπ¥Ïö¥Ìä∏
                  if (line.includes('_BIZREQUEST')) {
                    stats.totalRequests++;
                    
                    // ÏÑúÎπÑÏä§Î™Ö Ï∂îÏ∂ú (Ïòà: pm.service.XXX)
                    const serviceMatch = line.match(/pm\.service\.(\w+)/);
                    if (serviceMatch) {
                      const serviceName = serviceMatch[1];
                      stats.bizrequestServices[serviceName] = (stats.bizrequestServices[serviceName] || 0) + 1;
                    }
                  }
                  
                  // ÏãúÍ∞ÑÎåÄ Ï∂îÏ∂ú (Ïòà: 2024-01-15 14:23:45)
                  const timeMatch = line.match(/(\d{4}-\d{2}-\d{2})\s+(\d{2}):/);
                  if (timeMatch) {
                    const date = timeMatch[1];
                    const hour = timeMatch[2];
                    
                    // ÎÇ†Ïßú Î≤îÏúÑ ÏóÖÎç∞Ïù¥Ìä∏
                    if (!stats.dateRange.start || date < stats.dateRange.start) {
                      stats.dateRange.start = date;
                    }
                    if (!stats.dateRange.end || date > stats.dateRange.end) {
                      stats.dateRange.end = date;
                    }
                    
                    // ÏãúÍ∞ÑÎåÄÎ≥Ñ ÏÇ¨Ïö©Îüâ
                    stats.hourlyUsage[hour] = (stats.hourlyUsage[hour] || 0) + 1;
                  }
                  
                  // ÏÇ¨Ïö©ÏûêÎ™Ö Ï∂îÏ∂ú (PUM_USER_NAME)
                  const userMatch = line.match(/PUM_USER_NAME[=:]\s*([^\s,\]]+)/);
                  if (userMatch) {
                    const userName = userMatch[1];
                    stats.users[userName] = (stats.users[userName] || 0) + 1;
                  }
                  
                  // Í∏∞Í∏∞ Î™®Îç∏ Ï∂îÏ∂ú (DEV_MODEL)
                  const deviceMatch = line.match(/DEV_MODEL[=:]\s*([^\s,\]]+)/);
                  if (deviceMatch) {
                    const deviceModel = deviceMatch[1];
                    stats.devices[deviceModel] = (stats.devices[deviceModel] || 0) + 1;
                  }
                  
                  // ÏßÄÏó≠ ÏΩîÎìú Ï∂îÏ∂ú (PNM_LOCATION_CD)
                  const locationMatch = line.match(/PNM_LOCATION_CD[=:]\s*([^\s,\]]+)/);
                  if (locationMatch) {
                    const locationCode = locationMatch[1];
                    stats.locations[locationCode] = (stats.locations[locationCode] || 0) + 1;
                  }
                  
                  // ÏóêÎü¨ Ï∂îÏ∂ú (ERROR, Exception Ìè¨Ìï®)
                  if (line.match(/ERROR|Exception|exception|FAIL|fail/i)) {
                    stats.totalErrors++; // Ï†ÑÏ≤¥ ÏóêÎü¨ Ïπ¥Ïö¥Ìä∏
                    
                    // ÏóêÎü¨ ÏÉòÌîå Ï†ÄÏû• (ÏµúÎåÄ 100Í∞ú)
                    if (stats.errors.length < 100) {
                      const errorMsg = line.trim().substring(0, 200);
                      stats.errors.push(errorMsg);
                    }
                  }
                }
                
                // ÏßÑÌñâ Î°úÍ∑∏
                const detailsDiv = document.getElementById('progressDetails');
                if (detailsDiv) {
                  const time = new Date().toLocaleTimeString();
                  detailsDiv.innerHTML += `[${time}] Ï≤≠ÌÅ¨ ${i+1}/${totalChunks} Ï≤òÎ¶¨ ÏôÑÎ£å (ÎàÑÏ†Å ÎùºÏù∏: ${stats.totalLines.toLocaleString()})<br>`;
                  detailsDiv.scrollTop = detailsDiv.scrollHeight;
                }
              }
              
              // ÎßàÏßÄÎßâ Î≤ÑÌçº Ï≤òÎ¶¨
              if (buffer.trim()) {
                stats.totalLines++;
              }
              
              console.log('[btn_learn_6] Î°úÏª¨ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞ ÏôÑÎ£å:', stats);
              updateProgressPopup(50, 100, 'Î°úÏª¨ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞ ÏôÑÎ£å! AI ÏöîÏïΩ ÏöîÏ≤≠ Ï§ë...');
              
              // ÏßÑÌñâ Î°úÍ∑∏
              const detailsDiv = document.getElementById('progressDetails');
              if (detailsDiv) {
                const time = new Date().toLocaleTimeString();
                detailsDiv.innerHTML += `<br>[${time}] ‚úÖ Î°úÏª¨ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞ ÏôÑÎ£å!<br>`;
                detailsDiv.innerHTML += `[${time}] üìä Ï¥ù ${stats.totalLines.toLocaleString()} ÎùºÏù∏ Î∂ÑÏÑù<br>`;
                detailsDiv.innerHTML += `[${time}] üîÑ AI ÏöîÏïΩ ÏÉùÏÑ± ÏãúÏûë...<br>`;
                detailsDiv.scrollTop = detailsDiv.scrollHeight;
              }
              
              // === 2Îã®Í≥Ñ: AI ÏöîÏïΩ ÏÉùÏÑ± ===
              console.log('[btn_learn_6] 2Îã®Í≥Ñ: AI ÏöîÏïΩ ÏÉùÏÑ± ÏãúÏûë');
              
              // ÏÉÅÏúÑ NÍ∞úÎßå Ï∂îÏ∂ú
              const topN = (obj, n) => {
                return Object.entries(obj)
                  .sort((a, b) => b[1] - a[1])
                  .slice(0, n)
                  .reduce((acc, [key, val]) => ({ ...acc, [key]: val }), {});
              };
              
              // ÏöîÏïΩÏö© ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞
              const summaryStats = {
                fileName: stats.fileName,
                logDate: stats.logDate,
                logDateFormatted: stats.logDateFormatted,
                fileSizeMB: stats.fileSizeMB,
                totalLines: stats.totalLines,
                totalRequests: stats.totalRequests,
                totalErrors: stats.totalErrors, // Ï†ÑÏ≤¥ ÏóêÎü¨ Ïàò
                dateRange: stats.dateRange,
                topServices: topN(stats.bizrequestServices, 10),
                hourlyUsage: stats.hourlyUsage,
                topUsers: topN(stats.users, 10),
                topDevices: topN(stats.devices, 10),
                topLocations: topN(stats.locations, 10),
                errorSamples: stats.errors.slice(0, 20) // ÎåÄÌëú ÏóêÎü¨ 20Í∞ú
              };
              
              // AI ÏöîÏïΩ ÌîÑÎ°¨ÌîÑÌä∏
              const summaryPrompt = `ÎãπÏã†ÏùÄ ÌïúÍµ≠Ïñ¥ Î°úÍ∑∏ Î∂ÑÏÑù Ï†ÑÎ¨∏Í∞ÄÏûÖÎãàÎã§. Îã§ÏùåÏùÄ "${stats.logDateFormatted || 'ÎÇ†Ïßú ÎØ∏ÏÉÅ'}" Î°úÍ∑∏ ÌååÏùºÏùò ÌÜµÍ≥Ñ Î∂ÑÏÑù Í≤∞Í≥ºÏûÖÎãàÎã§. 
Ïù¥Î•º Í∏∞Î∞òÏúºÎ°ú Ïù∏ÏÇ¨Ïù¥Ìä∏ ÏûàÎäî Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏Î•º **Î∞òÎìúÏãú ÌïúÍµ≠Ïñ¥**Î°ú JSON ÌòïÏãùÏúºÎ°ú ÏûëÏÑ±ÌïòÏÑ∏Ïöî.

**Ï§ëÏöî: Î™®Îì† ÏÑ§Î™ÖÍ≥º Î∂ÑÏÑù ÎÇ¥Ïö©ÏùÄ ÌïúÍµ≠Ïñ¥Î°ú ÏûëÏÑ±Ìï¥Ïïº Ìï©ÎãàÎã§.**

ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞:
${JSON.stringify(summaryStats, null, 2)}

ÏïÑÎûò ÌòïÏãùÏúºÎ°ú JSON ÏùëÎãµÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî:
{
  "log_date": "${stats.logDate || 'ÎÇ†Ïßú ÎØ∏ÏÉÅ'}",
  "log_date_formatted": "${stats.logDateFormatted || 'ÎÇ†Ïßú ÎØ∏ÏÉÅ'}",
  "file_name": "${stats.fileName}",
  "analysis_summary": {
    "overview": "Ïù¥ Î°úÍ∑∏Îäî ${stats.logDateFormatted || 'ÎÇ†Ïßú ÎØ∏ÏÉÅ'}Ïùò Îç∞Ïù¥ÌÑ∞ÏûÖÎãàÎã§. Ï¥ù ÎùºÏù∏ Ïàò, Ï¥ù ÏöîÏ≤≠ Ïàò Îì±ÏùÑ Ìè¨Ìï®Ìïú Ï†ÑÏ≤¥ ÏöîÏïΩÏùÑ ÌïúÍµ≠Ïñ¥Î°ú ÏûëÏÑ±",
    "key_insights": [
      "Ï£ºÏöî Ïù∏ÏÇ¨Ïù¥Ìä∏ 1 (ÌïúÍµ≠Ïñ¥)",
      "Ï£ºÏöî Ïù∏ÏÇ¨Ïù¥Ìä∏ 2 (ÌïúÍµ≠Ïñ¥)",
      "Ï£ºÏöî Ïù∏ÏÇ¨Ïù¥Ìä∏ 3 (ÌïúÍµ≠Ïñ¥)"
    ]
  },
  "service_analysis": {
    "most_used_services": "Í∞ÄÏû• ÎßéÏù¥ ÏÇ¨Ïö©Îêú ÏÑúÎπÑÏä§ ÏÉÅÏúÑ 5Í∞úÏôÄ ÏÇ¨Ïö©ÎüâÏùÑ ÌïúÍµ≠Ïñ¥Î°ú ÏÑ§Î™Ö",
    "service_distribution": "ÏÑúÎπÑÏä§ ÏÇ¨Ïö© Î∂ÑÌè¨Ïóê ÎåÄÌïú ÌïúÍµ≠Ïñ¥ ÏÑ§Î™Ö"
  },
  "temporal_analysis": {
    "peak_hours": "ÏµúÍ≥† ÏÇ¨Ïö© ÏãúÍ∞ÑÎåÄ (Ïòà: 08Ïãú, 09Ïãú, 10Ïãú)Î•º ÌïúÍµ≠Ïñ¥Î°ú ÏÑ§Î™Ö",
    "usage_pattern": "ÏãúÍ∞ÑÎåÄÎ≥Ñ ÏÇ¨Ïö© Ìå®ÌÑ¥ÏùÑ ÌïúÍµ≠Ïñ¥Î°ú ÏÉÅÏÑ∏ ÏÑ§Î™Ö",
    "date_range": "${stats.logDateFormatted || 'ÎÇ†Ïßú ÎØ∏ÏÉÅ'}Ïùò Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞"
  },
  "user_analysis": {
    "active_users": "Í∞ÄÏû• ÌôúÎ∞úÌïú ÏÇ¨Ïö©Ïûê ÏÉÅÏúÑ 3Î™ÖÍ≥º ÏÇ¨Ïö©ÎüâÏùÑ ÌïúÍµ≠Ïñ¥Î°ú ÏÑ§Î™Ö",
    "user_distribution": "ÏÇ¨Ïö©Ïûê Î∂ÑÌè¨ ÌäπÏßïÏùÑ ÌïúÍµ≠Ïñ¥Î°ú ÏÑ§Î™Ö"
  },
  "device_analysis": {
    "popular_devices": "Ï£ºÏöî Í∏∞Í∏∞ Î™®Îç∏ ÏÉÅÏúÑ 3Í∞úÎ•º ÌïúÍµ≠Ïñ¥Î°ú ÏÑ§Î™Ö",
    "device_insight": "Í∏∞Í∏∞ ÏÇ¨Ïö© Ìå®ÌÑ¥ÏùÑ ÌïúÍµ≠Ïñ¥Î°ú ÏÑ§Î™Ö"
  },
  "location_analysis": {
    "main_locations": "Ï£ºÏöî ÏßÄÏó≠ ÏΩîÎìú ÏÉÅÏúÑ 3Í∞úÎ•º ÌïúÍµ≠Ïñ¥Î°ú ÏÑ§Î™Ö",
    "location_insight": "ÏßÄÏó≠Î≥Ñ ÏÇ¨Ïö© ÌäπÏßïÏùÑ ÌïúÍµ≠Ïñ¥Î°ú ÏÑ§Î™Ö"
  },
  "error_analysis": {
    "total_error_count": ${stats.totalErrors},
    "error_samples_count": "ÏóêÎü¨ ÏÉòÌîå Ïàò (Ïà´Ïûê)",
    "error_patterns": "Ï£ºÏöî ÏóêÎü¨ Ìå®ÌÑ¥ Î∞è Ïú†ÌòïÏùÑ ÌïúÍµ≠Ïñ¥Î°ú ÏÑ§Î™Ö",
    "recommendations": "Í∂åÏû• Ï°∞ÏπòÏÇ¨Ìï≠ÏùÑ ÌïúÍµ≠Ïñ¥Î°ú ÏÑ§Î™Ö"
  },
  "recommendations": [
    "Í∞úÏÑ† Ï†úÏïà 1 (ÌïúÍµ≠Ïñ¥)",
    "Í∞úÏÑ† Ï†úÏïà 2 (ÌïúÍµ≠Ïñ¥)",
    "Í∞úÏÑ† Ï†úÏïà 3 (ÌïúÍµ≠Ïñ¥)"
  ],
  "searchable_info": {
    "date": "${stats.logDate}",
    "date_kr": "${stats.logDateFormatted}",
    "purpose": "Ïù¥ Ï†ïÎ≥¥Îäî '${stats.logDateFormatted}ÏóêÎäî Ïñ¥Îñ§ ÏóêÎü¨Í∞Ä ÏûàÏóàÏñ¥?' Í∞ôÏùÄ ÎÇ†ÏßúÎ≥Ñ Í≤ÄÏÉâÏùÑ ÏúÑÌïú Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ÏûÖÎãàÎã§."
  }
}

**ÌïÑÏàò ÏöîÍµ¨ÏÇ¨Ìï≠:**
1. Î™®Îì† ÏÑ§Î™ÖÍ≥º Î∂ÑÏÑùÏùÄ Î∞òÎìúÏãú ÌïúÍµ≠Ïñ¥Î°ú ÏûëÏÑ±
2. ÎÇ†Ïßú Ï†ïÎ≥¥(log_date, log_date_formatted)Î•º Î™ÖÌôïÌûà Ìè¨Ìï®
3. Î°úÍ∑∏ ÎÇ¥Ïö© ÏûêÏ≤¥(ÏóêÎü¨ Î©îÏãúÏßÄ Îì±)Îäî ÏõêÎ¨∏ Ïú†ÏßÄ
4. Î∂ÑÏÑùÍ≥º Ïù∏ÏÇ¨Ïù¥Ìä∏Îäî ÌïúÍµ≠Ïñ¥Î°ú ÏÉÅÏÑ∏ÌïòÍ≤å ÏûëÏÑ±
5. Ïù¥ Îç∞Ïù¥ÌÑ∞Îäî OpenSearchÏóê Ï†ÄÏû•ÎêòÏñ¥ ÎÇ†ÏßúÎ≥Ñ Í≤ÄÏÉâÏóê ÏÇ¨Ïö©Îê©ÎãàÎã§

Î∞òÎìúÏãú JSON ÌòïÏãùÏúºÎ°úÎßå ÎãµÎ≥ÄÌïòÏÑ∏Ïöî.`;
              
              updateProgressPopup(60, 100, 'AI ÏöîÏïΩ ÏÉùÏÑ± Ï§ë...');
              
              // Îçî Í∏¥ ÏùëÎãµÏùÑ Î∞õÍ∏∞ ÏúÑÌï¥ limit Ï¶ùÍ∞Ä (4096 -> 16384)
              const aiResponse = await call_llm_api(summaryPrompt, 'qwen', false, 16384);
              
              if (!aiResponse) {
                throw new Error('AI ÏöîÏïΩ ÏÉùÏÑ± Ïã§Ìå®');
              }
              
              console.log('[btn_learn_6] AI ÏöîÏïΩ ÏôÑÎ£å');
              updateProgressPopup(100, 100, 'Î∂ÑÏÑù ÏôÑÎ£å!');
              
              if (detailsDiv) {
                const time = new Date().toLocaleTimeString();
                detailsDiv.innerHTML += `[${time}] ‚úÖ AI ÏöîÏïΩ ÏÉùÏÑ± ÏôÑÎ£å!<br>`;
                detailsDiv.scrollTop = detailsDiv.scrollHeight;
              }
              
              // === 3Îã®Í≥Ñ: Í≤∞Í≥º ÌëúÏãú ===
              setTimeout(() => {
                progressPopup.remove();
                
                // JSON ÌååÏã±
                let analysisResult;
                try {
                  const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                  if (jsonMatch) {
                    analysisResult = JSON.parse(jsonMatch[0]);
                  } else {
                    analysisResult = JSON.parse(aiResponse);
                  }
                } catch (parseError) {
                  console.error('[btn_learn_6] JSON ÌååÏã± Ïã§Ìå®:', parseError);
                  analysisResult = { raw_response: aiResponse };
                }
                
                // Í≤∞Í≥º ÌåùÏóÖ ÏÉùÏÑ± (btn_learn_2ÏôÄ ÎèôÏùºÌïú ÌòïÏãù)
                const combinedResult = {
                  local_statistics: summaryStats,
                  ai_analysis: analysisResult,
                  processing_info: {
                    method: 'Local preprocessing + AI summary',
                    total_chunks_processed: totalChunks,
                    processing_time: 'ÏïΩ 2~5Î∂Ñ',
                    file_size_mb: fileSizeMB.toFixed(2)
                  }
                };
                
                createJsonResultPopup(combinedResult, file.name);
                
                console.log('[btn_learn_6] Ï†ÑÏ≤¥ Î∂ÑÏÑù ÏôÑÎ£å!');
                
              }, 1000);
              
            } catch (error) {
              console.error('[btn_learn_6] Î∂ÑÏÑù Ïã§Ìå®:', error);
              alert('Î∂ÑÏÑù Ïã§Ìå®: ' + error.message);
              
              const popup = document.getElementById('progressPopup');
              if (popup) popup.remove();
            }
          });
          
          fileInput.click();
        });
      }
    });
  </script>
</body>
</html>
