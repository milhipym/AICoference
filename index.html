<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>í”„ë¡œë¯¸ì¹´ ë¡œê·¸ ëª¨ë‹ˆí„°ë§</title>
<link rel="stylesheet" href="css/common.css" />
<link rel="stylesheet" href="css/contents.css" />
<link rel="stylesheet" href="css/modal.css" />
<link rel="stylesheet" href="css/card.css" />
<link rel="stylesheet" href="css/layout-erroranalyze.css" />
<link rel="stylesheet" href="css/layout-searchlist.css" />
<link rel="stylesheet" href="css/layout-detailanalyze.css" />
</head>
<body>
  <div class="cockpit">
    <!-- í—¤ë” -->
    <div class="cockpit-header">
      <h1>â—ˆ LOG MONITORING SYSTEM â—ˆ</h1>
      <p class="subtitle">REAL-TIME ANALYSIS DASHBOARD</p>
      <div style="text-align: center; margin-top: 15px;">
        <a href="dashboard.html" style="display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #00d9ff, #00ffff); color: #0a0e27; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 16px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.4); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 30px rgba(0, 255, 255, 0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 0 20px rgba(0, 255, 255, 0.4)'">
          ğŸ“Š ì›”ê°„ ë¶„ì„ ëŒ€ì‹œë³´ë“œ
        </a>
      </div>
    </div>

    <!-- ë©”ì¸ ëª¨ë‹ˆí„° (ëŒ€í˜• ì°¨íŠ¸ í™”ë©´) -->
    <div class="main-monitor">
      <div class="monitor-header">
        <span class="monitor-title">â—† TEMPORAL LOG DISTRIBUTION</span>
        <div class="monitor-indicators">
          <span class="indicator active"></span>
          <span class="indicator"></span>
          <span class="indicator"></span>
        </div>
      </div>
      <div class="monitor-body">
        <div id="chart"></div>
        <progress id="prog" max="100" value="0"></progress>
        <div id="status">
          <span class="status-text">SYSTEM READY - AWAITING LOG FILE</span>
        </div>
      </div>
    </div>

    <!-- í•˜ë‹¨ ì½˜ì†” íŒ¨ë„ ê·¸ë¦¬ë“œ -->
    <div class="console-grid">
      <!-- íŒŒì¼ ë¡œë“œ íŒ¨ë„ -->
      <div class="console-panel">
        <div class="panel-header">â–£ FILE LOADER</div>
        <div class="panel-body">
          <div class="upload-zone" id="uploadZone">
            <input id="file" type="file" accept=".log,.txt" />
            <label for="file" class="upload-btn">SELECT FILE</label>
            <span id="file-name">NO FILE LOADED</span>
          </div>
          <div class="file-history">
            <div class="history-header">
              RECENT FILES
              <button class="history-popup-btn" onclick="openHistoryPopup()" title="ì „ì²´ íˆìŠ¤í† ë¦¬ ë³´ê¸°">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="9" y1="9" x2="15" y2="9"></line>
                  <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
              </button>
            </div>
            <div id="historyList" class="history-list">
              <div class="history-empty">NO HISTORY</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ê²€ìƒ‰ ì œì–´ íŒ¨ë„ -->
      <div class="console-panel">
        <div class="panel-header">â–£ SEARCH CONTROL</div>
        <div class="panel-body">
          <div class="control-group">
            <label>ì¶”ì²œ í‚¤ì›Œë“œ</label>
            <div class="keyword-chips">
              <button class="chip chip-info" onclick="setSearchWord('INFO')">INFO</button>
              <button class="chip chip-error" onclick="setSearchWord('Exception')">Exception</button>
              <button class="chip chip-fatal" onclick="setSearchWord('FATAL')">FATAL</button>
            </div>
          </div>
          <div class="control-group">
            <label>PATTERN</label>
            <input type="text" id="searchWord" placeholder="INFO, Exception, WARN..." value="INFO">
          </div>
          <button class="btn primary" id="btnSearch" onclick="doSearch()">EXECUTE SEARCH</button>
        </div>
      </div>

      <!-- ë¶„ì„ ì˜µì…˜ íŒ¨ë„ -->
      <div class="console-panel">
        <div class="panel-header">â–£ ANALYSIS OPTIONS</div>
        <div class="panel-body">
          <button class="btn btn-cyber-neon" id="btnDetail" onclick="openDetailPopup()">ì¢…í•© ë¶„ì„</button>
          <button class="btn btn-cyber-neon" id="btnErrorAnal" onclick="openErrorPopup()">ì˜¤ë¥˜ ë¶„ì„</button>
          <button class="btn btn-cyber-neon" id="btnSplit" onclick="doSplit()">FILE SPLIT</button>
        </div>
      </div>

      <!-- ë¡œê·¸ ë·°ì–´ íŒ¨ë„ -->
      <div class="console-panel log-viewer-half">
        <div class="panel-header">â–£ LOG VIEWER</div>
        <div class="panel-body">
          <div id="preview"></div>
        </div>
      </div>


    </div>
  </div>

  <!-- ì¢…í•©ë¶„ì„ íŒì—… -->
  <div id="detailPopup" class="detail-popup">
    <div class="detail-popup-content">
      <div class="detail-popup-header">
        <h2>â—† LOG STATISTICS ANALYSIS â—†</h2>
        
        <!-- ìˆ¨ê²¨ì§„ í•™ìŠµ ë²„íŠ¼ë“¤ -->
        <div class="hidden-learning-buttons">
          <button id="btn_learn_1" class="hidden-btn" title="ì¸ë±ìŠ¤ ìƒì„±">1</button>
          <button id="btn_learn_2" class="hidden-btn" title="ì„ë² ë”© ìƒì„±">2</button>
          <button id="btn_learn_3" class="hidden-btn" title="ë°ì´í„° ì‚½ì…">3</button>
          <button id="btn_learn_4" class="hidden-btn" title="ì˜ˆì•½ ê¸°ëŠ¥">4</button>
          <button id="btn_learn_5" class="hidden-btn" title="ì˜ˆì•½ ê¸°ëŠ¥">5</button>
          <button id="btn_learn_6" class="hidden-btn" title="ë¡œì»¬ ì „ì²˜ë¦¬ ë¶„ì„">6</button>
        </div>
        
        <button class="detail-close-btn" onclick="closeDetailPopup()">âœ• CLOSE</button>
      </div>
      
      <!-- ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ -->
      <div id="analysisLoading" class="analysis-loading">
        <!-- ìë¹„ìŠ¤ ìŠ¤íƒ€ì¼ ë°ì´í„° ìŠ¤íŠ¸ë¦¼ ë°°ê²½ -->
        <div class="jarvis-data-streams">
          <div class="data-stream stream-1"></div>
          <div class="data-stream stream-2"></div>
          <div class="data-stream stream-3"></div>
          <div class="data-stream stream-4"></div>
        </div>
        
        <!-- ì›€ì§ì´ëŠ” ë¼ì¸ë“¤ -->
        <div class="jarvis-lines">
          <div class="scan-line line-1"></div>
          <div class="scan-line line-2"></div>
          <div class="scan-line line-3"></div>
        </div>
        
        <!-- ì¶”ê°€ íšŒì „ ë§ë“¤ -->
        <div class="jarvis-rings">
          <div class="ring ring-1"></div>
          <div class="ring ring-2"></div>
          <div class="ring ring-3"></div>
        </div>
        
        <div class="loading-spinner"></div>
        <div class="loading-text">ANALYZING LOG DATA...</div>
        <div class="loading-progress" id="loadingProgress">0%</div>
      </div>
      
      <div id="detailContent" style="display:none;">
        <div class="detail-section">
          <h3>? Overall Statistics</h3>
          <div class="detail-stats-grid">
            <div class="stat-card">
              <h4>Total Requests</h4>
              <div class="stat-value" id="totalRequests">0</div>
            </div>
            <div class="stat-card">
              <h4>Exception Count</h4>
              <div class="stat-value" id="errorCount" style="color: #ff6666;">0</div>
            </div>
            <div class="stat-card">
              <h4>Analysis Duration</h4>
              <div class="stat-value" id="analysisDuration" style="font-size: 18px;">-</div>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>? TOP 5 UX_ Requests</h3>
          <div id="topRequests"></div>
        </div>

        <div class="detail-section">
          <h3>âš ï¸ Exceptions</h3>
          <div id="errorLogs" class="error-list"></div>
          <div id="errorPagination" class="error-pagination" style="display:none;">
            <button class="btn-page" onclick="prevErrorPage()">â—€ PREV</button>
            <span class="page-info" id="errorPageInfo">1 / 1</span>
            <button class="btn-page" onclick="nextErrorPage()">NEXT â–¶</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/marked.min.js"></script>
  <script src="js/jszip.min.js"></script>
  <script src="js/logWorkerSource.js"></script>
  <script src="js/plotly-3.1.0.min.js"></script>
  <script src="js/modal.js"></script>
  <script src="js/util/fileUtil.js"></script>
  <script src="js/util/stringUtil.js"></script>
  <script src="js/model/errorAnalyzeViewModel.js"></script>
  <script src="js/model/searchListViewModel.js"></script>
  <script src="js/model/detailInfoViewModel.js"></script>
  <script src="js/main.js"></script>
  <script src="js/view/erroranalyze.js"></script>
  <script src="js/view/searchList.js"></script>
  <script src="js/view/detailInfo.js"></script>
  
  <script>
    const uploadZone = document.getElementById('uploadZone');
    const fileInputEl = document.getElementById('file');

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const f = files[0];
        window.logfile = f;
        document.getElementById('file-name').textContent = f.name;
        
        if (typeof chartDragClear === 'function') {
          chartDragClear();
        }
        window.timeRangeSize = 24;
        
        // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
        if (typeof addToHistory === 'function') {
          addToHistory(f);
        }
      }
    });

    fileInputEl.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (f) {
        document.getElementById('file-name').textContent = f.name;
        
        // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
        if (typeof addToHistory === 'function') {
          addToHistory(f);
        }
      }
    });

    // ì¶”ì²œ í‚¤ì›Œë“œ í´ë¦­ ì‹œ ê²€ìƒ‰ì–´ ìë™ ì…ë ¥
    function setSearchWord(keyword) {
      document.getElementById('searchWord').value = keyword;
      document.getElementById('searchWord').focus();
    }

    // IndexedDB ì„¤ì •
    const DB_NAME = 'LogAnalyzerDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'logfiles';
    const FILE_HISTORY_KEY = 'logfile_history';
    const MAX_HISTORY = 15;
    let db = null;

    // IndexedDB ì´ˆê¸°í™”
    async function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          }
        };
      });
    }

    // IndexedDBì— íŒŒì¼ ì €ì¥
    async function saveFileToIndexedDB(file) {
      if (!db) await initDB();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const id = `${file.name}_${file.size}`;
        
        const request = store.put({ id, file, timestamp: Date.now() });
        request.onsuccess = () => resolve(id);
        request.onerror = () => reject(request.error);
      });
    }

    // IndexedDBì—ì„œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadFileFromIndexedDB(id) {
      if (!db) await initDB();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(id);
        
        request.onsuccess = () => {
          if (request.result) {
            resolve(request.result.file);
          } else {
            resolve(null);
          }
        };
        request.onerror = () => reject(request.error);
      });
    }

    // IndexedDBì—ì„œ íŒŒì¼ ì‚­ì œ
    async function deleteFileFromIndexedDB(id) {
      if (!db) await initDB();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(id);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadHistory() {
      try {
        const history = localStorage.getItem(FILE_HISTORY_KEY);
        return history ? JSON.parse(history) : [];
      } catch (e) {
        return [];
      }
    }

    // íˆìŠ¤í† ë¦¬ ì €ì¥
    function saveHistory(history) {
      try {
        localStorage.setItem(FILE_HISTORY_KEY, JSON.stringify(history));
      } catch (e) {
        console.error('Failed to save history:', e);
      }
    }

    // íˆìŠ¤í† ë¦¬ì— íŒŒì¼ ì¶”ê°€
    async function addToHistory(file) {
      let history = loadHistory();
      
      // ì¤‘ë³µ ì œê±° (ê°™ì€ íŒŒì¼ëª…ê³¼ í¬ê¸°)
      history = history.filter(item => 
        !(item.name === file.name && item.size === file.size)
      );
      
      // ìƒˆ íŒŒì¼ì„ ë§¨ ì•ì— ì¶”ê°€
      history.unshift({
        name: file.name,
        size: file.size,
        timestamp: Date.now()
      });
      
      // ìµœëŒ€ ê°œìˆ˜ ì œí•œ
      history = history.slice(0, MAX_HISTORY);
      
      saveHistory(history);
      
      // IndexedDBì— íŒŒì¼ ì €ì¥
      try {
        await saveFileToIndexedDB(file);
      } catch (e) {
        console.error('Failed to save file to IndexedDB:', e);
      }
      
      updateHistoryUI();
    }

    // íˆìŠ¤í† ë¦¬ì—ì„œ ì‚­ì œ
    function removeFromHistory(index) {
      let history = loadHistory();
      history.splice(index, 1);
      saveHistory(history);
      updateHistoryUI();
    }

    // íŒŒì¼ í¬ê¸° í¬ë§·
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
    }

    // íˆìŠ¤í† ë¦¬ íŒŒì¼ í´ë¦­ ì‹œ ë¡œë“œ
    async function loadFromHistory(index) {
      const history = loadHistory();
      const item = history[index];
      
      if (!item) return;
      
      // IndexedDBì—ì„œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
      const fileId = `${item.name}_${item.size}`;
      const file = await loadFileFromIndexedDB(fileId);
      
      if (file) {
        // íŒŒì¼ ìë™ ë¡œë“œ
        window.logfile = file;
        mainModel.logfile = file;
        document.getElementById('file-name').textContent = file.name;
        
        if (typeof chartDragClear === 'function') {
          chartDragClear();
        }
        window.timeRangeSize = 24;
        
        // ê²€ìƒ‰ ë²„íŠ¼ ê¹œë¹¡ì„ ì¶”ê°€
        const searchBtn = document.getElementById('btnSearch');
        if (searchBtn) {
          searchBtn.classList.add('btn-blink');
        }
      } else {
        // íŒŒì¼ì´ IndexedDBì— ì—†ìŒ
        alert(`íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"${item.name}" íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.`);
        await deleteFileFromIndexedDB(fileId);
        removeFromHistory(index);
      }
    }

    // íˆìŠ¤í† ë¦¬ UI ì—…ë°ì´íŠ¸ (ìµœì‹  1ê°œë§Œ í‘œì‹œ)
    function updateHistoryUI() {
      const history = loadHistory();
      const historyList = document.getElementById('historyList');
      
      if (history.length === 0) {
        historyList.innerHTML = '<div class="history-empty">NO HISTORY</div>';
        return;
      }
      
      // ìµœì‹  1ê°œë§Œ í‘œì‹œ
      const latestItem = history[0];
      historyList.innerHTML = `
        <div class="history-item">
          <span class="history-item-name" title="${latestItem.name}" onclick="loadFromHistory(0)">${latestItem.name}</span>
          <span class="history-item-size">${formatFileSize(latestItem.size)}</span>
          <button class="history-item-delete" onclick="removeFromHistory(0)">Ã—</button>
        </div>
      `;
    }

    // ì „ì—­ ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤
    let historyModal = null;

    // íˆìŠ¤í† ë¦¬ íŒì—… ì—´ê¸°
    function openHistoryPopup() {
      const history = loadHistory();
      
      if (history.length === 0) {
        alert('ì €ì¥ëœ íŒŒì¼ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const popupContent = `
        <div class="history-popup-header">
          <h3>íŒŒì¼ íˆìŠ¤í† ë¦¬ (${history.length}ê°œ)</h3>
          <button class="popup-close-btn" onclick="closeHistoryPopup()">Ã—</button>
        </div>
        <div class="history-popup-list">
          ${history.map((item, index) => `
            <div class="history-popup-item">
              <div class="popup-item-info" onclick="loadFromHistoryPopup(${index})">
                <span class="popup-item-name" title="${item.name}">${item.name}</span>
                <span class="popup-item-size">${formatFileSize(item.size)}</span>
              </div>
              <button class="popup-item-delete" onclick="removeFromHistoryPopup(${index})">ì‚­ì œ</button>
            </div>
          `).join('')}
        </div>
      `;
      
      // Modal ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
      historyModal = new Modal({
        size: 'md',
        title: '',
        closeOnEsc: true,
        closeOnOverlay: true
      });
      
      historyModal.setContent(popupContent);
      historyModal.open();
    }

    // íŒì—… ë‹«ê¸°
    function closeHistoryPopup() {
      if (historyModal) {
        historyModal.close();
        historyModal = null;
      }
    }

    // íŒì—…ì—ì„œ íŒŒì¼ ë¡œë“œ
    async function loadFromHistoryPopup(index) {
      const history = loadHistory();
      const item = history[index];
      
      if (!item) return;
      
      // IndexedDBì—ì„œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
      const fileId = `${item.name}_${item.size}`;
      const file = await loadFileFromIndexedDB(fileId);
      
      if (file) {
        // íŒŒì¼ ìë™ ë¡œë“œ
        window.logfile = file;
        mainModel.logfile = file
        document.getElementById('file-name').textContent = file.name;
        
        if (typeof chartDragClear === 'function') {
          chartDragClear();
        }
        window.timeRangeSize = 24;
        
        // ê²€ìƒ‰ ë²„íŠ¼ ê¹œë¹¡ì„ ì¶”ê°€
        const searchBtn = document.getElementById('btnSearch');
        if (searchBtn) {
          searchBtn.classList.add('btn-blink');
        }
        
        // íŒì—… ë‹«ê¸°
        closeHistoryPopup();
      } else {
        // íŒŒì¼ì´ IndexedDBì— ì—†ìŒ
        alert(`íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"${item.name}" íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.`);
        await removeFromHistoryPopup(index);
      }
    }

    // íŒì—…ì—ì„œ íŒŒì¼ ì‚­ì œ
    async function removeFromHistoryPopup(index) {
      const history = loadHistory();
      const item = history[index];
      
      if (item) {
        const fileId = `${item.name}_${item.size}`;
        await deleteFileFromIndexedDB(fileId);
      }
      
      removeFromHistory(index);
      
      // íŒì—… ë‚´ìš© ê°±ì‹ 
      const newHistory = loadHistory();
      if (newHistory.length === 0) {
        closeHistoryPopup();
        return;
      }
      
      // íŒì—… ë‹¤ì‹œ ì—´ê¸° (ê°±ì‹ )
      closeHistoryPopup();
      setTimeout(() => openHistoryPopup(), 100);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ IndexedDB ì´ˆê¸°í™”
    (async function() {
      await initDB();
      updateHistoryUI();
    })();

    // ì´ˆê¸° íˆìŠ¤í† ë¦¬ ë¡œë“œ
    updateHistoryUI();

    // ë¡œê·¸ ë¶„ì„ ë°ì´í„° ì €ì¥
    let logAnalysisData = {
      totalRequests: 0,
      uxRequests: {},
      errors: [],
      totalErrorCount: 0,
      timeStart: null,
      timeEnd: null
    };

    // ì—ëŸ¬ í˜ì´ì§€ë„¤ì´ì…˜
    let currentErrorPage = 1;
    const ERRORS_PER_PAGE = 20;

    // ì¢…í•©ë¶„ì„ íŒì—… ì—´ê¸°
    async function openDetailPopup() {
      if (!mainModel.logfile) {
        alert("ë¡œê·¸ íŒŒì¼ì„ ì—…ë¡œë“œ í›„ 'EXECUTE SEARCH' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš” !!");
        return;
      }

      // ê²€ìƒ‰ ì™„ë£Œ ì—¬ë¶€ í™•ì¸
      if (!mainModel.searchObj || !mainModel.searchObj.searchLineStartByteArray) {
        alert("ë¡œê·¸ íŒŒì¼ì„ ì—…ë¡œë“œ í›„ 'EXECUTE SEARCH' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš” !!");
        return;
      }

      const popup = document.getElementById('detailPopup');
      popup.classList.add('active');
      
      // ë¡œë”© í‘œì‹œ, ê²°ê³¼ ìˆ¨ê¹€
      document.getElementById('analysisLoading').style.display = 'flex';
      document.getElementById('detailContent').style.display = 'none';
      document.getElementById('loadingProgress').textContent = '0%';
      
      // ë¡œê·¸ ë¶„ì„ ì‹œì‘
      await analyzeLogFile();
      
      // ë¡œë”© ìˆ¨ê¹€, ê²°ê³¼ í‘œì‹œ
      document.getElementById('analysisLoading').style.display = 'none';
      document.getElementById('detailContent').style.display = 'block';
      
      // ê²°ê³¼ í‘œì‹œ
      currentErrorPage = 1;
      displayAnalysisResults();
    }

    // ì¢…í•©ë¶„ì„ íŒì—… ë‹«ê¸°
    function closeDetailPopup() {
      const popup = document.getElementById('detailPopup');
      popup.classList.remove('active');
    }

    // ë¡œê·¸ íŒŒì¼ ë¶„ì„ (ì²­í¬ ë°©ì‹ - ëŒ€ìš©ëŸ‰ íŒŒì¼ ì§€ì›)
    async function analyzeLogFile() {
      const file = mainModel.logfile;
      if (!file) return;

      // ë¶„ì„ ë°ì´í„° ì´ˆê¸°í™”
      logAnalysisData = {
        totalRequests: 0,
        uxRequests: {},
        errors: [],
        totalErrorCount: 0,
        timeStart: null,
        timeEnd: null
      };

      const CHUNK_SIZE = 10 * 1024 * 1024; // 10MBì”© ì½ê¸°
      let offset = 0;
      let lineNumber = 0;
      let leftover = '';

      // ì§„í–‰ìƒí™© í‘œì‹œ
      const loadingProgress = document.getElementById('loadingProgress');
      
      while (offset < file.size) {
        const chunkEnd = Math.min(offset + CHUNK_SIZE, file.size);
        const chunk = file.slice(offset, chunkEnd);
        const text = await chunk.text();
        const combined = leftover + text;
        
        const lines = combined.split('\n');
        
        // ë§ˆì§€ë§‰ ë¼ì¸ì€ ë‹¤ìŒ ì²­í¬ë¡œ ì´ì›” (ë¶ˆì™„ì „í•  ìˆ˜ ìˆìŒ)
        if (chunkEnd < file.size) {
          leftover = lines.pop() || '';
        } else {
          leftover = '';
        }

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          lineNumber++;

          // _BIZREQUEST ì¶”ì¶œ
          if (line.includes('_BIZREQUEST')) {
            logAnalysisData.totalRequests++;
            
            // UX_ ìš”ì²­ ì¶”ì¶œ
            const uxMatch = line.match(/_BIZREQUEST[:\s]+([A-Z_0-9]+)/);
            if (uxMatch && uxMatch[1].startsWith('UX_')) {
              const reqName = uxMatch[1];
              logAnalysisData.uxRequests[reqName] = (logAnalysisData.uxRequests[reqName] || 0) + 1;
            }
          }

          // Exception ì¶”ì¶œ (Exception, Error:) - ë©€í‹°ë¼ì¸ ì§€ì›
          if (line.includes('Exception') || line.includes('Error:')) {
            logAnalysisData.totalErrorCount++;
            
            // ìƒì„¸ ë‚´ìš©ì€ ìµœëŒ€ 1000ê°œë§Œ ì €ì¥ (í˜ì´ì§€ë„¤ì´ì…˜ìš©)
            if (logAnalysisData.errors.length < 1000) {
              // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ì¶œ
              const timeMatch = line.match(/(\d{2}:\d{2}:\d{2})/);
              const timestamp = timeMatch ? timeMatch[1] : '';
              
              // Exception íƒ€ì…
              let errorType = 'Exception';
              
              // Exception ë³¸ë¬¸ + ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ìˆ˜ì§‘
              let fullErrorContent = line.trim();
              let additionalLines = 0;
              for (let j = i + 1; j < Math.min(i + 50, lines.length); j++) {
                const nextLine = lines[j].trim();
                // ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ë¼ì¸ì¸ì§€ í™•ì¸
                if (nextLine.startsWith('at ') || 
                    nextLine.startsWith('Caused by:') || 
                    nextLine.startsWith('Suppressed:') || 
                    nextLine.startsWith('...')) {
                  fullErrorContent += '\n' + nextLine;
                  additionalLines++;
                } else if (!nextLine || 
                          /^\d{2}:\d{2}:\d{2}/.test(nextLine) || 
                          /^(?:[A-Z]+\s+)?\[?\d{4}[-\/]\d{2}[-\/]\d{2}[\sT]\d{2}:\d{2}:\d{2}/.test(nextLine)) {
                  break;
                } else {
                  break;
                }
              }
              
              logAnalysisData.errors.push({
                line: lineNumber,
                timestamp: timestamp,
                errorType: errorType,
                content: fullErrorContent,
                lines: additionalLines + 1
              });
              
              i += additionalLines;
              lineNumber += additionalLines;
            }
          }

          // ì‹œê°„ ë²”ìœ„ ì¶”ì¶œ
          const timeMatch = line.match(/(\d{2}:\d{2}:\d{2})/);
          if (timeMatch) {
            if (!logAnalysisData.timeStart) {
              logAnalysisData.timeStart = timeMatch[1];
            }
            logAnalysisData.timeEnd = timeMatch[1];
          }
        }

        offset = chunkEnd;
        
        const percent = Math.min(Math.floor((offset / file.size) * 100), 100);
        if (loadingProgress) {
          loadingProgress.textContent = `${percent}%`;
        }
      }
    }

    // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
    function displayAnalysisResults() {
      document.getElementById('totalRequests').textContent = logAnalysisData.totalRequests.toLocaleString();
      document.getElementById('errorCount').textContent = logAnalysisData.totalErrorCount.toLocaleString();
      
      if (logAnalysisData.timeStart && logAnalysisData.timeEnd) {
        document.getElementById('analysisDuration').textContent = 
          `${logAnalysisData.timeStart} ~ ${logAnalysisData.timeEnd}`;
      }

      // TOP 5 UX_ ìš”ì²­
      const topRequests = Object.entries(logAnalysisData.uxRequests)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      const topRequestsHTML = topRequests.map((item, index) => `
        <div class="stat-card">
          <h4>${index + 1}. ${item[0]}</h4>
          <div class="stat-value" style="font-size: 20px;">${item[1].toLocaleString()} íšŒ</div>
        </div>
      `).join('');
      
      document.getElementById('topRequests').innerHTML = `
        <div class="detail-stats-grid">${topRequestsHTML || '<p style="color: #888;">UX_ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}</div>
      `;

      displayErrorPage();
    }

    // ì—ëŸ¬ í˜ì´ì§€ í‘œì‹œ
    function displayErrorPage() {
      const totalPages = Math.ceil(logAnalysisData.errors.length / ERRORS_PER_PAGE);
      const startIdx = (currentErrorPage - 1) * ERRORS_PER_PAGE;
      const endIdx = Math.min(startIdx + ERRORS_PER_PAGE, logAnalysisData.errors.length);
      
      const errorHTML = logAnalysisData.errors.slice(startIdx, endIdx).map(err => {
        const errorColor = '#ff9900';
        return `
          <div class="error-item">
            <div class="error-header">
              <span class="error-type" style="color: ${errorColor};">â—† ${err.errorType}</span>
              <span class="error-line">Line ${err.line}</span>
              ${err.timestamp ? `<span class="error-time">â± ${err.timestamp}</span>` : ''}
            </div>
            <div class="error-content">${err.content}</div>
          </div>
        `;
      }).join('');
      
      const errorWarning = logAnalysisData.totalErrorCount > logAnalysisData.errors.length
        ? `<p style="color: #ff6b9d; margin-top: 10px;">âš ï¸ ì´ ${logAnalysisData.totalErrorCount.toLocaleString()}ê°œ Exception ì¤‘ ${logAnalysisData.errors.length.toLocaleString()}ê°œê¹Œì§€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>` 
        : '';
      
      document.getElementById('errorLogs').innerHTML = (errorHTML || 
        '<p style="color: #888;">Exceptionì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>') + errorWarning;
      
      const pagination = document.getElementById('errorPagination');
      if (logAnalysisData.errors.length > ERRORS_PER_PAGE) {
        pagination.style.display = 'flex';
        document.getElementById('errorPageInfo').textContent = `${currentErrorPage} / ${totalPages}`;
        
        const prevBtn = pagination.querySelector('button:first-child');
        const nextBtn = pagination.querySelector('button:last-child');
        
        prevBtn.disabled = currentErrorPage === 1;
        nextBtn.disabled = currentErrorPage === totalPages;
      } else {
        pagination.style.display = 'none';
      }
    }

    // ì´ì „ í˜ì´ì§€
    function prevErrorPage() {
      if (currentErrorPage > 1) {
        currentErrorPage--;
        displayErrorPage();
      }
    }

    // ë‹¤ìŒ í˜ì´ì§€
    function nextErrorPage() {
      const totalPages = Math.ceil(logAnalysisData.errors.length / ERRORS_PER_PAGE);
      if (currentErrorPage < totalPages) {
        currentErrorPage++;
        displayErrorPage();
      }
    }

    // ë¡œê·¸ ë¶„ì„ ì™„ë£Œ ì‹œ ì¢…í•©ë¶„ì„ ë²„íŠ¼ í‘œì‹œ
    window.addEventListener('message', function(e) {
      if (e.data && e.data.cmd === 'complete') {
        const detailBtn = document.getElementById('btnDetail');
        if (detailBtn) {
          detailBtn.style.display = 'block';
        }
      }
    });

    // ==================== í•™ìŠµ ê¸°ëŠ¥ API ====================
    // íì‡„ë§ ì§ì ‘ í†µì‹ 
    const OPENSEARCH_API_BASE = "http://10.10.22.81:8080";
    const DEFAULT_INDEX = "contest_pm_task";

    // ì§„í–‰ë¥  íŒì—… ìƒì„±
    function createProgressPopup(fileName, fileSizeMB) {
      const popup = document.createElement('div');
      popup.id = 'progressPopup';
      popup.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;
      
      popup.innerHTML = `
        <div style="
          background: #0a0e27;
          border: 2px solid #00ffff;
          border-radius: 10px;
          padding: 40px;
          min-width: 600px;
          box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
        ">
          <h2 style="color: #00ffff; margin-top: 0; text-align: center;">
            â—† ì „ì²´ íŒŒì¼ ë¶„ì„ ì¤‘ â—†
          </h2>
          <p style="color: #888; text-align: center; margin-bottom: 30px;">
            íŒŒì¼: ${fileName} (${fileSizeMB.toFixed(2)} MB)
          </p>
          
          <div style="margin: 20px 0;">
            <div style="
              background: #000;
              border: 1px solid #00ffff;
              border-radius: 10px;
              height: 30px;
              overflow: hidden;
              position: relative;
            ">
              <div id="progressBar" style="
                background: linear-gradient(90deg, #00ff00, #00ffff);
                height: 100%;
                width: 0%;
                transition: width 0.3s;
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
              "></div>
              <div id="progressText" style="
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: #fff;
                font-weight: bold;
                text-shadow: 0 0 5px #000;
              ">0%</div>
            </div>
          </div>
          
          <p id="progressStatus" style="
            color: #0f0;
            text-align: center;
            margin: 20px 0;
            min-height: 20px;
          ">ì¤€ë¹„ ì¤‘...</p>
          
          <div id="progressDetails" style="
            background: #000;
            border: 1px solid #00ffff;
            border-radius: 5px;
            padding: 15px;
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 20px 0;
          "></div>
          
          <div style="display: flex; justify-content: center; gap: 20px; margin-top: 30px;">
            <button id="pauseAnalysisBtn" style="
              padding: 12px 30px;
              background: linear-gradient(90deg, #ffaa00, #ff8800);
              color: #000;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 0 20px rgba(255, 170, 0, 0.5);
            ">â¸ ì¼ì‹œì •ì§€</button>
            <button id="cancelAnalysisBtn" style="
              padding: 12px 30px;
              background: linear-gradient(90deg, #ff6b6b, #ff0000);
              color: #fff;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            ">âœ• ì·¨ì†Œ</button>
          </div>
        </div>
      `;
      
      return popup;
    }

    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    function updateProgressPopup(current, total, status) {
      const percentage = Math.floor((current / total) * 100);
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressStatus = document.getElementById('progressStatus');
      const progressDetails = document.getElementById('progressDetails');
      
      if (progressBar) progressBar.style.width = percentage + '%';
      if (progressText) progressText.textContent = percentage + '%';
      if (progressStatus) progressStatus.textContent = status;
      
      // ìƒì„¸ ë¡œê·¸ ì¶”ê°€
      if (progressDetails) {
        const now = new Date().toLocaleTimeString();
        const logLine = document.createElement('div');
        logLine.textContent = `[${now}] ${status}`;
        progressDetails.appendChild(logLine);
        progressDetails.scrollTop = progressDetails.scrollHeight;
      }
    }

    // ì„ë² ë”© ìƒì„± í•¨ìˆ˜
    async function embed_query(text) {
      console.log('[embed_query] ì„ë² ë”© ìƒì„± ì‹œì‘:', text.substring(0, 50) + '...');
      
      // ìƒì„¸ ë””ë²„ê¹… ì •ë³´
      console.log('[DEBUG-EMBED] ===== Execution Context =====');
      console.log('[DEBUG-EMBED] window.location.href:', window.location.href);
      console.log('[DEBUG-EMBED] window.location.origin:', window.location.origin);
      console.log('[DEBUG-EMBED] OPENSEARCH_API_BASE:', OPENSEARCH_API_BASE);
      console.log('[DEBUG-EMBED] Target URL:', `${OPENSEARCH_API_BASE}/embed`);
      console.log('[DEBUG-EMBED] =============================');
      
      try {
        const response = await fetch(`${OPENSEARCH_API_BASE}/embed`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: text })
        });
        
        console.log('[DEBUG-EMBED] Response status:', response.status);
        console.log('[DEBUG-EMBED] Response ok:', response.ok);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('[embed_query] ì„ë² ë”© ìƒì„± ì™„ë£Œ, ë²¡í„° ê¸¸ì´:', data.embedding?.length);
        return data.embedding;
      } catch (error) {
        console.error('[embed_query] ì„ë² ë”© ìƒì„± ì‹¤íŒ¨:', error);
        console.error('[DEBUG-EMBED] Error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        alert('ì„ë² ë”© ìƒì„± ì‹¤íŒ¨: ' + error.message);
        return null;
      }
    }

    // LLM API í˜¸ì¶œ í•¨ìˆ˜
    async function call_llm_api(prompt, model, silentMode = false, customLimit = null) {
      const limit = customLimit !== null ? customLimit : 4096;
      console.log('[call_llm_api] LLM í˜¸ì¶œ ì‹œì‘, model:', model, 'silentMode:', silentMode, 'limit:', limit);
      
      // ìƒì„¸ ë””ë²„ê¹… ì •ë³´
      console.log('[DEBUG] ===== Execution Context =====');
      console.log('[DEBUG] window.location.href:', window.location.href);
      console.log('[DEBUG] window.location.origin:', window.location.origin);
      console.log('[DEBUG] window.location.protocol:', window.location.protocol);
      console.log('[DEBUG] document.location.origin:', document.location.origin);
      console.log('[DEBUG] OPENSEARCH_API_BASE:', OPENSEARCH_API_BASE);
      console.log('[DEBUG] Target URL:', `${OPENSEARCH_API_BASE}/vllm_chat`);
      console.log('[DEBUG] Request body:', JSON.stringify({ text: prompt.substring(0, 100) + '...', model: model, limit: limit }));
      console.log('[DEBUG] =============================');
      
      try {
        const response = await fetch(`${OPENSEARCH_API_BASE}/vllm_chat`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            text: prompt, 
            model: model,
            limit: limit
          })
        });
        
        console.log('[DEBUG] Response received');
        console.log('[DEBUG] Response status:', response.status);
        console.log('[DEBUG] Response statusText:', response.statusText);
        console.log('[DEBUG] Response headers:', [...response.headers.entries()]);
        console.log('[DEBUG] Response ok:', response.ok);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('[call_llm_api] LLM ì‘ë‹µ ë°›ìŒ, ê¸¸ì´:', data.content?.length);
        return data.content;
      } catch (error) {
        console.error('[call_llm_api] LLM í˜¸ì¶œ ì‹¤íŒ¨:', error);
        console.error('[DEBUG] Error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        
        // silentModeê°€ falseì¼ ë•Œë§Œ alert í‘œì‹œ
        if (!silentMode) {
          alert('LLM í˜¸ì¶œ ì‹¤íŒ¨: ' + error.message);
        }
        return null;
      }
    }

    // JSON ê²°ê³¼ íŒì—… ìƒì„±
    function createJsonResultPopup(jsonResult, fileName) {
      const popup = document.createElement('div');
      popup.id = 'jsonResultPopup';
      popup.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;
      
      popup.innerHTML = `
        <div style="
          background: #0a0e27;
          border: 2px solid #00ffff;
          border-radius: 10px;
          padding: 30px;
          max-width: 90%;
          max-height: 90%;
          overflow: auto;
          box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
        ">
          <h2 style="color: #00ffff; margin-top: 0; text-align: center;">
            â—† AI ë¡œê·¸ ë¶„ì„ ê²°ê³¼ â—†
          </h2>
          <p style="color: #888; text-align: center; margin-bottom: 20px;">
            íŒŒì¼: ${fileName}
          </p>
          <pre style="
            background: #000;
            color: #0f0;
            padding: 20px;
            border-radius: 5px;
            overflow: auto;
            max-height: 50vh;
            font-size: 12px;
            border: 1px solid #00ffff;
          ">${JSON.stringify(jsonResult, null, 2)}</pre>
          <div style="display: flex; justify-content: center; gap: 20px; margin-top: 30px;">
            <button id="learnJsonBtn" style="
              padding: 12px 30px;
              background: linear-gradient(90deg, #00ff00, #00cc00);
              color: #000;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
            ">í•™ìŠµ í•˜ê¸°</button>
            <button id="closeJsonBtn" style="
              padding: 12px 30px;
              background: linear-gradient(90deg, #ff6b6b, #ff0000);
              color: #fff;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            ">ë‹«ê¸°</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(popup);
      
      // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('closeJsonBtn').addEventListener('click', () => {
        popup.remove();
      });
      
      // í•™ìŠµ í•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('learnJsonBtn').addEventListener('click', async () => {
        console.log('[learnJsonBtn] JSON í•™ìŠµ ì‹œì‘');
        
        const learnBtn = document.getElementById('learnJsonBtn');
        learnBtn.disabled = true;
        learnBtn.textContent = 'í•™ìŠµ ì¤‘...';
        
        try {
          // JSONì„ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì„ë² ë”©
          const jsonText = JSON.stringify(jsonResult, null, 2);
          const embedding = await embed_query(jsonText);
          
          if (!embedding) {
            throw new Error('ì„ë² ë”© ìƒì„± ì‹¤íŒ¨');
          }
          
          // ì¸ë±ìŠ¤ì— ì‚½ì…
          const response = await fetch(`${OPENSEARCH_API_BASE}/index`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              index: DEFAULT_INDEX,
              document: {
                text: jsonText,
                embedding: embedding,
                file_name: fileName,
                analysis_date: jsonResult.analysis_date || new Date().toISOString().split('T')[0]
              }
            })
          });
          
          const result = await response.json();
          console.log('[learnJsonBtn] í•™ìŠµ ê²°ê³¼:', result);
          
          if (result.result === 'created') {
            alert('í•™ìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\nDocument ID: ' + result.id);
            popup.remove();
          } else {
            throw new Error('í•™ìŠµ ì‹¤íŒ¨');
          }
          
        } catch (error) {
          console.error('[learnJsonBtn] í•™ìŠµ ì¤‘ ì˜¤ë¥˜:', error);
          alert('í•™ìŠµ ì‹¤íŒ¨: ' + error.message);
          learnBtn.disabled = false;
          learnBtn.textContent = 'í•™ìŠµ í•˜ê¸°';
        }
      });
    }

    // 1. ì¸ë±ìŠ¤ ìƒì„± (contest_pm_task)
    document.addEventListener('DOMContentLoaded', function() {
      const btn1 = document.getElementById('btn_learn_1');
      if (btn1) {
        btn1.addEventListener('click', async function() {
          console.log('[btn_learn_1] ì¸ë±ìŠ¤ ìƒì„± ë²„íŠ¼ í´ë¦­');
          
          const indexName = DEFAULT_INDEX;
          
          if (!confirm(`ì¸ë±ìŠ¤ "${indexName}"ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            console.log('[btn_learn_1] ì¸ë±ìŠ¤ ìƒì„± ì·¨ì†Œë¨');
            return;
          }
          
          console.log('[btn_learn_1] ì¸ë±ìŠ¤ ìƒì„± ìš”ì²­:', indexName);
          
          try {
            const response = await fetch(`${OPENSEARCH_API_BASE}/index_create`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                index: indexName, 
                body: {} 
              })
            });
            
            const result = await response.json();
            console.log('[btn_learn_1] ì¸ë±ìŠ¤ ìƒì„± ì‘ë‹µ:', result);
            
            alert(result.message || 'ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ: ' + indexName);
          } catch (error) {
            console.error('[btn_learn_1] ì¸ë±ìŠ¤ ìƒì„± ì‹¤íŒ¨:', error);
            alert('ì¸ë±ìŠ¤ ìƒì„± ì‹¤íŒ¨: ' + error.message);
          }
        });
      }
      
      // 2. AI ë¡œê·¸ ë¶„ì„ í›„ í•™ìŠµ
      const btn2 = document.getElementById('btn_learn_2');
      if (btn2) {
        btn2.addEventListener('click', async function() {
          console.log('[btn_learn_2] AI ë¡œê·¸ ë¶„ì„ ë²„íŠ¼ í´ë¦­');
          
          // íŒŒì¼ ì—…ë¡œë“œ input ìƒì„±
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = '.txt,.log';
          
          fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            console.log('[btn_learn_2] íŒŒì¼ ì„ íƒë¨:', file.name, 'í¬ê¸°:', file.size, 'bytes');
            
            // ë¶„ì„ ëª¨ë“œ ì„ íƒ
            const fileSizeMB = file.size / (1024 * 1024);
            let useChunkAnalysis = false;
            
            if (fileSizeMB > 9) {
              const choice = confirm(
                `íŒŒì¼ í¬ê¸°: ${fileSizeMB.toFixed(2)} MB\n\n` +
                `ì „ì²´ íŒŒì¼ ë¶„ì„ ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                `[í™•ì¸] ì „ì²´ ë¶„ì„ (${Math.ceil(fileSizeMB / 9)}ê°œ ì²­í¬, ì•½ ${Math.ceil(fileSizeMB / 9 * 0.3)}ë¶„ ì†Œìš”)\n` +
                `[ì·¨ì†Œ] ìƒ˜í”Œë§ ë¶„ì„ (ë¹ ë¦„, ì•½ 1ë¶„ ì†Œìš”)`
              );
              useChunkAnalysis = choice;
            }
            
            try {
              const analysisDate = new Date().toISOString().split('T')[0];
              
              if (useChunkAnalysis) {
                // ========== ì²­í¬ ê¸°ë°˜ ì „ì²´ ë¶„ì„ ==========
                console.log('[btn_learn_2] ì²­í¬ ê¸°ë°˜ ì „ì²´ ë¶„ì„ ì‹œì‘');
                
                // ì§„í–‰ë¥  íŒì—… ìƒì„±
                const progressPopup = createProgressPopup(file.name, fileSizeMB);
                document.body.appendChild(progressPopup);
                
                const CHUNK_SIZE = 9 * 1024 * 1024; // 9MB (API ì œí•œ 10MB ë¯¸ë§Œ)
                const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
                console.log('[btn_learn_2] ì´ ì²­í¬ ìˆ˜:', totalChunks);
                
                let isPaused = false;
                let isCancelled = false;
                const chunkStats = [];
                
                // ì¼ì‹œì •ì§€ ë²„íŠ¼
                document.getElementById('pauseAnalysisBtn').addEventListener('click', () => {
                  isPaused = !isPaused;
                  const btn = document.getElementById('pauseAnalysisBtn');
                  btn.textContent = isPaused ? 'â–¶ ì¬ê°œ' : 'â¸ ì¼ì‹œì •ì§€';
                  console.log('[btn_learn_2] ë¶„ì„', isPaused ? 'ì¼ì‹œì •ì§€' : 'ì¬ê°œ');
                });
                
                // ì·¨ì†Œ ë²„íŠ¼
                document.getElementById('cancelAnalysisBtn').addEventListener('click', () => {
                  if (confirm('ì •ë§ ë¶„ì„ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    isCancelled = true;
                    console.log('[btn_learn_2] ë¶„ì„ ì·¨ì†Œë¨');
                  }
                });
                
                // ê° ì²­í¬ ë¶„ì„
                for (let i = 0; i < totalChunks; i++) {
                  // ì¼ì‹œì •ì§€ ëŒ€ê¸°
                  while (isPaused && !isCancelled) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                  }
                  
                  // ì·¨ì†Œ í™•ì¸
                  if (isCancelled) {
                    progressPopup.remove();
                    alert('ë¶„ì„ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return;
                  }
                  
                  const start = i * CHUNK_SIZE;
                  const end = Math.min(start + CHUNK_SIZE, file.size);
                  const chunk = file.slice(start, end);
                  
                  console.log(`[btn_learn_2] ì²­í¬ ${i+1}/${totalChunks} ì½ê¸° ì‹œì‘ (${start}-${end})`);
                  
                  // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                  updateProgressPopup(i + 1, totalChunks, 'ì²­í¬ ì½ëŠ” ì¤‘...');
                  
                  const chunkText = await chunk.text();
                  
                  // ì§„í–‰ ìƒí™© ë¡œê·¸ ì¶”ê°€
                  const detailsDiv = document.getElementById('progressDetails');
                  if (detailsDiv) {
                    const time = new Date().toLocaleTimeString();
                    detailsDiv.innerHTML += `[${time}] ì²­í¬ ${i+1}/${totalChunks} ì½ê¸° ì™„ë£Œ (${(chunkText.length / 1024).toFixed(1)} KB)<br>`;
                    detailsDiv.scrollTop = detailsDiv.scrollHeight;
                  }
                  
                  // ì²­í¬ë³„ í†µê³„ ì¶”ì¶œ í”„ë¡¬í”„íŠ¸ (API ì œí•œì„ ê³ ë ¤í•œ í¬ê¸°)
                  // í”„ë¡¬í”„íŠ¸ ìì²´ + ë¡œê·¸ ë°ì´í„°ê°€ 9MB ì´í•˜ì—¬ì•¼ í•¨
                  const maxLogSize = 8 * 1024 * 1024; // 8MB (í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ ì—¬ìœ  ê³µê°„ í™•ë³´)
                  const safeChunkText = chunkText.length > maxLogSize ? chunkText.substring(0, maxLogSize) : chunkText;
                  
                  const chunkPrompt = `ë‹¤ìŒ ë¡œê·¸ ë°ì´í„°ì—ì„œ í†µê³„ë¥¼ ì¶”ì¶œí•˜ì„¸ìš”. ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”.

ë¡œê·¸ ë°ì´í„°:
${safeChunkText}

ì¶”ì¶œí•  í†µê³„ (JSON í˜•ì‹):
{
  "chunk_number": ${i+1},
  "total_requests": 0,
  "bizrequest_services": {},
  "hourly_usage": {},
  "users": {},
  "devices": {},
  "locations": {},
  "errors": []
}

ì„¤ëª…:
- total_requests: _BIZREQUESTê°€ í¬í•¨ëœ ë¼ì¸ ìˆ˜
- bizrequest_services: {ì„œë¹„ìŠ¤ëª…: íšŸìˆ˜} í˜•íƒœ
- hourly_usage: {ì‹œê°„ëŒ€: íšŸìˆ˜} í˜•íƒœ (00~23ì‹œ)
- users: {ì‚¬ìš©ìëª…: íšŸìˆ˜} í˜•íƒœ (PUM_USER_NAME)
- devices: {ê¸°ê¸°ëª¨ë¸: íšŸìˆ˜} í˜•íƒœ (DEV_MODEL)
- locations: {ì§€ì—­ì½”ë“œ: íšŸìˆ˜} í˜•íƒœ (PNM_LOCATION_CD)
- errors: [ì—ëŸ¬ë©”ì‹œì§€ë“¤] í˜•íƒœ (ERROR, Exception í¬í•¨)

JSONë§Œ ë‹µë³€í•˜ì„¸ìš”.`;
                  
                  updateProgressPopup(i + 1, totalChunks, `ì²­í¬ ${i+1} ë¶„ì„ ì¤‘...`);
                  
                  try {
                    // ì§„í–‰ ë¡œê·¸
                    if (detailsDiv) {
                      const time = new Date().toLocaleTimeString();
                      detailsDiv.innerHTML += `[${time}] ì²­í¬ ${i+1} AI ë¶„ì„ ìš”ì²­ ì¤‘...<br>`;
                      detailsDiv.scrollTop = detailsDiv.scrollHeight;
                    }
                    
                    const chunkResponse = await call_llm_api(chunkPrompt, 'qwen', true); // silentMode = true (ì—ëŸ¬ ì•Œë¦¼ ë¬´ì‹œ)
                    
                    if (chunkResponse) {
                      // JSON íŒŒì‹±
                      let chunkStat;
                      try {
                        const jsonMatch = chunkResponse.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                          chunkStat = JSON.parse(jsonMatch[0]);
                        } else {
                          chunkStat = JSON.parse(chunkResponse);
                        }
                        chunkStats.push(chunkStat);
                        console.log(`[btn_learn_2] ì²­í¬ ${i+1} ë¶„ì„ ì™„ë£Œ:`, chunkStat);
                        
                        // ì„±ê³µ ë¡œê·¸
                        if (detailsDiv) {
                          const time = new Date().toLocaleTimeString();
                          detailsDiv.innerHTML += `[${time}] âœ… ì²­í¬ ${i+1} ë¶„ì„ ì™„ë£Œ (ì´ ${chunkStats.length}ê°œ ì™„ë£Œ)<br>`;
                          detailsDiv.scrollTop = detailsDiv.scrollHeight;
                        }
                      } catch (parseError) {
                        console.error(`[btn_learn_2] ì²­í¬ ${i+1} JSON íŒŒì‹± ì‹¤íŒ¨:`, parseError);
                        chunkStats.push({ chunk_number: i+1, error: 'JSON íŒŒì‹± ì‹¤íŒ¨', raw: chunkResponse.substring(0, 500) });
                        
                        // íŒŒì‹± ì‹¤íŒ¨ ë¡œê·¸
                        if (detailsDiv) {
                          const time = new Date().toLocaleTimeString();
                          detailsDiv.innerHTML += `[${time}] âš ï¸ ì²­í¬ ${i+1} JSON íŒŒì‹± ì‹¤íŒ¨, ì›ë³¸ ì €ì¥<br>`;
                          detailsDiv.scrollTop = detailsDiv.scrollHeight;
                        }
                      }
                    } else {
                      // ì‘ë‹µì´ nullì¸ ê²½ìš° (500 ì—ëŸ¬, fetch ì‹¤íŒ¨ ë“±)
                      console.warn(`[btn_learn_2] ì²­í¬ ${i+1} ì‘ë‹µ ì—†ìŒ, ê±´ë„ˆëœ€`);
                      chunkStats.push({ chunk_number: i+1, error: 'API í˜¸ì¶œ ì‹¤íŒ¨ (ë¬´ì‹œë¨)', skipped: true });
                      
                      // ê±´ë„ˆë›°ê¸° ë¡œê·¸
                      if (detailsDiv) {
                        const time = new Date().toLocaleTimeString();
                        detailsDiv.innerHTML += `[${time}] â­ï¸ ì²­í¬ ${i+1} ê±´ë„ˆëœ€ (API ì˜¤ë¥˜, ê³„ì† ì§„í–‰)<br>`;
                        detailsDiv.scrollTop = detailsDiv.scrollHeight;
                      }
                    }
                  } catch (error) {
                    // try-catchë¡œ ì¡íŒ ì˜ˆì™¸ë„ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
                    console.warn(`[btn_learn_2] ì²­í¬ ${i+1} ì˜ˆì™¸ ë°œìƒ, ë¬´ì‹œí•˜ê³  ê³„ì†:`, error);
                    chunkStats.push({ chunk_number: i+1, error: error.message, skipped: true });
                    
                    // ê±´ë„ˆë›°ê¸° ë¡œê·¸ (ê²½ê³  ìˆ˜ì¤€)
                    if (detailsDiv) {
                      const time = new Date().toLocaleTimeString();
                      detailsDiv.innerHTML += `[${time}] â­ï¸ ì²­í¬ ${i+1} ê±´ë„ˆëœ€ (${error.message})<br>`;
                      detailsDiv.scrollTop = detailsDiv.scrollHeight;
                    }
                  }
                  
                  updateProgressPopup(i + 1, totalChunks, `ì²­í¬ ${i+1}/${totalChunks} ì™„ë£Œ`);
                }
                
                // ìµœì¢… ì¢…í•© ë¶„ì„
                console.log('[btn_learn_2] ëª¨ë“  ì²­í¬ ë¶„ì„ ì™„ë£Œ, ìµœì¢… ì¢…í•© ì‹œì‘');
                updateProgressPopup(totalChunks, totalChunks, 'ìµœì¢… ì¢…í•© ë¶„ì„ ì¤‘...');
                
                // ìµœì¢… ë¶„ì„ ì‹œì‘ ë¡œê·¸
                const detailsDiv = document.getElementById('progressDetails');
                if (detailsDiv) {
                  const time = new Date().toLocaleTimeString();
                  detailsDiv.innerHTML += `<br>[${time}] ğŸ“Š ëª¨ë“  ì²­í¬ ë¶„ì„ ì™„ë£Œ! (${chunkStats.length}/${totalChunks})<br>`;
                  detailsDiv.innerHTML += `[${time}] ğŸ”„ ìµœì¢… ì¢…í•© ë¶„ì„ ì‹œì‘ (ì•½ 1~2ë¶„ ì†Œìš”)...<br>`;
                  detailsDiv.scrollTop = detailsDiv.scrollHeight;
                }
                
                const finalPrompt = `ë‹¤ìŒì€ ${totalChunks}ê°œ ì²­í¬ì˜ í†µê³„ ë°ì´í„°ì…ë‹ˆë‹¤. ì´ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.

ì²­í¬ í†µê³„:
${JSON.stringify(chunkStats, null, 2).substring(0, 8000000)}

ìµœì¢… ë¶„ì„ JSON í˜•ì‹:
{
  "analysis_date": "${analysisDate}",
  "log_file": "${file.name}",
  "total_file_size_mb": ${fileSizeMB.toFixed(2)},
  "total_chunks_analyzed": ${totalChunks},
  "analysis_request": {
    "ë¡œê·¸ ë¶„ì„ ì¸ì‚¬ì´íŠ¸": {
      "ì‚¬ìš©ì í–‰ë™ íŒ¨í„´ ë¶„ì„": {
        "ì£¼ìš” ì‚¬ìš© ì„œë¹„ìŠ¤": "ëª¨ë“  ì²­í¬ì˜ bizrequest_servicesë¥¼ í•©ì‚°í•˜ì—¬ ìƒìœ„ 5ê°œ ì„œë¹„ìŠ¤ì™€ ìš”ì²­ ê±´ìˆ˜",
        "ì‹œê°„ëŒ€ë³„ ì‚¬ìš©ëŸ‰": "ëª¨ë“  ì²­í¬ì˜ hourly_usageë¥¼ í•©ì‚°í•˜ì—¬ ì‹œê°„ëŒ€ë³„ ë¶„í¬",
        "ì‚¬ìš©ìë³„ ì„œë¹„ìŠ¤ ì´ìš© í˜„í™©": "ëª¨ë“  ì²­í¬ì˜ usersë¥¼ í•©ì‚°í•˜ì—¬ ìƒìœ„ 3ëª…",
        "ê¸°ê¸° ì •ë³´": "ëª¨ë“  ì²­í¬ì˜ devicesë¥¼ í•©ì‚°í•˜ì—¬ ìƒìœ„ 3ê°œ ê¸°ê¸°"
      },
      "ì„œë¹„ìŠ¤ ì‚¬ìš© í˜„í™© ë¶„ì„": {
        "ì´ ìš”ì²­ ê±´ìˆ˜": "ëª¨ë“  ì²­í¬ì˜ total_requests í•©ê³„",
        "ìœ„ì¹˜ ê¸°ë°˜ ì„œë¹„ìŠ¤ ë¶„ì„": "ëª¨ë“  ì²­í¬ì˜ locationsë¥¼ í•©ì‚°í•˜ì—¬ ìƒìœ„ 3ê°œ ì§€ì—­",
        "ì¼ì¼ í†µê³„": "ì „ì²´ ìš”ì²­ ìˆ˜ì™€ ì£¼ìš” ì„œë¹„ìŠ¤ ìš”ì•½"
      },
      "ì‹œìŠ¤í…œ ì„±ëŠ¥ ë° ì˜¤ë¥˜ ë¶„ì„": {
        "ì˜¤ë¥˜ ë°œìƒ í˜„í™©": "ëª¨ë“  ì²­í¬ì˜ errorsë¥¼ ì¢…í•©í•˜ì—¬ ì˜¤ë¥˜ ì¢…ë¥˜ì™€ ë¹ˆë„"
      }
    }
  }
}

ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”.`;
                
                // ë” ê¸´ ì‘ë‹µì„ ë°›ê¸° ìœ„í•´ limit ì¦ê°€ (4096 -> 16384)
                const finalResponse = await call_llm_api(finalPrompt, 'qwen', false, 16384);
                
                if (!finalResponse) {
                  progressPopup.remove();
                  throw new Error('ìµœì¢… ì¢…í•© ë¶„ì„ ì‹¤íŒ¨');
                }
                
                console.log('[btn_learn_2] ìµœì¢… LLM ì‘ë‹µ:', finalResponse);
                
                // ìµœì¢… ë¶„ì„ ì™„ë£Œ ë¡œê·¸
                if (detailsDiv) {
                  const time = new Date().toLocaleTimeString();
                  detailsDiv.innerHTML += `[${time}] âœ… ìµœì¢… ì¢…í•© ë¶„ì„ ì™„ë£Œ!<br>`;
                  detailsDiv.innerHTML += `[${time}] ğŸ“ ê²°ê³¼ íŒŒì‹± ì¤‘...<br>`;
                  detailsDiv.scrollTop = detailsDiv.scrollHeight;
                }
                
                // ì ì‹œ ëŒ€ê¸° í›„ íŒì—… ë‹«ê¸°
                await new Promise(resolve => setTimeout(resolve, 1000));
                progressPopup.remove();
                
                // JSON íŒŒì‹±
                let jsonResult;
                try {
                  const jsonMatch = finalResponse.match(/\{[\s\S]*\}/);
                  if (jsonMatch) {
                    jsonResult = JSON.parse(jsonMatch[0]);
                  } else {
                    jsonResult = JSON.parse(finalResponse);
                  }
                } catch (parseError) {
                  console.error('[btn_learn_2] ìµœì¢… JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
                  jsonResult = {
                    analysis_date: analysisDate,
                    log_file: file.name,
                    raw_response: finalResponse,
                    chunk_stats: chunkStats
                  };
                }
                
                // ê²°ê³¼ íŒì—… í‘œì‹œ
                createJsonResultPopup(jsonResult, file.name);
                
              } else {
                // ========== ê¸°ì¡´ ìƒ˜í”Œë§ ë¶„ì„ ==========
                console.log('[btn_learn_2] ìƒ˜í”Œë§ ë¶„ì„ ì‹œì‘');
                
                const SAMPLE_SIZE = 100 * 1024; // 100KB
                let logSample = '';
                
                if (file.size > SAMPLE_SIZE) {
                  const blob = file.slice(0, SAMPLE_SIZE);
                  logSample = await blob.text();
                  console.log('[btn_learn_2] ìƒ˜í”Œ í¬ê¸°:', logSample.length, 'bytes');
                } else {
                  logSample = await file.text();
                  console.log('[btn_learn_2] ì „ì²´ íŒŒì¼ ì½ê¸° ì™„ë£Œ:', logSample.length, 'bytes');
                }
                
                const logForAnalysis = logSample.substring(0, 50000);
                
                const prompt = `ë¡œê·¸ ë°ì´í„°ë¥¼ ìì„¸íˆ ë¶„ì„í•œ í›„ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.

ë¡œê·¸ ë°ì´í„° (ìƒ˜í”Œ):
${logForAnalysis}

ìš”ì²­í•˜ëŠ” JSON í˜•ì‹:
{
  "analysis_date": "${analysisDate}",
  "log_file": "${file.name}",
  "analysis_request": {
    "ë¡œê·¸ ë¶„ì„ ì¸ì‚¬ì´íŠ¸": {
      "ì‚¬ìš©ì í–‰ë™ íŒ¨í„´ ë¶„ì„": {
        "ì£¼ìš” ì‚¬ìš© ì„œë¹„ìŠ¤": "ë¡œê·¸ì—ì„œ '_BIZREQUEST' í•„ë“œë¥¼ ë¶„ì„í•˜ì—¬ ê°€ì¥ ë§ì´ ì‚¬ìš©ëœ ì„œë¹„ìŠ¤ ìƒìœ„ 5ê°œë¥¼ ì‹ë³„í•˜ê³ , ê° ì„œë¹„ìŠ¤ì˜ ìš”ì²­ ê±´ìˆ˜ë¥¼ í¬í•¨í•˜ì—¬ ê²°ê³¼ë¥¼ ì œì‹œí•´ì¤˜.",
        "ì‹œê°„ëŒ€ë³„ ì‚¬ìš©ëŸ‰": "ë¡œê·¸ ìƒì„± ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ ì‹œê°„ëŒ€ë³„(00ì‹œ, 01ì‹œ, ..., 23ì‹œ) ì„œë¹„ìŠ¤ ìš”ì²­ ê±´ìˆ˜ë¥¼ ë¶„ì„í•˜ê³ , ì‚¬ìš©ëŸ‰ì´ ê°€ì¥ ë§ì€ ì‹œê°„ëŒ€ì™€ ê°€ì¥ ì ì€ ì‹œê°„ëŒ€ë¥¼ ì•Œë ¤ì¤˜.",
        "ì‚¬ìš©ìë³„ ì„œë¹„ìŠ¤ ì´ìš© í˜„í™©": "'PUM_USER_NAME' í•„ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê°€ì¥ ìš”ì²­ì´ ë§ì•˜ë˜ ì‚¬ìš©ì ìƒìœ„ 3ëª…ì„ ì‹ë³„í•˜ê³ , ê° ì‚¬ìš©ìì˜ ì´ ìš”ì²­ ê±´ìˆ˜ë¥¼ ì•Œë ¤ì¤˜.",
        "ê¸°ê¸° ì •ë³´": "'DEV_MODEL'ê³¼ 'DEV_TELECOM' í•„ë“œë¥¼ ë¶„ì„í•˜ì—¬ ê°€ì¥ ë§ì´ ì‚¬ìš©ëœ ê¸°ê¸° ëª¨ë¸ ìƒìœ„ 3ê°œì™€ í†µì‹ ì‚¬ë³„ ì ìœ ìœ¨ì„ ë¶„ì„í•´ì¤˜."
      },
      "ì„œë¹„ìŠ¤ ì‚¬ìš© í˜„í™© ë¶„ì„": {
        "ìš”ì²­ ê±´ìˆ˜ ë° ì¢…ë¥˜": "ë¡œê·¸ íŒŒì¼ ì „ì²´ì˜ ì´ ìš”ì²­ ê±´ìˆ˜ë¥¼ ê³„ì‚°í•˜ê³ , ì„œë¹„ìŠ¤ ì¢…ë¥˜ë³„ ìš”ì²­ ê±´ìˆ˜ì™€ ë¹„ìœ¨ì„ ë¶„ì„í•´ì¤˜.",
        "ìœ„ì¹˜ ê¸°ë°˜ ì„œë¹„ìŠ¤ ë¶„ì„": "'PNM_LOCATION_CD' í•„ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§€ì—­ ì½”ë“œë³„ ìš”ì²­ ê±´ìˆ˜ë¥¼ ë¶„ì„í•˜ê³ , ê°€ì¥ ìš”ì²­ì´ ë§ì•˜ë˜ ìƒìœ„ 3ê°œ ì§€ì—­ì„ ì•Œë ¤ì¤˜.",
        "ì›”ë³„/ì¼ë³„ í†µê³„": "ì´ ë¡œê·¸ëŠ” '${analysisDate}'ì— í•´ë‹¹í•˜ëŠ” ì¼ì¼ í†µê³„ì„ì„ ëª…ì‹œí•˜ê³ , ì£¼ìš” í†µê³„(ì´ ìš”ì²­ ìˆ˜, ìƒìœ„ ì„œë¹„ìŠ¤)ë¥¼ ìš”ì•½í•´ì¤˜."
      },
      "ì‹œìŠ¤í…œ ì„±ëŠ¥ ë° ì˜¤ë¥˜ ë¶„ì„": {
        "ì‘ë‹µ ì‹œê°„": "ë¡œê·¸ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ë¶„ì„í•˜ì—¬ í‰ê·  ì‘ë‹µ ì‹œê°„ì„ ì¶”ì •í•˜ê³ , ì‘ë‹µ ì‹œê°„ì´ ìœ ë… ê¸¸ì—ˆë˜(ì˜ˆ: 5ì´ˆ ì´ìƒ) ìš”ì²­ì´ ìˆì—ˆëŠ”ì§€ ì‹ë³„í•´ì¤˜.",
        "ì˜¤ë¥˜ ë°œìƒ í˜„í™©": "ë¡œê·¸ ë‚´ìš©ì—ì„œ 'ERROR' ë˜ëŠ” 'Exception' í‚¤ì›Œë“œë¥¼ í¬í•¨í•œ ë¡œê·¸ë¥¼ ì°¾ì•„ë‚´ê³ , ë°œìƒí•œ ì˜¤ë¥˜ì˜ ì¢…ë¥˜ì™€ ë¹ˆë„ë¥¼ ìš”ì•½í•´ì¤˜."
      }
    }
  }
}

ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”.`;

              console.log('[btn_learn_2] LLM API í˜¸ì¶œ ì‹œì‘...');
              alert('AIê°€ ë¡œê·¸ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...\nì‹œê°„ì´ ë‹¤ì†Œ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              
              // LLM API í˜¸ì¶œ
              const llmResponse = await call_llm_api(prompt, 'qwen');
              
              if (!llmResponse) {
                throw new Error('LLM ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
              }
              
              console.log('[btn_learn_2] LLM ì‘ë‹µ:', llmResponse);
              
              // JSON íŒŒì‹± ì‹œë„
              let jsonResult;
              try {
                // JSON ë¶€ë¶„ë§Œ ì¶”ì¶œ (``` ì œê±°)
                let jsonText = llmResponse;
                const jsonMatch = llmResponse.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  jsonText = jsonMatch[0];
                }
                jsonResult = JSON.parse(jsonText);
              } catch (parseError) {
                console.error('[btn_learn_2] JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
                // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ì‘ë‹µì„ JSONìœ¼ë¡œ ê°ì‹¸ê¸°
                jsonResult = {
                  analysis_date: analysisDate,
                  log_file: file.name,
                  raw_response: llmResponse
                };
              }
              
              // JSON ê²°ê³¼ íŒì—… í‘œì‹œ
              createJsonResultPopup(jsonResult, file.name);
              }
              
            } catch (error) {
              console.error('[btn_learn_2] AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
              alert('AI ë¶„ì„ ì‹¤íŒ¨: ' + error.message);
            }
          });
          
          fileInput.click();
        });
      }
      
      // 3. ë¡œê·¸ ë°ì´í„° ì‚½ì…
      const btn3 = document.getElementById('btn_learn_3');
      if (btn3) {
        btn3.addEventListener('click', async function() {
          console.log('[btn_learn_3] ë°ì´í„° ì‚½ì… ë²„íŠ¼ í´ë¦­');
          
          if (!mainModel.logfile) {
            alert('ë¨¼ì € ë¡œê·¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”!');
            console.log('[btn_learn_3] ë¡œê·¸ íŒŒì¼ ì—†ìŒ');
            return;
          }
          
          const indexName = prompt('ë°ì´í„°ë¥¼ ì‚½ì…í•  ì¸ë±ìŠ¤ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', 'contest_pm_task');
          if (!indexName) {
            console.log('[btn_learn_3] ë°ì´í„° ì‚½ì… ì·¨ì†Œë¨');
            return;
          }
          
          console.log('[btn_learn_3] ë¡œê·¸ íŒŒì¼ ì½ê¸° ì‹œì‘:', mainModel.logfile.name);
          
          try {
            // ë¡œê·¸ íŒŒì¼ ì½ê¸°
            const logText = await mainModel.logfile.text();
            console.log('[btn_learn_3] ë¡œê·¸ íŒŒì¼ í¬ê¸°:', logText.length, 'bytes');
            
            // ì²­í¬ í¬ê¸° ì„¤ì • (1000ì ë‹¨ìœ„ë¡œ ë¶„í• )
            const CHUNK_SIZE = 1000;
            const chunks = [];
            
            for (let i = 0; i < logText.length; i += CHUNK_SIZE) {
              chunks.push(logText.substring(i, i + CHUNK_SIZE));
            }
            
            console.log('[btn_learn_3] ì´ ì²­í¬ ìˆ˜:', chunks.length);
            
            if (!confirm(`ì´ ${chunks.length}ê°œì˜ ì²­í¬ë¡œ ë¶„í• ë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
              console.log('[btn_learn_3] ì‚¬ìš©ì ì·¨ì†Œ');
              return;
            }
            
            // ê° ì²­í¬ë¥¼ ì¸ë±ìŠ¤ì— ì‚½ì…
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < chunks.length; i++) {
              const chunk = chunks[i];
              console.log(`[btn_learn_3] ì²­í¬ ${i+1}/${chunks.length} ì²˜ë¦¬ ì¤‘...`);
              
              // ì„ë² ë”© ìƒì„±
              const embedding = await embed_query(chunk);
              
              if (!embedding) {
                console.error(`[btn_learn_3] ì²­í¬ ${i+1} ì„ë² ë”© ì‹¤íŒ¨`);
                failCount++;
                continue;
              }
              
              // ë°ì´í„° ì‚½ì…
              const response = await fetch(`${OPENSEARCH_API_BASE}/index`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  index: indexName,
                  document: {
                    text: chunk,
                    embedding: embedding
                  }
                })
              });
              
              const result = await response.json();
              console.log(`[btn_learn_3] ì²­í¬ ${i+1} ì‚½ì… ê²°ê³¼:`, result);
              
              if (result.result === 'created') {
                successCount++;
              } else {
                failCount++;
              }
              
              // ì§„í–‰ë¥  í‘œì‹œ (10ê°œë§ˆë‹¤)
              if ((i + 1) % 10 === 0) {
                console.log(`[btn_learn_3] ì§„í–‰ë¥ : ${i+1}/${chunks.length}`);
              }
            }
            
            console.log('[btn_learn_3] ë°ì´í„° ì‚½ì… ì™„ë£Œ');
            console.log('[btn_learn_3] ì„±ê³µ:', successCount, 'ì‹¤íŒ¨:', failCount);
            alert(`ë°ì´í„° ì‚½ì… ì™„ë£Œ!\nì„±ê³µ: ${successCount}ê°œ\nì‹¤íŒ¨: ${failCount}ê°œ`);
            
          } catch (error) {
            console.error('[btn_learn_3] ë°ì´í„° ì‚½ì… ì¤‘ ì˜¤ë¥˜:', error);
            alert('ë°ì´í„° ì‚½ì… ì‹¤íŒ¨: ' + error.message);
          }
        });
      }
      
      // 4. í•™ìŠµ ë°ì´í„° ê²€ìƒ‰ (KNN + í‚¤ì›Œë“œ)
      const btn4 = document.getElementById('btn_learn_4');
      if (btn4) {
        btn4.addEventListener('click', async function() {
          console.log('[btn_learn_4] í•™ìŠµ ë°ì´í„° ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­');
          
          // ê²€ìƒ‰ íƒ€ì… ì„ íƒ íŒì—…
          const searchPopup = document.createElement('div');
          searchPopup.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
          `;
          
          searchPopup.innerHTML = `
            <div style="
              background: #0a0e27;
              border: 2px solid #00ffff;
              border-radius: 10px;
              padding: 30px;
              min-width: 500px;
              box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
            ">
              <h2 style="color: #00ffff; margin-top: 0; text-align: center;">
                â—† í•™ìŠµ ë°ì´í„° ê²€ìƒ‰ â—†
              </h2>
              
              <div style="margin: 20px 0;">
                <label style="color: #0f0; display: block; margin-bottom: 10px;">ê²€ìƒ‰ íƒ€ì…:</label>
                <select id="searchType" style="
                  width: 100%;
                  padding: 10px;
                  background: #000;
                  color: #0f0;
                  border: 1px solid #00ffff;
                  border-radius: 5px;
                  font-size: 14px;
                ">
                  <option value="knn">KNN ìœ ì‚¬ë„ ê²€ìƒ‰</option>
                  <option value="keyword">í‚¤ì›Œë“œ ê²€ìƒ‰</option>
                </select>
              </div>
              
              <div style="margin: 20px 0;">
                <label style="color: #0f0; display: block; margin-bottom: 10px;">ê²€ìƒ‰ì–´:</label>
                <input type="text" id="searchQuery" placeholder="ê²€ìƒ‰í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="
                  width: 100%;
                  padding: 10px;
                  background: #000;
                  color: #0f0;
                  border: 1px solid #00ffff;
                  border-radius: 5px;
                  font-size: 14px;
                  box-sizing: border-box;
                ">
              </div>
              
              <div style="margin: 20px 0;">
                <label style="color: #0f0; display: block; margin-bottom: 10px;">ê²°ê³¼ ê°œìˆ˜ (k):</label>
                <input type="number" id="searchK" value="3" min="1" max="10" style="
                  width: 100%;
                  padding: 10px;
                  background: #000;
                  color: #0f0;
                  border: 1px solid #00ffff;
                  border-radius: 5px;
                  font-size: 14px;
                  box-sizing: border-box;
                ">
              </div>
              
              <div id="searchResults" style="
                margin: 20px 0;
                padding: 15px;
                background: #000;
                color: #0f0;
                border: 1px solid #00ffff;
                border-radius: 5px;
                max-height: 300px;
                overflow: auto;
                display: none;
              "></div>
              
              <div style="display: flex; justify-content: center; gap: 20px; margin-top: 30px;">
                <button id="executeSearchBtn" style="
                  padding: 12px 30px;
                  background: linear-gradient(90deg, #00ff00, #00cc00);
                  color: #000;
                  border: none;
                  border-radius: 8px;
                  font-size: 16px;
                  font-weight: bold;
                  cursor: pointer;
                  box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
                ">ê²€ìƒ‰ ì‹¤í–‰</button>
                <button id="askLlmBtn" style="
                  padding: 12px 30px;
                  background: linear-gradient(90deg, #ffaa00, #ff8800);
                  color: #000;
                  border: none;
                  border-radius: 8px;
                  font-size: 16px;
                  font-weight: bold;
                  cursor: pointer;
                  box-shadow: 0 0 20px rgba(255, 170, 0, 0.5);
                  display: none;
                ">LLMì—ê²Œ ì§ˆë¬¸</button>
                <button id="closeSearchBtn" style="
                  padding: 12px 30px;
                  background: linear-gradient(90deg, #ff6b6b, #ff0000);
                  color: #fff;
                  border: none;
                  border-radius: 8px;
                  font-size: 16px;
                  font-weight: bold;
                  cursor: pointer;
                  box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
                ">ë‹«ê¸°</button>
              </div>
            </div>
          `;
          
          document.body.appendChild(searchPopup);
          
          let searchResultsData = [];
          
          // ê²€ìƒ‰ ì‹¤í–‰ ë²„íŠ¼
          document.getElementById('executeSearchBtn').addEventListener('click', async () => {
            const searchType = document.getElementById('searchType').value;
            const query = document.getElementById('searchQuery').value.trim();
            const k = parseInt(document.getElementById('searchK').value);
            
            if (!query) {
              alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
              return;
            }
            
            console.log('[btn_learn_4] ê²€ìƒ‰ ì‹¤í–‰:', searchType, query, k);
            
            try {
              const apiUrl = searchType === 'knn' 
                ? `${OPENSEARCH_API_BASE}/knn_search`
                : `${OPENSEARCH_API_BASE}/keyword_search`;
              
              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: query,
                  index: DEFAULT_INDEX,
                  k: k
                })
              });
              
              const data = await response.json();
              searchResultsData = data.result || [];
              
              console.log('[btn_learn_4] ê²€ìƒ‰ ê²°ê³¼:', searchResultsData);
              
              // ê²°ê³¼ í‘œì‹œ
              const resultsDiv = document.getElementById('searchResults');
              resultsDiv.style.display = 'block';
              
              if (searchResultsData.length === 0) {
                resultsDiv.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                document.getElementById('askLlmBtn').style.display = 'none';
              } else {
                resultsDiv.innerHTML = searchResultsData.map((item, idx) => `
                  <div style="margin-bottom: 15px; padding: 10px; background: #001a1a; border-left: 3px solid #00ffff;">
                    <strong style="color: #00ffff;">ê²°ê³¼ ${idx + 1}:</strong>
                    <pre style="white-space: pre-wrap; margin-top: 10px;">${item}</pre>
                  </div>
                `).join('');
                document.getElementById('askLlmBtn').style.display = 'inline-block';
              }
              
            } catch (error) {
              console.error('[btn_learn_4] ê²€ìƒ‰ ì‹¤íŒ¨:', error);
              alert('ê²€ìƒ‰ ì‹¤íŒ¨: ' + error.message);
            }
          });
          
          // LLMì—ê²Œ ì§ˆë¬¸ ë²„íŠ¼
          document.getElementById('askLlmBtn').addEventListener('click', async () => {
            const query = document.getElementById('searchQuery').value.trim();
            
            if (searchResultsData.length === 0) {
              alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤!');
              return;
            }
            
            console.log('[btn_learn_4] LLMì—ê²Œ ì§ˆë¬¸ ì‹œì‘');
            
            // API ì œí•œì„ ê³ ë ¤í•œ ì•ˆì „í•œ í”„ë¡¬í”„íŠ¸ ìƒì„± (ìµœëŒ€ 8MB)
            const maxContextSize = 8 * 1024 * 1024; // 8MB
            let combinedResults = searchResultsData.join('\n\n');
            
            if (combinedResults.length > maxContextSize) {
              console.log('[btn_learn_4] ê²€ìƒ‰ ê²°ê³¼ê°€ ë„ˆë¬´ í¼, ì˜ë¼ëƒ„:', combinedResults.length, '->', maxContextSize);
              combinedResults = combinedResults.substring(0, maxContextSize) + '\n\n... (ê²°ê³¼ê°€ ë„ˆë¬´ ê¸¸ì–´ ì¼ë¶€ë§Œ í‘œì‹œë¨)';
            }
            
            const prompt = combinedResults 
              + '\n\nìœ„ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì•„ë˜ ì§ˆë¬¸ì— ë‹µë³€í•˜ì„¸ìš”.\n\nì§ˆë¬¸: ' + query;
            
            try {
              const llmResponse = await call_llm_api(prompt, 'qwen');
              
              if (llmResponse) {
                alert('LLM ë‹µë³€:\n\n' + llmResponse);
                console.log('[btn_learn_4] LLM ë‹µë³€:', llmResponse);
              }
              
            } catch (error) {
              console.error('[btn_learn_4] LLM ì§ˆë¬¸ ì‹¤íŒ¨:', error);
              alert('LLM ì§ˆë¬¸ ì‹¤íŒ¨: ' + error.message);
            }
          });
          
          // ë‹«ê¸° ë²„íŠ¼
          document.getElementById('closeSearchBtn').addEventListener('click', () => {
            searchPopup.remove();
          });
        });
      }
      
      // 5. ì¸ë±ìŠ¤ ì‚­ì œ
      const btn5 = document.getElementById('btn_learn_5');
      if (btn5) {
        btn5.addEventListener('click', async function() {
          console.log('[btn_learn_5] ì¸ë±ìŠ¤ ì‚­ì œ ë²„íŠ¼ í´ë¦­');
          
          const indexName = prompt('ì‚­ì œí•  ì¸ë±ìŠ¤ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', DEFAULT_INDEX);
          if (!indexName) {
            console.log('[btn_learn_5] ì¸ë±ìŠ¤ ì‚­ì œ ì·¨ì†Œë¨');
            return;
          }
          
          if (!confirm(`ì •ë§ë¡œ ì¸ë±ìŠ¤ "${indexName}"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
            console.log('[btn_learn_5] ì‚¬ìš©ìê°€ ì‚­ì œ ì·¨ì†Œ');
            return;
          }
          
          console.log('[btn_learn_5] ì¸ë±ìŠ¤ ì‚­ì œ ìš”ì²­:', indexName);
          
          try {
            const response = await fetch(`${OPENSEARCH_API_BASE}/index_delete`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ index: indexName })
            });
            
            const result = await response.json();
            console.log('[btn_learn_5] ì¸ë±ìŠ¤ ì‚­ì œ ê²°ê³¼:', result);
            
            if (result.result && result.result.acknowledged) {
              alert(`ì¸ë±ìŠ¤ "${indexName}" ì‚­ì œ ì™„ë£Œ!`);
            } else {
              alert('ì¸ë±ìŠ¤ ì‚­ì œ ì™„ë£Œ');
            }
            
          } catch (error) {
            console.error('[btn_learn_5] ì¸ë±ìŠ¤ ì‚­ì œ ì‹¤íŒ¨:', error);
            alert('ì¸ë±ìŠ¤ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
          }
        });
      }
      
      // 6. ë¡œì»¬ ì „ì²˜ë¦¬ í›„ AI ìš”ì•½ (ë¹ ë¥¸ ë¶„ì„)
      const btn6 = document.getElementById('btn_learn_6');
      if (btn6) {
        btn6.addEventListener('click', async function() {
          console.log('[btn_learn_6] ë¡œì»¬ ì „ì²˜ë¦¬ ë¶„ì„ ë²„íŠ¼ í´ë¦­');
          
          // íŒŒì¼ ì—…ë¡œë“œ input ìƒì„±
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = '.txt,.log';
          
          fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const fileSizeMB = file.size / (1024 * 1024);
            console.log('[btn_learn_6] íŒŒì¼ ì„ íƒë¨:', file.name, 'í¬ê¸°:', fileSizeMB.toFixed(2), 'MB');
            
            if (!confirm(`íŒŒì¼: ${file.name}\ní¬ê¸°: ${fileSizeMB.toFixed(2)} MB\n\në¡œì»¬ ì „ì²˜ë¦¬ ë¶„ì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(JavaScriptë¡œ ì§ì ‘ í†µê³„ ê³„ì‚° í›„ AI ìš”ì•½)`)) {
              return;
            }
            
            try {
              // ì§„í–‰ë¥  íŒì—… ìƒì„±
              const progressPopup = createProgressPopup(file.name, fileSizeMB);
              document.body.appendChild(progressPopup);
              
              updateProgressPopup(0, 100, 'íŒŒì¼ ì½ê¸° ì‹œì‘...');
              
              // === 1ë‹¨ê³„: ë¡œì»¬ í†µê³„ ê³„ì‚° ===
              console.log('[btn_learn_6] 1ë‹¨ê³„: ë¡œì»¬ í†µê³„ ê³„ì‚° ì‹œì‘');
              
              const CHUNK_SIZE = 10 * 1024 * 1024; // 10MB ì²­í¬ë¡œ ì½ê¸° (ë©”ëª¨ë¦¬ íš¨ìœ¨)
              const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
              
              // íŒŒì¼ëª…ì—ì„œ ë‚ ì§œ ì¶”ì¶œ (ì˜ˆ: SystemOut_20251030.log -> 2025ë…„ 10ì›” 30ì¼)
              let logDate = null;
              let logDateFormatted = null;
              const dateMatch = file.name.match(/(\d{8})/); // YYYYMMDD í˜•ì‹ ì°¾ê¸°
              if (dateMatch) {
                const dateStr = dateMatch[1];
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                logDate = `${year}-${month}-${day}`;
                logDateFormatted = `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼`;
                console.log('[btn_learn_6] íŒŒì¼ëª…ì—ì„œ ì¶”ì¶œí•œ ë‚ ì§œ:', logDate, logDateFormatted);
              }
              
              // í†µê³„ ë°ì´í„° ì´ˆê¸°í™”
              const stats = {
                fileName: file.name,
                logDate: logDate, // YYYY-MM-DD í˜•ì‹
                logDateFormatted: logDateFormatted, // í•œêµ­ì–´ í˜•ì‹
                fileSizeMB: fileSizeMB.toFixed(2),
                totalLines: 0,
                totalRequests: 0,
                totalErrors: 0, // ì „ì²´ ì—ëŸ¬ ì¹´ìš´íŠ¸
                bizrequestServices: {},
                hourlyUsage: {},
                users: {},
                devices: {},
                locations: {},
                errors: [], // ìƒ˜í”Œ ì—ëŸ¬ (ìµœëŒ€ 100ê°œ)
                dateRange: { start: null, end: null }
              };
              
              let buffer = ''; // ì²­í¬ ê²½ê³„ ì²˜ë¦¬ìš© ë²„í¼
              
              // ê° ì²­í¬ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì½ìœ¼ë©´ì„œ í†µê³„ ê³„ì‚°
              for (let i = 0; i < totalChunks; i++) {
                const start = i * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, file.size);
                const chunk = file.slice(start, end);
                
                updateProgressPopup(
                  Math.floor((i / totalChunks) * 50), 
                  100, 
                  `í†µê³„ ê³„ì‚° ì¤‘... (${i+1}/${totalChunks} ì²­í¬)`
                );
                
                const chunkText = await chunk.text();
                const fullText = buffer + chunkText;
                
                // ë§ˆì§€ë§‰ ì¤„ì´ ë¶ˆì™„ì „í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë²„í¼ì— ì €ì¥
                const lastNewlineIndex = fullText.lastIndexOf('\n');
                const processText = lastNewlineIndex !== -1 ? fullText.substring(0, lastNewlineIndex) : fullText;
                buffer = lastNewlineIndex !== -1 ? fullText.substring(lastNewlineIndex + 1) : '';
                
                // ì¤„ ë‹¨ìœ„ë¡œ í†µê³„ ê³„ì‚°
                const lines = processText.split('\n');
                stats.totalLines += lines.length;
                
                for (const line of lines) {
                  if (!line.trim()) continue;
                  
                  // BIZREQUEST ì¹´ìš´íŠ¸
                  if (line.includes('_BIZREQUEST')) {
                    stats.totalRequests++;
                    
                    // ì„œë¹„ìŠ¤ëª… ì¶”ì¶œ (ì˜ˆ: pm.service.XXX)
                    const serviceMatch = line.match(/pm\.service\.(\w+)/);
                    if (serviceMatch) {
                      const serviceName = serviceMatch[1];
                      stats.bizrequestServices[serviceName] = (stats.bizrequestServices[serviceName] || 0) + 1;
                    }
                  }
                  
                  // ì‹œê°„ëŒ€ ì¶”ì¶œ (ì˜ˆ: 2024-01-15 14:23:45)
                  const timeMatch = line.match(/(\d{4}-\d{2}-\d{2})\s+(\d{2}):/);
                  if (timeMatch) {
                    const date = timeMatch[1];
                    const hour = timeMatch[2];
                    
                    // ë‚ ì§œ ë²”ìœ„ ì—…ë°ì´íŠ¸
                    if (!stats.dateRange.start || date < stats.dateRange.start) {
                      stats.dateRange.start = date;
                    }
                    if (!stats.dateRange.end || date > stats.dateRange.end) {
                      stats.dateRange.end = date;
                    }
                    
                    // ì‹œê°„ëŒ€ë³„ ì‚¬ìš©ëŸ‰
                    stats.hourlyUsage[hour] = (stats.hourlyUsage[hour] || 0) + 1;
                  }
                  
                  // ì‚¬ìš©ìëª… ì¶”ì¶œ (PUM_USER_NAME)
                  const userMatch = line.match(/PUM_USER_NAME[=:]\s*([^\s,\]]+)/);
                  if (userMatch) {
                    const userName = userMatch[1];
                    stats.users[userName] = (stats.users[userName] || 0) + 1;
                  }
                  
                  // ê¸°ê¸° ëª¨ë¸ ì¶”ì¶œ (DEV_MODEL)
                  const deviceMatch = line.match(/DEV_MODEL[=:]\s*([^\s,\]]+)/);
                  if (deviceMatch) {
                    const deviceModel = deviceMatch[1];
                    stats.devices[deviceModel] = (stats.devices[deviceModel] || 0) + 1;
                  }
                  
                  // ì§€ì—­ ì½”ë“œ ì¶”ì¶œ (PNM_LOCATION_CD)
                  const locationMatch = line.match(/PNM_LOCATION_CD[=:]\s*([^\s,\]]+)/);
                  if (locationMatch) {
                    const locationCode = locationMatch[1];
                    stats.locations[locationCode] = (stats.locations[locationCode] || 0) + 1;
                  }
                  
                  // ì—ëŸ¬ ì¶”ì¶œ (ERROR, Exception í¬í•¨)
                  if (line.match(/ERROR|Exception|exception|FAIL|fail/i)) {
                    stats.totalErrors++; // ì „ì²´ ì—ëŸ¬ ì¹´ìš´íŠ¸
                    
                    // ì—ëŸ¬ ìƒ˜í”Œ ì €ì¥ (ìµœëŒ€ 100ê°œ)
                    if (stats.errors.length < 100) {
                      const errorMsg = line.trim().substring(0, 200);
                      stats.errors.push(errorMsg);
                    }
                  }
                }
                
                // ì§„í–‰ ë¡œê·¸
                const detailsDiv = document.getElementById('progressDetails');
                if (detailsDiv) {
                  const time = new Date().toLocaleTimeString();
                  detailsDiv.innerHTML += `[${time}] ì²­í¬ ${i+1}/${totalChunks} ì²˜ë¦¬ ì™„ë£Œ (ëˆ„ì  ë¼ì¸: ${stats.totalLines.toLocaleString()})<br>`;
                  detailsDiv.scrollTop = detailsDiv.scrollHeight;
                }
              }
              
              // ë§ˆì§€ë§‰ ë²„í¼ ì²˜ë¦¬
              if (buffer.trim()) {
                stats.totalLines++;
              }
              
              console.log('[btn_learn_6] ë¡œì»¬ í†µê³„ ê³„ì‚° ì™„ë£Œ:', stats);
              updateProgressPopup(50, 100, 'ë¡œì»¬ í†µê³„ ê³„ì‚° ì™„ë£Œ! AI ìš”ì•½ ìš”ì²­ ì¤‘...');
              
              // ì§„í–‰ ë¡œê·¸
              const detailsDiv = document.getElementById('progressDetails');
              if (detailsDiv) {
                const time = new Date().toLocaleTimeString();
                detailsDiv.innerHTML += `<br>[${time}] âœ… ë¡œì»¬ í†µê³„ ê³„ì‚° ì™„ë£Œ!<br>`;
                detailsDiv.innerHTML += `[${time}] ğŸ“Š ì´ ${stats.totalLines.toLocaleString()} ë¼ì¸ ë¶„ì„<br>`;
                detailsDiv.innerHTML += `[${time}] ğŸ”„ AI ìš”ì•½ ìƒì„± ì‹œì‘...<br>`;
                detailsDiv.scrollTop = detailsDiv.scrollHeight;
              }
              
              // === 2ë‹¨ê³„: AI ìš”ì•½ ìƒì„± ===
              console.log('[btn_learn_6] 2ë‹¨ê³„: AI ìš”ì•½ ìƒì„± ì‹œì‘');
              
              // ìƒìœ„ Nê°œë§Œ ì¶”ì¶œ
              const topN = (obj, n) => {
                return Object.entries(obj)
                  .sort((a, b) => b[1] - a[1])
                  .slice(0, n)
                  .reduce((acc, [key, val]) => ({ ...acc, [key]: val }), {});
              };
              
              // ìš”ì•½ìš© í†µê³„ ë°ì´í„°
              const summaryStats = {
                fileName: stats.fileName,
                logDate: stats.logDate,
                logDateFormatted: stats.logDateFormatted,
                fileSizeMB: stats.fileSizeMB,
                totalLines: stats.totalLines,
                totalRequests: stats.totalRequests,
                totalErrors: stats.totalErrors, // ì „ì²´ ì—ëŸ¬ ìˆ˜
                dateRange: stats.dateRange,
                topServices: topN(stats.bizrequestServices, 10),
                hourlyUsage: stats.hourlyUsage,
                topUsers: topN(stats.users, 10),
                topDevices: topN(stats.devices, 10),
                topLocations: topN(stats.locations, 10),
                errorSamples: stats.errors.slice(0, 20) // ëŒ€í‘œ ì—ëŸ¬ 20ê°œ
              };
              
              // AI ìš”ì•½ í”„ë¡¬í”„íŠ¸
              const summaryPrompt = `ë‹¹ì‹ ì€ í•œêµ­ì–´ ë¡œê·¸ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒì€ "${stats.logDateFormatted || 'ë‚ ì§œ ë¯¸ìƒ'}" ë¡œê·¸ íŒŒì¼ì˜ í†µê³„ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤. 
ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸ì‚¬ì´íŠ¸ ìˆëŠ” ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ **ë°˜ë“œì‹œ í•œêµ­ì–´**ë¡œ JSON í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.

**ì¤‘ìš”: ëª¨ë“  ì„¤ëª…ê³¼ ë¶„ì„ ë‚´ìš©ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.**

í†µê³„ ë°ì´í„°:
${JSON.stringify(summaryStats, null, 2)}

ì•„ë˜ í˜•ì‹ìœ¼ë¡œ JSON ì‘ë‹µì„ ì‘ì„±í•˜ì„¸ìš”:
{
  "log_date": "${stats.logDate || 'ë‚ ì§œ ë¯¸ìƒ'}",
  "log_date_formatted": "${stats.logDateFormatted || 'ë‚ ì§œ ë¯¸ìƒ'}",
  "file_name": "${stats.fileName}",
  "analysis_summary": {
    "overview": "ì´ ë¡œê·¸ëŠ” ${stats.logDateFormatted || 'ë‚ ì§œ ë¯¸ìƒ'}ì˜ ë°ì´í„°ì…ë‹ˆë‹¤. ì´ ë¼ì¸ ìˆ˜, ì´ ìš”ì²­ ìˆ˜ ë“±ì„ í¬í•¨í•œ ì „ì²´ ìš”ì•½ì„ í•œêµ­ì–´ë¡œ ì‘ì„±",
    "key_insights": [
      "ì£¼ìš” ì¸ì‚¬ì´íŠ¸ 1 (í•œêµ­ì–´)",
      "ì£¼ìš” ì¸ì‚¬ì´íŠ¸ 2 (í•œêµ­ì–´)",
      "ì£¼ìš” ì¸ì‚¬ì´íŠ¸ 3 (í•œêµ­ì–´)"
    ]
  },
  "service_analysis": {
    "most_used_services": "ê°€ì¥ ë§ì´ ì‚¬ìš©ëœ ì„œë¹„ìŠ¤ ìƒìœ„ 5ê°œì™€ ì‚¬ìš©ëŸ‰ì„ í•œêµ­ì–´ë¡œ ì„¤ëª…",
    "service_distribution": "ì„œë¹„ìŠ¤ ì‚¬ìš© ë¶„í¬ì— ëŒ€í•œ í•œêµ­ì–´ ì„¤ëª…"
  },
  "temporal_analysis": {
    "peak_hours": "ìµœê³  ì‚¬ìš© ì‹œê°„ëŒ€ (ì˜ˆ: 08ì‹œ, 09ì‹œ, 10ì‹œ)ë¥¼ í•œêµ­ì–´ë¡œ ì„¤ëª…",
    "usage_pattern": "ì‹œê°„ëŒ€ë³„ ì‚¬ìš© íŒ¨í„´ì„ í•œêµ­ì–´ë¡œ ìƒì„¸ ì„¤ëª…",
    "date_range": "${stats.logDateFormatted || 'ë‚ ì§œ ë¯¸ìƒ'}ì˜ ë¡œê·¸ ë°ì´í„°"
  },
  "user_analysis": {
    "active_users": "ê°€ì¥ í™œë°œí•œ ì‚¬ìš©ì ìƒìœ„ 3ëª…ê³¼ ì‚¬ìš©ëŸ‰ì„ í•œêµ­ì–´ë¡œ ì„¤ëª…",
    "user_distribution": "ì‚¬ìš©ì ë¶„í¬ íŠ¹ì§•ì„ í•œêµ­ì–´ë¡œ ì„¤ëª…"
  },
  "device_analysis": {
    "popular_devices": "ì£¼ìš” ê¸°ê¸° ëª¨ë¸ ìƒìœ„ 3ê°œë¥¼ í•œêµ­ì–´ë¡œ ì„¤ëª…",
    "device_insight": "ê¸°ê¸° ì‚¬ìš© íŒ¨í„´ì„ í•œêµ­ì–´ë¡œ ì„¤ëª…"
  },
  "location_analysis": {
    "main_locations": "ì£¼ìš” ì§€ì—­ ì½”ë“œ ìƒìœ„ 3ê°œë¥¼ í•œêµ­ì–´ë¡œ ì„¤ëª…",
    "location_insight": "ì§€ì—­ë³„ ì‚¬ìš© íŠ¹ì§•ì„ í•œêµ­ì–´ë¡œ ì„¤ëª…"
  },
  "error_analysis": {
    "total_error_count": ${stats.totalErrors},
    "error_samples_count": "ì—ëŸ¬ ìƒ˜í”Œ ìˆ˜ (ìˆ«ì)",
    "error_patterns": "ì£¼ìš” ì—ëŸ¬ íŒ¨í„´ ë° ìœ í˜•ì„ í•œêµ­ì–´ë¡œ ì„¤ëª…",
    "recommendations": "ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­ì„ í•œêµ­ì–´ë¡œ ì„¤ëª…"
  },
  "recommendations": [
    "ê°œì„  ì œì•ˆ 1 (í•œêµ­ì–´)",
    "ê°œì„  ì œì•ˆ 2 (í•œêµ­ì–´)",
    "ê°œì„  ì œì•ˆ 3 (í•œêµ­ì–´)"
  ],
  "searchable_info": {
    "date": "${stats.logDate}",
    "date_kr": "${stats.logDateFormatted}",
    "purpose": "ì´ ì •ë³´ëŠ” '${stats.logDateFormatted}ì—ëŠ” ì–´ë–¤ ì—ëŸ¬ê°€ ìˆì—ˆì–´?' ê°™ì€ ë‚ ì§œë³„ ê²€ìƒ‰ì„ ìœ„í•œ ë©”íƒ€ë°ì´í„°ì…ë‹ˆë‹¤."
  }
}

**í•„ìˆ˜ ìš”êµ¬ì‚¬í•­:**
1. ëª¨ë“  ì„¤ëª…ê³¼ ë¶„ì„ì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±
2. ë‚ ì§œ ì •ë³´(log_date, log_date_formatted)ë¥¼ ëª…í™•íˆ í¬í•¨
3. ë¡œê·¸ ë‚´ìš© ìì²´(ì—ëŸ¬ ë©”ì‹œì§€ ë“±)ëŠ” ì›ë¬¸ ìœ ì§€
4. ë¶„ì„ê³¼ ì¸ì‚¬ì´íŠ¸ëŠ” í•œêµ­ì–´ë¡œ ìƒì„¸í•˜ê²Œ ì‘ì„±
5. ì´ ë°ì´í„°ëŠ” OpenSearchì— ì €ì¥ë˜ì–´ ë‚ ì§œë³„ ê²€ìƒ‰ì— ì‚¬ìš©ë©ë‹ˆë‹¤

ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”.`;
              
              updateProgressPopup(60, 100, 'AI ìš”ì•½ ìƒì„± ì¤‘...');
              
              // ë” ê¸´ ì‘ë‹µì„ ë°›ê¸° ìœ„í•´ limit ì¦ê°€ (4096 -> 16384)
              const aiResponse = await call_llm_api(summaryPrompt, 'qwen', false, 16384);
              
              if (!aiResponse) {
                throw new Error('AI ìš”ì•½ ìƒì„± ì‹¤íŒ¨');
              }
              
              console.log('[btn_learn_6] AI ìš”ì•½ ì™„ë£Œ');
              updateProgressPopup(100, 100, 'ë¶„ì„ ì™„ë£Œ!');
              
              if (detailsDiv) {
                const time = new Date().toLocaleTimeString();
                detailsDiv.innerHTML += `[${time}] âœ… AI ìš”ì•½ ìƒì„± ì™„ë£Œ!<br>`;
                detailsDiv.scrollTop = detailsDiv.scrollHeight;
              }
              
              // === 3ë‹¨ê³„: ê²°ê³¼ í‘œì‹œ ===
              setTimeout(() => {
                progressPopup.remove();
                
                // JSON íŒŒì‹±
                let analysisResult;
                try {
                  const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                  if (jsonMatch) {
                    analysisResult = JSON.parse(jsonMatch[0]);
                  } else {
                    analysisResult = JSON.parse(aiResponse);
                  }
                } catch (parseError) {
                  console.error('[btn_learn_6] JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
                  analysisResult = { raw_response: aiResponse };
                }
                
                // ê²°ê³¼ íŒì—… ìƒì„± (btn_learn_2ì™€ ë™ì¼í•œ í˜•ì‹)
                const combinedResult = {
                  local_statistics: summaryStats,
                  ai_analysis: analysisResult,
                  processing_info: {
                    method: 'Local preprocessing + AI summary',
                    total_chunks_processed: totalChunks,
                    processing_time: 'ì•½ 2~5ë¶„',
                    file_size_mb: fileSizeMB.toFixed(2)
                  }
                };
                
                createJsonResultPopup(combinedResult, file.name);
                
                console.log('[btn_learn_6] ì „ì²´ ë¶„ì„ ì™„ë£Œ!');
                
              }, 1000);
              
            } catch (error) {
              console.error('[btn_learn_6] ë¶„ì„ ì‹¤íŒ¨:', error);
              alert('ë¶„ì„ ì‹¤íŒ¨: ' + error.message);
              
              const popup = document.getElementById('progressPopup');
              if (popup) popup.remove();
            }
          });
          
          fileInput.click();
        });
      }
    });
  </script>
</body>
</html>
